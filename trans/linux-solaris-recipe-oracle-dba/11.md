# 十一、管理服务器软件

财富 500 强企业纷纷拥抱甲骨文和红帽企业 Linux，Linux 已经成为服务器行业的主导力量。越来越多的财富 500 强公司采用 Linux 作为公司标准。随着 Oracle 凭借其工程系统在服务器领域的出现，Linux 已经成为数据库管理员的标准。在工程系统和虚拟化基础架构的世界中，数据库管理员通常执行或分担系统管理职责。最优秀的 Real Application Cluster (RAC)数据库管理员非常了解 Linux，并且知道调优它的最佳实践。对于较大的公司，角色和职责的真正划分仍然存在。本章面向在 Linux 世界中执行软件管理角色的数据库管理员，特别是 Red Hat 和 Oracle Enterprise Linux(Oracle Linux)。

本章介绍了基本的 Red Hat Enterprise Linux 安装，并将 Red Hat 服务器注册到 Oracle 牢不可破的 Linux 网络，利用 Oracle 的 RDBMS pre install RPM for Oracle Database 11g Release 2 和 Oracle Database 12c 来预配置用于 Oracle 安装的 Linux 服务器，执行 Oracle Database 11g/12c 软件的静默安装，克隆完全修补的 Oracle 安装，执行静默数据库创建，并通过设置静默网络配置来完成服务器构建。静默模式安装是创建自动化服务器安装过程的基础。

本章演示了如何安装 RPM、从 Red Hat 网络切换到 Oracle 的 Unbreakable Linux 网络、列出 RPM 包的内容、将操作系统可执行文件与 RPM 相关联、下载 RPM、自动化 Oracle 的验证安装以及删除 RPM。

本章的数据库软件管理部分专门讨论静默安装。在从一个完整的实现学习如何设置数据库服务器的同时，您还将学习 RPM 和 YUM 包管理。

## 11-1.安装软件包

### 问题

您希望在 Linux 服务器上安装软件组件。

### 解决方案#1

到目前为止，在 Linux 服务器上管理软件最简单的方法是使用`yum`命令，如下例所示:

`# yum install screen -y`

`Loaded plugins: product-id, subscription-manager`

`This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.`

`Setting up Install Process`

`Resolving Dependencies`

`--> Running transaction check`

`---> Package screen.x86_64 0:4.0.3-16.el6 will be installed`

`--> Finished Dependency Resolution`

`Dependencies Resolved`

`=========================================================================================`

`Package             Arch      Version                      Repository              Size`

`=========================================================================================`

`Installing:`

`screen              x86_64     4.0.3-16.el6                 viscosity              494 k`

`Transaction Summary`

`=========================================================================================`

`Install       1 Package(s)`

`Total download size: 494 k`

`Installed size: 795 k`

`Downloading Packages:`

`Running rpm_check_debug`

`Running Transaction Test`

`Transaction Test Succeeded`

`Running Transaction`

`Installing : screen-4.0.3-16.el6.x86_64                                             1/1`

`Verifying  : screen-4.0.3-16.el6.x86_64                                             1/1`

`Installed:`

`screen.x86_64 0:4.0.3-16.el6`

`Complete!`

### 解决方案 2

在 Linux 服务器上管理软件的另一种方法是执行带有`-i`选项(或`--install`)的`rpm`命令来安装包。

这里有一个安装`screen`可执行文件的例子:

`# rpm -ihv screen-4.0.3-1.el5.i386.rpm`

`Preparing...                    ########################################### [100%]`

`1:screen                    ########################################### [100%]`

`-h`选项在安装过程中显示散列标记。`-v`选项提供报告安装进度的详细输出。`rpm`可执行文件可以从本地文件系统、CD 或通过 HTTP 或 FTP 可访问的远程服务器安装软件包。

### 它是如何工作的

Yellowdog Updater，Modified (YUM)是一个命令行的开源软件包管理工具，用于依赖于 RPM 软件包管理器的 Linux。YUM 是为黄狗 Linux 开发的原始 update 命令的修改版本，它严重依赖于包头。在每个程序包的标头上，正向和反向依赖信息可用于程序包的安装和回滚。有了存储库数据库中的这些信息，YUM 可以通过确定满足依赖关系所需的其他包来简化包的安装。

简而言之，RPM 是一个包管理系统。RPM 最初代表 Red Hat Package Manager，因为它是由 Red Hat 为 Red Hat 发行版设计的。因为 RPM 是为 Linux 发行版设计的，并且被许多 Linux 发行版使用，所以 RPM 现在代表 RPM 包管理器。RPM 系统由本地数据库、`rpm`可执行文件和 RPM 包文件组成。本地 RPM 数据库存储在`/var/lib/rpm`目录中，包含关于已安装软件包的元数据信息，包括软件包先决条件和文件属性。因为本地 RPM 数据库跟踪所有的包和文件属性，所以删除包成为一个相对简单的操作。

RPM 包文件由压缩的归档文件和依赖关系信息组成。包名或标签包含以下属性:

`<name>-<version>-<release>.<architecture>.rpm`

以下是包装标签的示例:

`unixODBC-2.2.11-7.1.i386.rpm`

`unixODBC` RPM 是 Oracle 数据库 11g 所需的 RPM。对于这个例子，RPM 版本是 2.2.11，RPM 的发布版本是 7.1。这种特殊的 RPM 是为 32 位英特尔 IA32 (x86) CPU 设计的。AMD64/英特尔`em64t` RPM 的架构名为`x86_64`。

包含源代码的 rpm 在`.rpm`后缀前显示`.src`。尽管您可能找不到与您的体系结构和 Linux 风格相关联的二进制 RPM，但是对于另一种类型的 Linux，可能有一个等效的源代码 RPM。您可以下载源代码并编译 RPM。

请注意，某些 RPM 在文件名中有`.noarch`扩展名，表示 RPM 不依赖于您的系统架构。

Note

从 Red Hat Enterprise Linux (RHEL) 5 和 Oracle Linux (OL) 5 开始，YUM 已经成为大多数公司在 Linux 服务器上安装软件的事实上的标准。从 RHEL 5/OL 及更高版本开始，up2date 不再是首选工具。

## 11-2.切换到 Oracle Unbreakable Linux 网络

### 问题

您安装了 RHEL 6 或 7，但希望利用 Oracle 牢不可破的 Linux 网络(ULN)。您希望从 ULN 而不是红帽网络(RHN)开始执行更新。

### 解决办法

在开始利用 ULN 之前，您必须从 [`https://linux.oracle.com/switch.html`](https://linux.oracle.com/switch.html) 下载并升级到新版本的`up2date`和`up2date-gnome`包，以适应您的 Red Hat 版本和服务器架构。此外，您必须拥有有效的 CSI 和 Oracle Linux (OL)许可证。

您可以从 [`http://linux-update.oracle.com/rpms/`](http://linux-update.oracle.com/rpms/) 网站下载这些文件。对于红帽 Linux 7 64 位架构，下载两个文件:`uln_register_ol7.tgz`和`uln_register-gnome_ol7.tgz`。对于红帽 Linux 6(32 位和 64 位架构都有)，下载两个文件:`uln_register.tgz`和`uln_register-gnome.tgz`。有关切换说明的更新，请查看 Oracle 网站上的步骤: [`https://linux.oracle.com/switch.html`](https://linux.oracle.com/switch.html) 。

#### 为旧版本安装 Oracle up2date

一旦你下载了`up2date`和`up2date-gnome`包，你就可以作为`root`用户在你的红帽系统上使用`rpm -Uhv`命令升级现有的包，如下所示:

`# rpm -Uhv up2date-5.10.1-40.8.el5.i386.rpm \`

`up2date-gnome-5.10.1-40.8.el5.i386.rpm`

`warning: up2date-5.10.1-40.8.el5.i386.rpm: Header V3 DSA signature: NOKEY, key ID`

`1e5e0159`

`Preparing...                ########################################### [100%]`

`1:up2date                ########################################### [ 50%]`

`2:up2date-gnome          ########################################### [100%]`

如果您没有安装`up2date-gnome`，您可以排除该 RPM。如果您运行的是 Red Hat Linux (RHEL) 6 之前的操作系统版本，您必须通过执行`import`选项导入 Oracle 的 GPG 密钥:

`rpm --import /usr/share/rhn/RPM-GPG-KEY`

#### 向 ULN 注册

现在你已经准备好向 ULN 注册红帽服务器了。一旦注册了 Red Hat 服务器，就可以开始使用`up2date`命令在 Linux 服务器上自动下载和安装/升级软件包。`up2date`最大的特点是所有的依赖关系都是自动解决的，不需要管理员的干预。

RPM 管理的最大挫折是处理一种被称为依赖性地狱的通俗说法。例如，假设 RPM X 依赖于 RPM A、B 和 c。RPM B 依赖于 L、M 和 N。由于没有意识到 RPM 依赖关系，当您尝试安装 RPM N 时，您会遇到另一个 RPM N 依赖关系，它需要 RPM H 和 I。您只是想安装 RPM X，但是您会遇到许多其他 RPM 要求，并且依赖关系要求相互叠加。您会遇到这样的情况,`up2date`可以极大地简化 Linux 服务器的管理。

如果您使用的是 RHEL 3、RHEL 4 或 RHEL 5，要开始注册过程，您可以执行以下命令:

`up2date --register`

您可以执行命令`up2date --register --nox`在非 GUI 模式下启动`up2date`。如果没有`--nox`选项，您的`DISPLAY`参数必须设置为有效的 X 服务器或 VNC 服务器。最初，您会看到欢迎使用 ULN 更新代理屏幕。单击前进按钮，转到 ULN 登录屏幕。因为这是您第一次登录`up2date`，您必须在屏幕上提供所有凭证，包括登录 ID、密码(两次用于验证)和授权的 CSI 号。

对于 RHEL 6 和 RHEL 7，执行`uln_register`命令从 RHN 切换到 ULN。仔细按照屏幕上的指示，并输入所需的信息。`uln_register`进程还收集机器信息并上传到 Oracle 服务器。系统应该订阅 ULN 上最新的 OL 7 频道，以在 RHEL 7 的情况下执行 YUM 更新。

### 它是如何工作的

从 RHN 转到甲骨文的 ULN 很简单。一旦您购买了 OL 许可证，您就可以开始从 Oracle Support 而不是 Red Hat 获得支持。您可以开始从单一前端获得 Oracle 技术支持对操作系统和数据库的支持。

在 ULN 成功注册红帽服务器后，您可以通过 [`https://linux.oracle.com`](https://linux.oracle.com/) 访问 ULN 门户网站。在登录和密码字段中，您可以提供您在注册 Red Hat 服务器时提供的登录和密码凭据。

无论您是在 OL 还是在 RHEL，您都可以利用 Oracle 的公共 YUM 服务器进行包管理。大家都知道，如果你在 OL 上，可以利用 Oracle 的 public YUM server for Oracle RDBMS 预装 rpm。然而，很少有人意识到，即使是 Red Hat 客户也可以利用 Oracle 的公共 YUM 服务器。要为 Oracle public YUM server 配置 Red Hat，首先要下载存储库配置文件。存储库设置在`/etc/yum.repos.d`目录中。您可以为一台 Linux 服务器设置多个 YUM 存储库。

要获得服务器的可用存储库列表，请执行带有`repolist`参数的`yum`命令:

`# yum repolist`

因为您使用的是 RHEL 6.6，所以下载适用于 OL 6 的 Oracle 公共 YUM 存储库配置文件，并将该文件放在`/etc/yum.repos.d`目录中:

`# wget`[`http://public-yum.oracle.com/public-yum-ol6.repo`T3】](http://public-yum.oracle.com/public-yum-ol6.repo)

`--2015-05-18 15:26:52--`[`http://public-yum.oracle.com/public-yum-ol6.repo`T3】](http://public-yum.oracle.com/public-yum-ol6.repo)

`Resolving public-yum.oracle.com... 67.200.133.11, 67.200.133.9`

`Connecting to public-yum.oracle.com|67.200.133.11|:80... connected.`

`HTTP request sent, awaiting response... 200 OK`

`Length: 5046 (4.9K) [text/plain]`

`Saving to: "public-yum-ol6.repo"`

`100%[==============================================================================>] 5,046       --.-K/s   in 0.002s`

`2015-05-18 15:26:52 (2.16 MB/s) - "public-yum-ol6.repo" saved [5046/5046]`

您必须使用相同的`wget`命令下载 OL GPG 密钥，并将文件放在`/etc/pki/rpm-gpg directory`中:

`wget`[`http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol6`](http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol6)T2】

如果您不下载这个 GPG 密钥，您将在任何类型的 YUM 包维护期间遇到以下错误:

`GPG key retrieval failed: [Errno 14] Could not open/read file:///etc/pki/rpm-gpg/RPM-GPG-KEY-oracle`

一旦下载了 Oracle GPG 密钥，就可以用`gpg`命令验证 GPG 密钥。公钥指纹是一个短的字节序列，用于验证一个较长的公钥。通过对公钥应用加密哈希函数来创建指纹。使用`–with-fingerprint`参数，您可以验证与 GPG 键相关的指纹:

`# gpg --quiet --with-fingerprint /etc/pki/rpm-gpg/RPM-GPG-KEY-oracle`

`pub  2048R/EC551F03 2010-07-01 Oracle OSS group (Open Source Software group) <build@oss.oracle.com>`

`Key fingerprint = 4214 4123 FECF C55B 9086  313D 72F9 7B74 EC55 1F03`

Note

向 Oracle 的 ULN 注册服务器或利用公共 YUM 服务器的另一个好处是，您可以执行`up2date`或`yum`来下载和安装与 ASM 相关的 rpm。您不必根据您的 Linux 服务器的内核级别调查必须下载哪些特定于 ASM 的 RPMs`yum`自动决定哪些包需要为你下载。

## 11-3.将 Linux 文件与 RPM 包相关联

### 问题

其中一台服务器有您需要的可执行文件，但另一台服务器没有。您希望确定要安装在服务器上的 RPM 包。

### 解决方案#1

查看带有到`pkill`可执行文件的完全限定路径的`yum provides`命令，以了解哪个 RPM 提供了可执行文件:

`$ yum provides /usr/bin/pkill`

`Loaded plugins: downloadonly`

`procps-3.2.8-21.el6.x86_64 : System and process monitoring utilities`

`Repo        : public_ol6_latest`

`Matched from:`

`Filename    : /usr/bin/pkill`

`...`

`...`

### 解决方案 2

查找`gedit`可执行文件，但是这次通过将`–qf`参数传递给`rpm`命令:

`[root@rac5 bin]# rpm -qf /usr/bin/gedit`

`gedit-2.16.0-5.el5`

`-qf`选项也适用于共享对象。如果您碰巧想知道`libc.so`文件来自哪个包，您可以发出`-qf`选项，如下所示:

`[root@rac5 lib]# rpm -qf libc.so`

`glibc-devel-2.5-18`

### 它是如何工作的

`yum`命令有`provides`选项，如果您指定了可执行文件或共享库的路径，它会返回包名。`provides`选项还接受一个通配符参数(`*`)，用于双引号括起来的路径，如下所示:

`# yum provides "*bin/gedit"`

`Loaded plugins: downloadonly`

`public_ol6_UEKR3_latest/filelists                                                                                      | 8.2 MB     00:21`

`1:gedit-2.28.4-3.el6.x86_64 : Text editor for the GNOME desktop`

`Repo        : public_ol6_latest`

`Matched from:`

`Filename    : /usr/bin/gedit`

`rpm`提供查询 RPM 数据库以提取所属包的功能。您可以将操作系统中的可执行文件或库与 RPM 相关联。您可以使用`-qf` ( `-q`代表`-query`，`-f`代表`-file`)选项来执行`rpm`,以确定哪些 rpm 与指定的文件或可执行文件相关联。

## 11-4.列出 RPM 包的内容

### 问题

您想要查看`.rpm`文件内部以查看包的内容，并查看文件将被提取到的目的地。

### 解决方案#1

`repoquery`可执行文件提供了查看包中文件的目标位置的能力。`repoquery`带有`yum-utils`转速，必须安装百胜:

`# yum install yum-utils`

一旦`yum-utils`包被安装，利用带有`–l`选项(或`–listing`选项)的`repoquery`可执行文件对着屏幕`rpm`:

`# repoquery -l screen`

`/etc/pam.d/screen`

`/etc/screenrc`

`/usr/bin/screen`

`/usr/share/doc/screen-4.0.3`

`/usr/share/doc/screen-4.0.3/COPYING`

`/usr/share/doc/screen-4.0.3/FAQ`

`/usr/share/doc/screen-4.0.3/NEWS`

`/usr/share/doc/screen-4.0.3/README`

`/usr/share/doc/screen-4.0.3/README.DOTSCREEN`

`/usr/share/info/screen.info.gz`

`/usr/share/man/man1/screen.1.gz`

`/usr/share/screen`

`/usr/share/screen/utf8encodings`

`/usr/share/screen/utf8encodings/01`

`/usr/share/screen/utf8encodings/02`

`/usr/share/screen/utf8encodings/03`

`/usr/share/screen/utf8encodings/04`

`/usr/share/screen/utf8encodings/18`

`/usr/share/screen/utf8encodings/19`

`/usr/share/screen/utf8encodings/a1`

`/usr/share/screen/utf8encodings/bf`

`/usr/share/screen/utf8encodings/c2`

`/usr/share/screen/utf8encodings/c3`

`/usr/share/screen/utf8encodings/c4`

`/usr/share/screen/utf8encodings/c6`

`/usr/share/screen/utf8encodings/c7`

`/usr/share/screen/utf8encodings/c8`

`/usr/share/screen/utf8encodings/cc`

`/usr/share/screen/utf8encodings/cd`

`/usr/share/screen/utf8encodings/d6`

`/var/run/screen`

### 解决方案 2

您可以使用`-qlp`选项执行`rpm`来列出包中文件的目标位置。这里有一个例子，其中用 HTTP:

`[root@rac5 up2date]# rpm -qlp`[`http://dbaexpert.com/rpms/openmotif21-2.1.30-`T3】](http://dbaexpert.com/rpms/openmotif21-2.1.30-)

`11.RHEL4.6.i386.rpm`

`warning:`[`http://dbaexpert.com/rpms/openmotif21-2.1.30-11.RHEL4.6.i386.rpm`](http://dbaexpert.com/rpms/openmotif21-2.1.30-11.RHEL4.6.i386.rpm)T2】

`V3 DSA signature: NOKEY, key ID b38a8516`

`/usr/X11R6/lib/libMrm.so.2`

`/usr/X11R6/lib/libMrm.so.2.1`

`/usr/X11R6/lib/libUil.so.2`

`/usr/X11R6/lib/libUil.so.2.1`

`/usr/X11R6/lib/libXm.so.2`

`/usr/X11R6/lib/libXm.so.2.1`

`/usr/share/doc/openmotif21-2.1.30`

`/usr/share/doc/openmotif21-2.1.30/COPYRIGHT.MOTIF`

`/usr/share/doc/openmotif21-2.1.30/README`

`/usr/share/doc/openmotif21-2.1.30/RELEASE`

`/usr/share/doc/openmotif21-2.1.30/RELNOTES`

正如菜谱 11-1 中提到的，您可以对本地文件系统、CD 或具有 HTTP 或 FTP 访问权限的远程服务器上的文件执行前面的`rpm`命令。

### 它是如何工作的

您可以使用`repoquery`命令列出包内容。它将适用于已安装的软件包以及尚未安装的软件包。`repoquery`有多种选择。`–l`选项列出了相关包中的文件。`–i`选项(`--info`)列出了软件包的描述性信息。

下面是一个使用`–i`选项获取屏幕包信息描述的例子:

`# repoquery -i screen`

`Name        : screen`

`Version     : 4.0.3`

`Release     : 16.el6`

`Architecture: x86_64`

`Size        : 814092`

`Packager    : None`

`Group       : Applications/System`

`URL         :`[`http://www.gnu.org/software/screen`T3】](http://www.gnu.org/software/screen)

`Repository  : public_ol6_latest`

`Summary     : A screen manager that supports multiple logins on one terminal`

`Source      : screen-4.0.3-16.el6.src.rpm`

`Description :`

`The screen utility allows you to have multiple logins on just one`

`terminal. Screen is useful for users who telnet into a machine or are`

`connected via a dumb terminal, but want to use more than just one`

`login.`

`Install the screen package if you need a screen manager that can`

`support multiple logins on one terminal.`

`rpm`命令有无数的选项，而`-p`选项允许您直接从包中查看信息。使用`-p`的两个常用选项是`-qip`和`-qlp`。`-qlp`选项列出了组成这个包的所有文件。

`-qip`选项提供关于包的详细信息。这里，除了使用`-qip`选项之外，与前面执行的命令相同:

`# rpm -qip`[`http://dbaexpert.com/rpms/openmotif21-2.1.30-`T3】](http://dbaexpert.com/rpms/openmotif21-2.1.30-)

`11.RHEL4.6.i386.rpm`

`warning:`[`http://dbaexpert.com/rpms/openmotif21-2.1.30-11.RHEL4.6.i386.rpm`](http://dbaexpert.com/rpms/openmotif21-2.1.30-11.RHEL4.6.i386.rpm)T2】

`V3 DSA signature: NOKEY, key ID b38a8516`

`Name        : openmotif21                  Relocations: /usr/X11R6`

`Version     : 2.1.30                            Vendor: (none)`

`Release     : 11.RHEL4.6                    Build Date: Sat 07 Oct 2006 08:45:00`

`AM CDT`

`Install Date: (not installed)               Build Host: ca-build10.us.oracle.com`

`Group       : System Environment/Libraries   Source RPM: openmotif21-2.1.30-`

`11.RHEL4.6.src.rpm`

`Size        : 2249149                          License: Open Group Public License`

`Signature   : DSA/SHA1, Mon 09 Oct 2006 08:24:28 PM CDT, Key ID 2e2bcdbcb38a8516`

`URL         :`[`http://www.opengroup.org/openmotif/`T3】](http://www.opengroup.org/openmotif/)

`Summary     : Compatibility libraries for Open Motif 2.1.`

`Description :`

`This package contains the compatibility libraries for running Open Motif 2.1`

`applications.`

注意,`-qip`选项提供了关于包的额外细节，比如包是什么时候构建的，来自哪台机器，源 RPM，大小，签名，甚至包是关于什么的描述。您还可以将这些选项组合成`-qlip`，它既显示关于包的详细信息，也显示包中所有文件的列表。

## 11-5.下载包

### 问题

您想从 Linux 终端下载 rpm。

### 解决办法

在 RHEL 6 上安装一个名为`yum-plugin-downloadonly`的包，你就可以开始下载 rpm 了:

`# yum install yum-plugin-downloadonly`

安装完`yum-plugin-downloadonly`包后，您可以像实际安装软件一样执行`yum`命令，但是要为它提供两个额外的参数:`--downloadonly`和`--downloaddir`。下面是将屏幕包下载到`/tmp`目录的语法:

`[root@ika82 ∼]# yum install --downloadonly --downloaddir=/tmp screen`

`Loaded plugins: downloadonly`

`Setting up Install Process`

`Resolving Dependencies`

`--> Running transaction check`

`---> Package screen.x86_64 0:4.0.3-16.el6 will be installed`

`--> Finished Dependency Resolution`

`Dependencies Resolved`

`=========================================================================================`

`Package         Arch        Version      Repository                                 Size`

`=========================================================================================`

`Installing:      screen      x86_64       4.0.3-16.el6       public_ol6_latest      494 k`

`Transaction Summary`

`=========================================================================================`

`Install       1 Package(s)`

`Total download size: 494 k`

`Installed size: 795 k`

`Is this ok [y/N]: y`

`Downloading Packages:`

`screen-4.0.3-16.el6.x86_64.rpm                                       | 494 kB     00:01`

`exiting because --downloadonly specified`

通过执行目录列表，您可以确认屏幕包已成功将屏幕 rpm 下载到`/tmp`目录:

`[root@ika82 ∼]# ls -ltr /tmp/*.rpm`

`-rw-r--r--. 1 root root 505732 Apr 22  2011 /tmp/screen-4.0.3-16.el6.x86_64.rpm`

### 它是如何工作的

默认情况下，不安装`yum-plugin-downloadonly`RPM；您必须手动安装 RPM。用`yum`下载 rpm 的最大好处是所有依赖的包会自动一起下载。例如，`perl` RPM 有很多依赖包，所有的`perl`和依赖 RPMS 都可以用一个命令下载。

## 11-6.使用 Oracle RDBMS Server 预安装 RPM 自动构建服务器

### 问题

您不想花时间研究安装 Oracle Database 11g/12c 的 RPM 要求。您希望利用 Oracle 预配置的经验证的安装流程。

### 解决办法

如果您在 OL 或 RHEL 上运行(需要从源 RPM 进行重建)，您可以充分利用 Oracle 的自动化预安装流程。Oracle 的验证安装自动下载所有需要的 RPMsrpm 的安装，包括依赖性要求；Linux 内核参数的设置；在`/etc/passwd`文件中创建`oracle`用户；以及在`/etc/group`文件中为`dba`和`oinstall`创建条目。您只需使用以下选项执行`yum`命令:

`# yum install oracle-rdbms-server-12cR1-preinstall`

`...`

`...`

`Transaction Summary`

`=========================================================================================`

`Install      13 Package(s)`

`Total download size: 7.5 M`

`Installed size: 23 M`

`Is this ok [y/N]: y`

`Downloading Packages:`

`(1/13): compat-libcap1-1.10-1.x86_64.rpm                               |  17 kB     00:00`

`...`

`(13/13): xorg-x11-xauth-1.0.2-7.1.el6.x86_64.rpm                       |  34 kB     00:00`

`-----------------------------------------------------------------------------------------`

`Total                                                         1.7 MB/s | 7.5 MB     00:04`

`..`

`Running Transaction`

`Installing : libstdc++-devel-4.4.7-11.el6.x86_64                                   1/13`

`..`

`Installing : oracle-rdbms-server-12cR1-preinstall-1.0-13.el6.x86_64               13/13`

`Verifying  : compat-libcap1-1.10-1.x86_64                                          1/13`

`..`

`Verifying  : libXmu-1.1.1-2.el6.x86_64                                            13/13`

`Installed:`

`oracle-rdbms-server-12cR1-preinstall.x86_64 0:1.0-13.el6`

`Dependency Installed:`

`compat-libcap1.x86_64 0:1.10-1        compat-libstdc++-33.x86_64 0:3.2.3-69.el6`

`gcc-c++.x86_64 0:4.4.7-11.el6`

`ksh.x86_64 0:20120801-21.el6_6.3      libXmu.x86_64 0:1.1.1-2.el6`

`libXxf86dga.x86_64 0:1.1.4-2.1.el6`

`libXxf86misc.x86_64 0:1.0.3-4.el6     libaio-devel.x86_64 0:0.3.107-10.el6`

`libdmx.x86_64 0:1.1.3-3.el6`

`libstdc++-devel.x86_64 0:4.4.7-11.el6 xorg-x11-utils.x86_64 0:7.5-6.el6`

`xorg-x11-xauth.x86_64 1:1.0.2-7.1.el6`

`Complete!`

此 RPM 安装的输出跨越多页输出。完整的输出，请访问以下网址: [`http://www.dbaexpert.com/blog/oracle-rdbms-server-12cr1-preinstall/`](http://www.dbaexpert.com/blog/oracle-rdbms-server-12cr1-preinstall/) 。对于在 RHEL(需要从源 RPM 重新编译)或 OL 上运行 Oracle Database 11g 第 2 版的 Linux 服务器，您应该利用`oracle-rdbms-server-11gR2-preinstall` RPM:

`# yum install oracle-rdbms-server-11gR2-preinstall`

从 Oracle Database 11g 第 2 版开始，您不再使用 Oracle 验证的安装；而是利用新的`oracle-rdbms-server-11gR2-preinstall`。Oracle 12c RDBMS 预安装 RPM 还会修改`/etc/sysctl.conf`内核配置文件中的内核参数。添加了以下条目:

`# oracle-rdbms-server-12cR1-preinstall setting for fs.file-max is 6815744`

`fs.file-max = 6815744`

`# oracle-rdbms-server-12cR1-preinstall setting for kernel.sem is ’250 32000 100 128’`

`kernel.sem = 250 32000 100 128`

`# oracle-rdbms-server-12cR1-preinstall setting for kernel.shmmni is 4096`

`kernel.shmmni = 4096`

`# oracle-rdbms-server-12cR1-preinstall setting for kernel.shmall is 1073741824 on x86_64`

`# oracle-rdbms-server-12cR1-preinstall setting for kernel.shmmax is 4398046511104 on x86_64`

`kernel.shmmax = 4398046511104`

`# oracle-rdbms-server-12cR1-preinstall setting for kernel.panic_on_oops is 1 per Orabug 19642132`

`kernel.panic_on_oops = 1`

`# oracle-rdbms-server-12cR1-preinstall setting for net.core.rmem_default is 262144`

`net.core.rmem_default = 262144`

`# oracle-rdbms-server-12cR1-preinstall setting for net.core.rmem_max is 4194304`

`net.core.rmem_max = 4194304`

`# oracle-rdbms-server-12cR1-preinstall setting for net.core.wmem_default is 262144`

`net.core.wmem_default = 262144`

`# oracle-rdbms-server-12cR1-preinstall setting for net.core.wmem_max is 1048576`

`net.core.wmem_max = 1048576`

`# oracle-rdbms-server-12cR1-preinstall setting for fs.aio-max-nr is 1048576`

`fs.aio-max-nr = 1048576`

`# oracle-rdbms-server-12cR1-preinstall setting for net.ipv4.ip_local_port_range is 9000 65500`

`net.ipv4.ip_local_port_range = 9000 65500`

此外，预安装 RPM 过程会调整`/etc/passwd`文件以包含`oracle`用户，并创建`/home/oracle`目录:

`oracle:x:54321:54321::/home/oracle:/bin/bash`

此外，`dba`和`oinstall`的条目被添加到`/etc/group`文件中:

`oinstall:x:54321:`

`dba:x:54322:oracle`

### 它是如何工作的

安装 Linux 并将系统发布给 DBA 之后，您必须快速配置 Linux 服务器以进行数据库软件供应。如果服务器安装了 OL 6，您可以直接从公共 YUM 存储库中利用`oracle-rdbms-server-12cR1-preinstall` RPM。许多数据库管理员没有意识到 Oracle RDBMS 11g/12c 预安装 RPM 安装选项的存在。使用`oracle-rdbms-server-12cR1-preinstall` RPM，您可以通过一个命令安装 Oracle Universal Installer 所需的软件包。执行该命令可以满足安装 Oracle 数据库服务器的大部分 Linux 服务器要求，如下所示:

*   创建了 oracle 用户以及 oinstall(软件所有者)和 DBA(OSDBA)组，它们在数据库安装过程中使用
*   在`/etc/sysctl.conf`中为共享内存修改内核参数，比如信号量、文件描述符的最大数量等等
*   软硬外壳资源限制的设置在`./etc/security/limits.conf`中进行，例如锁定的内存地址空间、打开的文件数量、进程数量和核心文件大小
*   在`/etc/grub.conf`配置文件中，非统一内存访问(NUMA)和透明大页面(THP)也被禁用

Note

有关 NUMA、THP 和内核参数的详细信息，请参见第十三章[。](13.html)

让 Oracle RDBMS Server 为 OL 预装 RPM 是采用 RHEL 或其他 Linux 发行版的 OL 的最大好处之一。只需一个命令，您就可以为 OEM 12c 代理、EBS R12 和 Oracle Database 11gR2/12c 安装预配置 OL 环境。Oracle 不仅配置 Linux 环境，而且许多最佳实践也融入其中。

对于 Oracle RDBMS Server 预装 Oracle Database 11g Release 2 和 Oracle Database 12c Release 1 的 rpm，可以从`public-yum`库的最新渠道下载: [`http://public-yum.oracle.com/repo/OracleLinux/OL6/latest/x86_64/`](http://public-yum.oracle.com/repo/OracleLinux/OL6/latest/x86_64/) 。你必须向下滚动一点。以大写字母开头的 rpm 列在小写字母的 rpm 之上。

您还可以从`public-yum`存储库中的 addons 通道下载 Oracle EBS R12 和 OEM Agent 12c 的预安装 rpm。Oracle 为 OEM 12c 的每个版本提供了单独的 RPM。请访问以下网址获取最新版本的 [`oracle-ebs-server-R12-preinstall-1.0-7.el6.x86_64.rpm`](http://public-yum.oracle.com/repo/OracleLinux/OL6/addons/x86_64/getPackage/oracle-ebs-server-R12-preinstall-1.0-7.el6.x86_64.rpm) 和[`oracle-em-agent-12cR4-preinstall-1.0-7.el6.x86_64.rpm`](http://public-yum.oracle.com/repo/OracleLinux/OL6/addons/x86_64/getPackage/oracle-em-agent-12cR4-preinstall-1.0-7.el6.x86_64.rpm)rpm:[`http://public-yum.oracle.com/repo/OracleLinux/OL6/addons/x86_64/`](http://public-yum.oracle.com/repo/OracleLinux/OL6/addons/x86_64/)。

许多数据库管理员不知道 Oracle 还为每个预安装 rpm 提供了源 rpm。例如，您可以下载`oracle-rdbms-server-12cR1-preinstall.rpm`文件的源 RPM。该文件将被命名为`oracle-rdbms-server-12cR1-preinstall.src.rpm`，并将与其他 RPMS 存在于相同的 URL 位置。

Note

关于获取 OL 源 RPM 并为 RHEL 重新构建它的分步说明，请下载下面的白皮书: [`http://www.dbaexpert.com/blog/collaborate-2014-extreme-oracle-db-infrastructure-as-a-service-paper/`](http://www.dbaexpert.com/blog/collaborate-2014-extreme-oracle-db-infrastructure-as-a-service-paper/) 。本白皮书介绍了使用`oracle-rdbms-server-12cR1-preinstall`源 RPM 和`rpm –ihv`命令执行安装以及操作创建的清单的过程。修改规范文件后，本文展示了使用`rpmbuild`命令生成 RPM 文件的过程，这样您就可以在 RHEL 上利用和配置 Oracle 的预安装 RPM。您可以对 OEM 代理预安装 RPM 和 Oracle 电子商务套件预安装 RPM 重复相同的过程，并在 RHEL 上利用它们。

## 11-7.升级软件包

### 问题

您意识到您拥有旧版本的软件组件。您希望将一些旧的软件包升级到最新版本。

### 解决方案#1

要升级现有的软件包和所有相关的软件包，您可以执行带有`update`选项的`yum`命令:

`# yum update perl`

### 解决方案 2

要升级一个现有的包，您可以使用`-Uhv`选项(或`--upgrade`)来执行`rpm`。对于这个特殊的解决方案，您将升级`perl` RPM。执行带有`-Uhv`选项的`rpm`可执行文件来升级`perl`包:

`# rpm -Uhv perl-5.8.8-10.0.1.el5_2.3.i386.rpm`

`Preparing...                ########################################### [100%]`

`1:perl                   ########################################### [100%]`

### 它是如何工作的

带有`update`选项的`yum`命令是在 Linux 服务器上升级软件包的最佳选项。`update`选项安装软件包或软件包组的最新版本。如果您不提供软件包名称，`yum`将尝试升级所有软件包。要删除和替换废弃的包，提供`--obsoletes`选项。

或者，您可以使用`-Uhv`选项升级现有的包。在后台，原来的包将被删除，新的包将被安装。原始配置文件将会保留，但会以扩展名`.rpmsave`重命名。因为`-U`选项删除并安装软件包，所以您也可以使用`-U`选项来安装软件包。如果软件包不存在，将安装软件包。

Tip

如果您需要升级大量的包(或者甚至将升级应用到所有现有的包)，您可以使用`-F`选项(或者`--freshen`)。如果软件包不存在，`-F`选项不会安装软件包。

## 11-8.移除包

### 问题

您想从 Linux 服务器上删除一个包。

### 解决方案#1

移除软件包的首选方法是利用带有`erase`选项的`yum`命令。要在没有提示的情况下删除`screen`包，可以执行以下语法:

`# yum -y erase screen`

`Loaded plugins: product-id, subscription-manager`

`This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.`

`Setting up Remove Process`

`Resolving Dependencies`

`--> Running transaction check`

`---> Package screen.x86_64 0:4.0.3-16.el6 will be erased`

`--> Finished Dependency Resolution`

`Dependencies Resolved`

`=========================================================================================`

`Package          Arch             Version                  Repository               Size`

`=========================================================================================`

`Removing:`

`screen           x86_64           4.0.3-16.el6             @viscosity              795 k`

`Transaction Summary`

`=========================================================================================`

`Remove        1 Package(s)`

`Installed size: 795 k`

`Downloading Packages:`

`Running rpm_check_debug`

`Running Transaction Test`

`Transaction Test Succeeded`

`Running Transaction`

`Erasing    : screen-4.0.3-16.el6.x86_64                                            1/1`

`Verifying  : screen-4.0.3-16.el6.x86_64                                            1/1`

`Removed:`

`screen.x86_64 0:4.0.3-16.el6`

`Complete!`

### 解决方案 2

另一种移除包的方法是执行带`-e`选项的`rpm`命令(或`--erase`)。要删除`screen`包，可以执行以下语法:

`rpm -e screen`

### 它是如何工作的

与软件包安装类似，可以使用`erase`选项通过`yum`命令从服务器中删除软件。`remove`选项是`erase`选项的别名。`yum erase`命令将卸载任何软件包以及相关的软件包。您也可以使用`yum remove`命令卸载一个包组，如 Web 服务器或 X Window 系统。

也可以使用带有`-e`选项的`rpm`命令从服务器中删除软件。您必须提供已安装的软件包名称作为第二个参数；不要提供包文件名。解决方案中的示例从系统中删除了`screen`包。由于依赖关系的要求，您通常不能删除 RPM 要删除指定的 RPM，您必须知道依赖顺序。虽然我们不建议这样做，但是您可以使用`--nodeps`选项来避免依赖性检查。

## 11-9.检查安装 Oracle 数据库的 RPM 要求

### 问题

确保您的数据库软件安装尽可能顺利。检查 Linux 服务器是否有 Oracle 指定的安装 Oracle Database 12c 所需的软件包列表。

### 解决办法

您可以执行以下名为`rpm6.ksh`(对于 RHEL/OL 6)和`rpm7.ksh`(对于 RHEL/OL 7)的简短代码片段，以快速查看 Linux 服务器是否符合安装和配置数据库所需的包要求:

`$ cat rpm6.ksh`

`rpm -q --queryformat "%{NAME}-%{VERSION}.%{RELEASE} (%{ARCH})\n" \`

`binutils compat-libcap1 compat-libstdc++-33 gcc gcc-c++ glibc glibc-devel \`

`ksh libgcc libstdc++ libstdc++-devel libaio libaio-devel \`

`libXext libXtst libX11 libXau libxcb libXi make sysstat  \`

`unixODBC unixODBC-devel`

`$ cat rpm7.ksh`

`rpm -q --queryformat "%{NAME}-%{VERSION}.%{RELEASE} (%{ARCH})\n" \`

`binutils compat-libcap1 gcc gcc-c++ glibc glibc-devel ksh \`

`libaio libaio-devel libgcc libstdc++ libstdc++-devel libXi libXtst \`

`make sysstat unixODBC unixODBC-devel`

我们建议每个 Oracle 服务器都包含 screen RPM，就像 Oracle ASMLIB 库应该是每个服务器安装的一部分一样。使用`rpm6.ksh`脚本对 OL 6.6 服务器执行 RPM 检查会产生以下结果:

`$ ./rpm6.ksh`

`binutils-2.20.51.0.2.5.42.el6 (x86_64)`

`compat-libcap1-1.10.1 (x86_64)`

`compat-libstdc++-33-3.2.3.69.el6 (x86_64)`

`gcc-4.4.7.11.el6 (x86_64)`

`gcc-c++-4.4.7.11.el6 (x86_64)`

`glibc-2.12.1.149.el6 (x86_64)`

`glibc-devel-2.12.1.149.el6 (x86_64)`

`ksh-20120801.21.el6_6.3 (x86_64)`

`libgcc-4.4.7.11.el6 (x86_64)`

`libstdc++-4.4.7.11.el6 (x86_64)`

`libstdc++-devel-4.4.7.11.el6 (x86_64)`

`libaio-0.3.107.10.el6 (x86_64)`

`libaio-devel-0.3.107.10.el6 (x86_64)`

`libXext-1.3.2.2.1.el6 (x86_64)`

`libXtst-1.2.2.2.1.el6 (x86_64)`

`libX11-1.6.0.2.2.el6 (x86_64)`

`libXau-1.0.6.4.el6 (x86_64)`

`libxcb-1.9.1.2.el6 (x86_64)`

`libXi-1.7.2.2.2.el6 (x86_64)`

`make-3.81.20.el6 (x86_64)`

`sysstat-9.0.4.27.el6 (x86_64)`

`package unixODBC is not installed`

`package unixODBC-devel is not installed`

### 它是如何工作的

因为您计划在 64 位 Linux 操作系统上运行 Oracle 数据库，所以检查 32 位和 64 位软件包。例如，您必须安装 32 位和 64 位组件的`compat-db`包。您可以指定`-qf`选项(或`--queryformat`)后跟格式选项来操作输出显示。查询字符串格式由类似于`printf`语法的静态字符串组成。

在这个解决方案中，指定了`"%{NAME}-%{VERSION}.%{RELEASE} (%{ARCH})\n"`格式来显示架构。如果输出显示`(x86_64)`，则可以确认安装了 64 位软件包。如果输出显示`(i386)`，您可以确认 32 位版本的软件包已经安装。下面是 Oracle Database 12c 在 RHEL 和 OL 6 和 7 上的完整 RPM 要求: [`http://www.dbaexpert.com/blog/rpm-requirement-on-red-hat-and-oracle-linux-6-and-7-for-oracle-database-12c-release-1/`](http://www.dbaexpert.com/blog/rpm-requirement-on-red-hat-and-oracle-linux-6-and-7-for-oracle-database-12c-release-1/) 。

您仍然需要检查所提供的脚本的输出，以确保输出达到或超过包的预期水平。与 Oracle 成功安装 Oracle Database 12c 所需的内容相比，此脚本的主要目的是提供一个统一的输出来审查 rpm。

## 11-10.使用响应文件执行初始静默 Oracle 软件安装

### 问题

您希望在新服务器上执行 Oracle 二进制文件的初始安装。当尝试运行图形安装程序时，您怀疑网络带宽会导致问题。您希望使用响应文件静默安装 Oracle 二进制文件。

另一方面，您希望减少安装 Oracle Database 12c 所需的时间。您希望通过使用静默选项执行安装来自动执行安装过程。

### 解决方案#1

在此解决方案中，只有 Oracle 软件二进制文件安装到指定的目标 Oracle 主目录。此解决方案假设您已经在数据库服务器上成功下载、复制和卸载了 Oracle 安装软件。解开安装软件后，您应该会在数据库目录中看到一个名为`response`的目录。

首先，将目录更改为`response`目录，并列出文件。您应该会看到几个响应文件:

`dbca.rsp  db_install.rsp  netca.rsp`

对于此解决方案，您感兴趣的是执行 Oracle Database 12c 软件堆栈静默安装的`db_install.rsp`响应文件。在操作此响应文件之前，请备份该文件。用编辑器如`vi`打开`db_install.rsp`响应文件，并为响应文件中的各种变量提供环境的有效值。在本例中，响应文件名为`12c_db.rsp`，放在`/tmp`目录中。修改了十几个参数，因为您只对安装软件感兴趣；您不想在安装时创建数据库。在典型的新实施中，您将安装 Oracle Database 12c 并应用最新的 PSU。您需要在应用 PSU 后创建数据库。

让我们回顾一下安装 Oracle 数据库软件的响应文件的内容。您将使用`egrep`命令过滤掉响应文件中的所有注释和空白行。然后，您将执行另一级过滤，只查看等号后面有关联值的行。使用下面的一行代码示例，您可以查看所有与`db_install.rsp`响应文件相关的变量:

`$ egrep -v "^#|^$" db_install.rsp |awk -F"=" ’{if ($2)print $1"=" $2}’`

`oracle.install.responseFileVersion=/oracle/install/rspfmt_dbinstall_response_schema_v12.1.0`

`oracle.install.option=INSTALL_DB_SWONLY`

`ORACLE_HOSTNAME=dal66a`

`UNIX_GROUP_NAME=oinstall`

`INVENTORY_LOCATION=/u01/app/oraInventory`

`SELECTED_LANGUAGES=en`

`ORACLE_HOME=/u01/app/oracle/product/12.1.0.2/dbhome_1`

`ORACLE_BASE=/u01/app/oracle`

`oracle.install.db.InstallEdition=EE`

`oracle.install.db.DBA_GROUP=dba`

`oracle.install.db.OPER_GROUP=dba`

`oracle.install.db.BACKUPDBA_GROUP=dba`

`oracle.install.db.DGDBA_GROUP=dba`

`oracle.install.db.KMDBA_GROUP=dba`

`SECURITY_UPDATES_VIA_MYORACLESUPPORT=false`

`DECLINE_SECURITY_UPDATES=true`

要查看的第一个参数是`oracle.install_`选项。该参数接受三个值:`INSTALL_DB_SWONLY`、`INSTALL_DB_AND_CONFIG`和`UPGRADE_DB`。在这个解决方案中，您将看到`INSTALL_DB_SWONLY`只安装软件。

`UNIX_GROUP_NAME`通常不是`dba`就是`oinstall`。根据您希望在各种支持组织之间划分的级别，您可以选择不同的组。例如，您可以在`/etc/group`文件中创建一个特殊的 Linux 组，将备份团队分配给该组，并将该组分配给`BACKUPDBA_GROUP`。

`ORACLE_HOSTNAME`应该是将要进行安装的本地主机名。`ORACLE_HOME`目录必须指向您希望安装 oracle 软件的目录位置，并且它应该是 Oracle 帐户拥有写权限的目录。对于您的安装，`ORACLE_HOME`变量将匹配`oratab`文件(通常位于`/etc`目录)中的值。`oratab`文件包含在服务器上本地运行的数据库的条目。

`oratab`文件的每一行包含三个参数:数据库名称、数据库软件位置(也称为`ORACLE_HOME`)和启动标志。最后一个参数在自动化数据库启动中起着重要的作用。如果最后一个参数的值设置为`Y`，位于`$ORACLE_HOME/bin`目录中的`dbstart` shell 脚本将包含服务器重启时启动的数据库。`ORACLE_HOME_NAME`是该安装的软件主目录的唯一名称。

`oracle.install.db.InstallEdition`只有企业版(EE)才有选项。在以前的版本中，您可以指定安装是针对标准编辑器还是 EE，但是因为您下载了 EE 软件，所以响应文件会将此参数预填充为 EE 值。

将您的目录设置为数据库目录(下载的 zip 文件将解压到的目录)。在这个目录中，您会找到`runInstaller`可执行文件。`response`目录是该目录的子目录。现在，您可以通过使用以下命令行语法执行`runInstaller`来安装二进制文件:

`$ ./runInstaller -silent -responseFile /tmp/db_install.rsp`

`Starting Oracle Universal Installer...`

`Checking Temp space: must be greater than 500 MB.   Actual 3674 MB    Passed`

`Checking swap space: must be greater than 150 MB.   Actual 4095 MB    Passed`

`Preparing to launch Oracle Universal Installer from /tmp/OraInstall2015-05-16_12-53-14PM. Please wait ...[oracle@dal66a database]$ You can find the log of this install session at:`

`/u01/app/oraInventory/logs/installActions2015-05-16_12-53-14PM.log`

`The installation of Oracle Database 12c was successful.`

`Please check ’/u01/app/oraInventory/logs/silentInstall2015-05-16_12-53-14PM.log’ for more details.`

`As a root user, execute the following script(s):`

`1\. /u01/app/oraInventory/orainstRoot.sh`

`2\. /u01/app/oracle/product/12.1.0.2/dbhome_1/root.sh`

`Successfully Setup Software.`

一旦安装成功完成，as `root`执行`orainstRoot.sh`和`root.sh`脚本。在本例中，`orainstRoot.sh`脚本驻留在`/u01/app/oraInventory`目录中，而`root.sh`脚本驻留在`/u01/app/oracle/product/12.1.0/dbhome_1`目录中:

`$ sudo /u01/app/oraInventory/orainstRoot.sh`

`Changing permissions of /u01/app/oraInventory.`

`Adding read,write permissions for group.`

`Removing read,write,execute permissions for world.`

`Changing groupname of /u01/app/oraInventory to oinstall.`

`The execution of the script is complete.`

`$ sudo /u01/app/oracle/product/12.1.0.2/dbhome_1/root.sh`

`Check /u01/app/oracle/product/12.1.0.2/dbhome_1/install/root_dal66a_2015-05-16_13-22-19.log for the output of root script`

您现在可以开始使用新安装的 Oracle 软件并创建一个数据库。

### 解决方案 2

在此解决方案中，您将把 Oracle 软件二进制文件安装到指定的目标 Oracle 主目录中，并创建一个数据库，这样您就可以开始 Oracle 开发和部署了。此解决方案假设您已经在数据库服务器上成功上传并解包了 Oracle 安装软件。

您将操作与解决方案 1 中相同的`db_install.rsp`响应文件，除了您还将输入数据库配置选项部分的值，并将`oracle.install.option`从`INSTALL_DB_SWONLY`更改为`INSTALL_DB_AND_CONFIG`。在数据库配置选项中创建数据库所需的所有参数都以`oracle.install.db.xxxxxx`开始。

让我们来看一个示例响应文件，该文件被用来安装 Oracle Database 12c 软件，并为`/oradata1`文件系统创建一个名为`DBATOOLS`的数据库:

`$ egrep -v "^#|^$" 12c_db_with_database.rsp |awk -F"=" ’{if ($2)print $1"=" $2}’`

`oracle.install.responseFileVersion=/oracle/install/rspfmt_dbinstall_response_schema_v12.1.0`

`oracle.install.option=INSTALL_DB_AND_CONFIG`

`ORACLE_HOSTNAME=dal66a`

`UNIX_GROUP_NAME=oinstall`

`INVENTORY_LOCATION=/u01/app/oraInventory`

`SELECTED_LANGUAGES=en`

`ORACLE_HOME=/u01/app/oracle/product/12.1.0/dbhome_2`

`ORACLE_BASE=/u01/app/oracle`

`oracle.install.db.InstallEdition=EE`

`oracle.install.db.DBA_GROUP=dba`

`oracle.install.db.OPER_GROUP=dba`

`oracle.install.db.BACKUPDBA_GROUP=dba`

`oracle.install.db.DGDBA_GROUP=dba`

`oracle.install.db.KMDBA_GROUP=dba`

`oracle.install.db.config.starterdb.type=GENERAL_PURPOSE`

`oracle.install.db.config.starterdb.globalDBName=DBATOOLS`

`oracle.install.db.config.starterdb.SID=DBATOOLS`

`oracle.install.db.ConfigureAsContainerDB=true`

`oracle.install.db.config.PDBName=vna01`

`oracle.install.db.config.starterdb.characterSet=WE8MSWIN1252`

`oracle.install.db.config.starterdb.memoryOption=false`

`oracle.install.db.config.starterdb.memoryLimit=1024`

`oracle.install.db.config.starterdb.installExampleSchemas=false`

`oracle.install.db.config.starterdb.password.ALL=oracle123`

`oracle.install.db.config.starterdb.password.SYS=oracle123`

`oracle.install.db.config.starterdb.password.SYSTEM=oracle123`

`oracle.install.db.config.starterdb.password.DBSNMP=oracle123`

`oracle.install.db.config.starterdb.password.PDBADMIN=oracle123`

`oracle.install.db.config.starterdb.managementOption=DEFAULT`

`oracle.install.db.config.starterdb.enableRecovery=true`

`oracle.install.db.config.starterdb.storageType=FILE_SYSTEM_STORAGE`

`oracle.install.db.config.starterdb.fileSystemStorage.dataLocation=/oradata1`

`oracle.install.db.config.starterdb.fileSystemStorage.recoveryLocation=/oradata1`

`SECURITY_UPDATES_VIA_MYORACLESUPPORT=false`

`DECLINE_SECURITY_UPDATES=true`

在静默模式下调用`runInstaller`命令并提供前面提到的配置文件会产生以下结果:

`$ ./runInstaller -silent -responseFile /tmp/12c_db_with_database.rsp`

`Starting Oracle Universal Installer...`

`Checking Temp space: must be greater than 500 MB.   Actual 3665 MB    Passed`

`Checking swap space: must be greater than 150 MB.   Actual 4095 MB    Passed`

`Preparing to launch Oracle Universal Installer from /tmp/OraInstall2015-05-16_01-44-57PM. Please wait ...[oracle@dal66a database]$ [WARNING] [INS-30011] The ADMIN password entered does not conform to the Oracle recommended standards.`

`CAUSE: Oracle recommends that the password entered should be at least 8 characters in length, contain at least 1 uppercase character, 1 lower case character and 1 digit [0-9].`

`ACTION: Provide a password that conforms to the Oracle recommended standards.`

`You can find the log of this install session at:`

`/u01/app/oraInventory/logs/installActions2015-05-16_01-44-57PM.log`

`The installation of Oracle Database 12c was successful.`

`Please check ’/u01/app/oraInventory/logs/silentInstall2015-05-16_01-44-57PM.log’ for more details.`

`As a root user, execute the following script(s):`

`1\. /u01/app/oraInventory/orainstRoot.sh`

`2\. /u01/app/oracle/product/12.1.0/dbhome_2/root.sh`

`Successfully Setup Software.`

`As install user, execute the following script to complete the configuration.`

`1\. /u01/app/oracle/product/12.1.0/dbhome_2/cfgtoollogs/configToolAllCommands RESPONSE_FILE=<response_file>`

`Note:`

`1\. This script must be run on the same host from where installer was run.`

`2\. This script needs a small password properties file for configuration assistants that require passwords (refer to install guide documentation).`

如您所见，输出看起来非常类似于解决方案#1 中的输出。这个输出的主要区别在于，系统会提示您使用响应文件名作为输入参数来执行`$ORACLE_HOME/cfgtoollogs/configToolsAllCommands`脚本。请求的响应文件与用于软件安装的响应文件不同；这是一个小的密码属性文件。`db_install.rsp`响应文件不存储任何密码，但实际安装时会提示您输入`SYS`、`SYSTEM`、`DBSNMP`、`PDBADMIN`、`EMADMIN`和`ASMSNMP`用户的密码来配置数据库。

这里有一个示例密码属性文件，需要用密码为`SYS`、`SYSTEM`、`DBSNMP`、`PDBADMIN`、`EMADMIN`和`ASMSNMP`帐户配置数据库部署:

`$ cat cfgrsp.properties`

`oracle.assistants.server|S_SYSPASSWORD=oracle123`

`oracle.assistants.server|S_SYSTEMPASSWORD=oracle123`

`oracle.assistants.server|S_DBSNMPPASSWORD=oracle123`

`oracle.assistants.server|S_PDBADMINPASSWORD=oracle123`

`oracle.assistants.server|S_EMADMINPASSWORD=oracle123`

`oracle.assistants.server|S_ASMSNMPPASSWORD=oracle123`

Note

安装完成后，请记住丢弃密码属性文件或更改密码。出于安装目的，请将文件权限设置为`600`。

带有密码属性文件的`configToolAllCommands`的输出相当冗长。下面是生成的输出的一部分:

`$ /u01/app/oracle/product/12.1.0/dbhome_2/cfgtoollogs/configToolAllCommands RESPONSE_FILE=/home/oracle/cfgrsp.properties`

`Setting the invPtrLoc to /u01/app/oracle/product/12.1.0/dbhome_2/oraInst.loc`

`perform - mode is starting for action: configure`

`May 16, 2015 1:51:21 PM oracle.install.config.common.NetCAInternalPlugIn invoke`

`INFO: NetCAInternalPlugIn: ... adding </ouiinternal>`

`May 16, 2015 1:51:21 PM oracle.install.driver.oui.config.GenericInternalPlugIn invoke`

`INFO: Executing NETCA`

`May 16, 2015 1:51:21 PM oracle.install.driver.oui.config.GenericInternalPlugIn invoke`

`INFO: Command /u01/app/oracle/product/12.1.0/dbhome_2/bin/netca /orahome /u01/app/oracle/product/12.1.0/dbhome_2 /orahnam OraDB12Home1 /instype typical /inscomp client,oraclenet,javavm,server,ano /insprtcl tcp /cfg local /authadp NO_VALUE /responseFile /u01/app/oracle/product/12.1.0/dbhome_2/network/install/netca_typ.rsp /silent  /silent   /ouiinternal May 16, 2015 1:51:21 PM`

`...`

`...`

`...`

`oracle.install.driver.oui.config.GenericInternalPlugIn handleProcess`

`INFO: Read: 78% complete`

`May 16, 2015 2:00:17 PM oracle.install.driver.oui.config.GenericInternalPlugIn handleProcess`

`WARNING: Skipping line: 78% complete`

`May 16, 2015 2:00:17 PM oracle.install.driver.oui.config.GenericInternalPlugIn handleProcess`

`INFO: Read: 100% complete`

`May 16, 2015 2:00:17 PM oracle.install.driver.oui.config.GenericInternalPlugIn handleProcess`

`WARNING: Skipping line: 100% complete`

`May 16, 2015 2:00:17 PM oracle.install.driver.oui.config.GenericInternalPlugIn handleProcess`

`INFO: Read: Look at the log file "/u01/app/oracle/cfgtoollogs/dbca/DBATOOLS/DBATOOLS.log" for further details.`

`May 16, 2015 2:00:17 PM oracle.install.driver.oui.config.GenericInternalPlugIn handleProcess`

`WARNING: Skipping line: Look at the log file "/u01/app/oracle/cfgtoollogs/dbca/DBATOOLS/DBATOOLS.log" for further details.`

`perform - mode finished for action: configure`

`You can see the log file: /u01/app/oracle/product/12.1.0/dbhome_2/cfgtoollogs/oui/configActions2015-05-16_01-51-20-PM.log`

作为最后的验证，您必须检查日志文件并查看数据库是否正在运行。首先，查看配置工具日志文件，确认您已经为 DBCA 取得了 100%的进展:

`$ cat /u01/app/oracle/cfgtoollogs/dbca/DBATOOLS/DBATOOLS.log`

`Unique database identifier check passed.`

`/oradata1/ has enough space. Required space is 7665 MB , available space is 61030 MB.`

`File Validations Successful.`

`Copying database files`

`DBCA_PROGRESS : 1%`

`DBCA_PROGRESS : 2%`

`DBCA_PROGRESS : 27%`

`Creating and starting Oracle instance`

`..`

`Completing Database Creation`

`..`

`Creating Pluggable Databases`

`DBCA_PROGRESS : 78%`

`DBCA_PROGRESS : 100%`

`Database creation complete. For details check the logfiles at:`

`/u01/app/oracle/cfgtoollogs/dbca/DBATOOLS.`

`Database Information:`

`Global Database Name:DBATOOLS`

`System Identifier(SID):DBATOOLS`

您可以执行一些基本的健康检查，通过检查 PMON 进程和数据库监听器进程来验证`DBATOOLS`数据库是否正在运行以及数据库监听器是否启动。使用`ps`命令，您可以在进程列表中过滤关键字`pmon`和`tns`，用竖线分隔，表示您正在使用`egrep`命令寻找这两个条件。

您还可以引入一个带有`–v`选项的`grep`命令来忽略列表中包含单词`grep`的输出，如下所示:

`$ ps -ef |egrep “pmon|tns” |grep -v grep`

`oracle    8357     1  0 13:59 ?        00:00:00 ora_pmon_DBATOOLS`

`root        15     2  0 13:27 ?        00:00:00 [netns]`

`oracle    7486     1  0 13:51 ?        00:00:00 /u01/app/oracle/product/12.1.0/dbhome_2/bin/tnslsnr LISTENER -inherit`

### 它是如何工作的

使用响应文件可以使 Oracle 软件的安装和配置完全自动化。Oracle Universal Installer 读取您在响应文件中指定的值来执行安装。这种技术在几种情况下是可取的。例如，如果您经常在带宽有限的 WAN 上执行远程安装，那么使用图形安装程序可能不是一个好的选择(因为响应时间非常慢，而且会出现网络中断)。

您可以轻松地为您的环境所需的数据库选项定制响应文件。然后，您可以在将来的安装中重用相同的响应文件。静默安装技术允许您执行可重复的标准化 Oracle 安装，甚至升级。您可以记录所需的确切步骤，并让初级 DBA 和/或 sa 使用响应文件安装`oracle`二进制文件。

令一些 DBA 惊讶的是，您可以使用`runInstaller`程序和`-record`选项创建自己的定制响应文件。实际上，您在`runInstaller`会话中的选择将被记录到指定的响应文件名中。创建自定义响应文件的语法如下所示:

`./runInstaller -record -destinationFile /tmp/custom_db_install.rsp`

`-destinationFile`选项指定目标响应文件的位置。您不必实际执行安装来创建响应文件。只要导航到安装过程的摘要屏幕，就会创建响应文件。

确保您为`ORACLE_HOME`指定的值不会与`oraInst.loc`文件中已经存在的主目录冲突。这个文件通常位于`/etc`目录下。对于`ORACLE_HOME_NAME`，查看位于`OraInventory`子目录下的`inventory.xml`文件的内容，该子目录通常位于`$ORACLE_BASE/../oraInventory/ContentsXML`目录下(即`/u01/app/oraInventory/ContentsXML directory`)。

## 11-11.使用响应文件创建数据库

### 问题

您不能在 GUI 模式下启动 DBCA，因为您的网络连接速度非常慢，或者因为您在一个非常安全的数据中心中处于多个防火墙之后。您希望创建一个 DBCA 处于静默模式的数据库。

您希望自动构建数据库，并使用一致的配置和初始化参数构建数据库。

### 解决办法

好消息是，在将`dbca.rsp`响应文件修改为您想要的配置之后，您可以在静默模式下创建一个数据库。这个特殊的解决方案展示了在修改了最少数量的`dbca.rsp`响应文件中的参数之后创建数据库的简单性。至少应修改参数`OPERATION_TYPE`、`GDBNAME`、`SID`、`TEMPLATE_NAME`、`SYSPASSWORD`、`SYSTEMPASSWORD`、`DATAFILEDESTINATION`、`STORAGETYPE`、`CHARACTERSET`和`NATIONALCHARACTERSET`。

Oracle Database 12c 提供多租户选项来创建可插拔数据库(pdb)。您可以通过将`CREATEASCONTAINERDATABASES`设置为`yes`，然后指定`NUMBEROFPDBS`、`PDBPREFIX`和`PDBADMINPASSWORD`参数来启用 PDBs。在本例中，在原始文件备份到`dbca.rsp.BKUP`后，前面提到的`dbca.rsp`文件中的所有参数都被修改。

这里有一个位于`/tmp`目录中的示例`dbca.rsp`响应文件，它被用来创建一个名为`TOOLSDEV`的数据库，其中有两个可插拔的数据库。为了只显示修改后的响应，利用带有`–v`选项的`egrep`命令来忽略所有以注释和空行开始的行:

`$ cat /tmp/dbca.rsp |egrep -v "^#|^$"`

`[GENERAL]`

`RESPONSEFILE_VERSION = "12.1.0"`

`OPERATION_TYPE = "createDatabase"`

`[CREATEDATABASE]`

`GDBNAME = "TOOLSDEV"`

`SID = "TOOLSDEV"`

`CREATEASCONTAINERDATABASE =yes`

`NUMBEROFPDBS =2`

`PDBNAME =vna`

`PDBADMINPASSWORD = "oracle123"`

`TEMPLATENAME = "General_Purpose.dbc"`

`SYSPASSWORD = "oracle123"`

`SYSTEMPASSWORD = "oracle123"`

`EMCONFIGURATION = "NONE"`

`DATAFILEDESTINATION =/oradata1`

`RECOVERYAREADESTINATION=/oradata1`

`STORAGETYPE=FS`

`CHARACTERSET = "AL32UTF8"`

`NATIONALCHARACTERSET= "AL16UTF16"`

`DATABASETYPE = "MULTIPURPOSE"`

`AUTOMATICMEMORYMANAGEMENT = "FALSE"`

`TOTALMEMORY = "1024"`

因为软件已经安装好了，你必须从`$ORACLE_HOME/bin directory`开始以静默模式启动`dbca`。在这个解决方案中，`dbca`通过`-silent`参数和`-responseFile`参数启动，后面是响应文件的位置:

`$ dbca -silent -responseFile /tmp/dbca.rsp`

`Cleaning up failed steps`

`5% complete`

`Copying database files`

`7% complete`

`9% complete`

`41% complete`

`Creating and starting Oracle instance`

`43% complete`

`48% complete`

`53% complete`

`57% complete`

`58% complete`

`59% complete`

`62% complete`

`64% complete`

`Completing Database Creation`

`68% complete`

`71% complete`

`75% complete`

`85% complete`

`96% complete`

`100% complete`

`Look at the log file "/u01/app/oracle/cfgtoollogs/dbca/TOOLSDEV/TOOLSDEV0.log" for further details.`

在静默模式下，`dbca`提供一个进度状态，通知您它在数据库创建过程中的位置。在初始阶段，RMAN 执行数据文件的恢复。恢复完成后，`dbca`创建并启动实例。最后，执行后数据库配置步骤。

创建数据库后，您可以在`$ORACLE_BASE/cfgtoollogs/dbca/$ORACLE_SID`目录中查看日志文件。您还会注意到在名为`TOOLSDEV`的新数据库的`/etc/oratab`文件中有一个条目:

`TOOLSDEV:/apps/oracle/product/11.1.0/DB:N`

### 它是如何工作的

如今，使用 DBCA 创建数据库是许多组织的标准做法。许多 DBA 启动 DBCA 并在 GUI 模式下配置数据库，但也有少数 DBA 使用响应文件来利用可用的选项。通过有效地利用 DBCA 和静默选项，您可以自动创建数据库，并在整个组织中一致地创建数据库。您可以修改`dbca.rsp`文件以在 ASM 上构建数据库，甚至创建 RAC 数据库。您几乎可以控制响应文件的每个方面，类似于在 GUI 模式下启动 DBCA。您的 DBA 组织应该认真考虑使用`dbca.rsp`响应文件在静默模式下创建数据库的标准化。

您还可以在没有响应文件的情况下利用 DBCA，并完全提供所有参数来创建数据库。下面的`dbca`代码示例在`/oradata01`文件系统上创建一个名为`oraprod`的通用数据库，恢复区目标是`/fra01`文件系统。我们还创建了 500MB 大小的重做日志，并在`/oradata01`和`/fra01`文件系统中复用这些重做日志。我们已经禁用了 Enterprise Manager Express 配置，以支持将来进行 Oracle Enterprise Manager Cloud Control 12c 配置。我们已经用`initparams`参数设置了相关的初始化参数。

下面是创建数据库的`dbca`代码示例，包括设置相关的初始化参数:

`./dbca -silent \`

`-createDatabase \`

`-templateName General_Purpose.dbc \`

`-gdbName oraprod \`

`-createAsContainerDatabase false \`

`-emConfiguration none \`

`-datafileDestination ’/oradata01’ \`

`-recoveryAreaDestination ’/fra01’ \`

`-storageType FS \`

`-sid oraprod \`

`-SysPassword oracle123 \`

`-SystemPassword oracle123 \`

`-emConfiguration none \`

`-redoLogFileSize 500 \`

`-listeners LISTENER \`

`-registerWithDirService false \`

`-characterSet WE8ISO8859P1 \`

`-nationalCharacterSet AL16UTF16 \`

`-databaseType MULTIPURPOSE \`

`-initparams audit_file_dest=’/app/oracle/admin/oraprod/adump’ \`

`-initparams compatible=’12.1.0.2’ \`

`-initparams db_create_file_dest=’/oradata01’ \`

`-initparams db_create_online_log_dest_1=’/oradata01’ \`

`-initparams db_create_online_log_dest_2=’/fra01’ \`

`-initparams db_recovery_file_dest=’/fra01’ \`

`-initparams pga_aggregate_target=1024 \`

`-initparams diagnostic_dest=’/app/oracle’ \`

`-initparams parallel_max_servers=20 \`

`-initparams processes=500 \`

`-initparams sga_target=10240 \`

`-initparams control_files=’/oradata01/oraprod/control01.ctl’ \`

`-initparams db_recovery_file_dest_size=25000`

Note

反斜杠(\)是必需的，因为 DBCA 需要一个包含所有参数的单行命令。简而言之，反斜杠转义字符告诉 shell 忽略下一个字符。在本例中，反斜杠告诉 shell 忽略换行符，从而使整个脚本对 DBCA 来说显示为一行。

## 11-12.使用响应文件创建网络配置

### 问题

您很难在 GUI 模式下启动 Oracle Network Configuration Assistant(NETCA ),因为您的网络连接速度非常慢，或者因为您在一个非常安全的数据中心中处于多个防火墙之后。您希望在静默模式下使用 NETCA 创建一个数据库侦听器。

### 解决办法

您可以使用响应文件在静默模式下启动 NETCA。下面是一个示例响应文件，带有名为`netca.rsp`的修改:

`$ cat /tmp/net.rsp`

`[GENERAL]`

`RESPONSEFILE_VERSION="12.1"`

`CREATE_TYPE= "CUSTOM"`

`LOG_FILE=""/tmp/netca.log""`

`[Session]`

`ORACLE_HOME="/u01/app/oracle/product/12.1.0/dbhome_2"`

`[oracle.net.ca]`

`INSTALLED_COMPONENTS={"server","net8","javavm"}`

`INSTALL_TYPE=""custom""`

`LISTENER_NUMBER=1`

`LISTENER_NAMES={"LISTENER"}`

`LISTENER_PROTOCOLS={"TCP;1521"}`

`LISTENER_START=""`

`NAMING_METHODS={"LDAP","TNSNAMES","HOSTNAME"}`

`NSN_PROTOCOLS={"TCP;HOSTNAME;1521"}`

`NSN_NUMBER=3`

`NSN_NAMES={"DEV","DBATOOLS","RMANPROD"}`

`NSN_SERVICE = {"DEV","DBATOOLS","RMANPROD"}`

`NSN_PROTOCOLS={"TCP;rac5.dbaexpert.com;1521","TCP;rac6.dbaexpert.com;1521","TCP;rac7.dbaexpert.com;1521"}`

在静默模式下执行 NETCA 并传递修改后的响应文件`/tmp/net.rsp`会产生以下输出:

`$ netca -silent -responseFile /tmp/net.rsp`

`Sun May 17 07:20:03 CDT 2015 Oracle Net Configuration Assistant`

`Parsing command line arguments:`

`Parameter "silent" = true`

`Parameter "responsefile" = /tmp/net.rsp`

`Parameter "log" = /tmp/netca.log`

`Done parsing command line arguments.`

`Oracle Net Services Configuration:`

`Configuring Listener:LISTENER`

`Listener configuration complete.`

`Oracle Net Listener Startup:`

`Running Listener Control:`

`/u01/app/oracle/product/12.1.0/dbhome_2/bin/lsnrctl start LISTENER`

`Listener Control complete.`

`Listener started successfully.`

`Default local naming configuration complete.`

`Created net service name: DEV`

`Default local naming configuration complete.`

`Created net service name: DBATOOLS`

`Default local naming configuration complete.`

`Created net service name: RMANPROD`

`Profile configuration complete.`

`Oracle Net Services configuration successful. The exit code is 0`

在幕后，NETCA 在`$ORACLE_HOME/network/admin`目录中创建了三个文件:`sqlnet.ora`、`tnsnames.ora`和`listener.ora`。NETCA 的输出记录在`/tmp/netca.log`文件中。

### 它是如何工作的

尽管 DBA 通常没有意识到通过响应文件实现自动化的潜力，但是他们可以通过启动 NETCA 在一个命令中配置 Oracle 的网络拓扑。通过目录结构和命名约定的适当标准化，DBA 可以利用可执行文件(如`awk`和`sed`)编写脚本并操作网络配置响应文件。

您可以通过修改`LOG_FILE`参数为`netca`日志文件指定一个替代位置。与其他静默安装类似，您必须指定一个有效的`ORACLE_HOME`目录。需要解释的`netca`响应文件的其他部分是`NSN_`参数(NSN 代表服务名的数量)。参数`NSN_PROTOCOLS`为每个服务名定义了协议和相关参数。参数`NSN_NUMBER`定义了要创建的服务名的数量。对于这个特定的解决方案，响应文件定义了三个要在`tnsnames.ora`文件中创建的服务名。`TNSNAMES`连接字符串的名称定义为`DEV`、`RMANPROD`和`DBATOOLS`。所有三个`TNSNAMES`连接字符串都利用服务名。对于这个解决方案，您希望每个服务器都有`DBATOOLS`和`RMANPROD`的条目。

下面是`tnsnames.ora`文件的内容:

`$ cat tnsnames.ora`

`# tnsnames.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_2/network/admin/tnsnames.ora`

`# Generated by Oracle configuration tools.`

`RMANPROD =`

`(DESCRIPTION =`

`(ADDRESS_LIST =`

`(ADDRESS = (PROTOCOL = TCP)(HOST = rac7.dbaexpert.com)(PORT = 1521))`

`)`

`(CONNECT_DATA =`

`(SERVICE_NAME = RMANPROD)`

`)`

`)`

`DEV =`

`(DESCRIPTION =`

`(ADDRESS_LIST =`

`(ADDRESS = (PROTOCOL = TCP)(HOST = rac5.dbaexpert.com)(PORT = 1521))`

`)`

`(CONNECT_DATA =`

`(SERVICE_NAME = DEV)`

`)`

`)`

`DBATOOLS =`

`(DESCRIPTION =`

`(ADDRESS_LIST =`

`(ADDRESS = (PROTOCOL = TCP)(HOST = rac6.dbaexpert.com)(PORT = 1521))`

`)`

`(CONNECT_DATA =`

`(SERVICE_NAME = DBATOOLS)`

`)`

`)`

同样，NETCA 在`listener.ora`文件中生成了以下条目:

`$ cat listener.ora`

`# listener.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_2/network/admin/listener.ora`

`# Generated by Oracle configuration tools.`

`LISTENER =`

`(DESCRIPTION_LIST =`

`(DESCRIPTION =`

`(ADDRESS = (PROTOCOL = TCP)(HOST = dal66a)(PORT = 1521))`

`(ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))`

`)`

`)`

最后，NETCA 生成`sqlnet.ora`文件，其中包含定义目录路径的单个条目:

`NAMES.DIRECTORY_PATH= (LDAP, TNSNAMES, HOSTNAME)`

## 11-13.应用补丁程序集更新(PSU)和临时补丁

### 问题

您必须应用补丁程序集更新(PSU)或临时补丁来解决数据库问题或消除数据库中遇到的错误。

### 解决办法

大多数时候，应用补丁很简单，只需使用`opatch`命令行界面，该界面接受大量参数。`opatch`的语法如下:

`$ ./opatch -help`

`Oracle Interim Patch Installer version 12.1.0.1.7`

`Copyright (c) 2015, Oracle Corporation. All rights reserved.`

`Usage: opatch [ -help ] [ -report ] [ command ]`

`command := apply`

`compare`

`lsinventory`

`lspatches`

`napply`

`nrollback`

`rollback`

`query`

`version`

`prereq`

`util`

最常见的提供的`opatch`参数如下:

*   `apply`
*   `lsinventory`
*   `rollback`
*   `version`

我们以 2015 年 4 月补丁 20299023—数据库补丁集更新 12.1.0.2.3(包含 CPUApr2015)为例。您可以将补丁文件`p20299023_121020_Linux-x86-64.zip`下载到您的下载目录，并使用`unzip`命令提取压缩的归档文件。如果您想在不解压文件的情况下查看`.zip`文件的内容，请将`-l`参数传递给`unzip`命令。`unzip`命令将创建一个名为`20299023`的目录，并将所有文件提取到该目录中。

如果这是 Oracle 主目录上运行的第一个 PSU，或者您已经有一段时间没有打补丁了，那么您还必须下载并应用补丁 6880880，它恰好是 OPatch 的补丁更新。你必须从`support.oracle.com`下载补丁 6880880 或者跟随 [`https://updates.oracle.com/download/6880880.html`](https://updates.oracle.com/download/6880880.html) 的下载链接。

这种贴片非常容易使用。只需下载补丁，将 zip 文件上传到您的服务器，解压缩补丁的内容，并将`$ORACLE_HOME/OPatch`目录的内容替换为此补丁的`OPatch`解压缩目录。如果您正在为网格基础设施(GI)主目录应用这个补丁，那么您必须将`OPatch`目录的内容替换为 root。

对于大多数补丁，您可以阅读位于补丁基本目录中的`README.txt`文件，其中有关于如何应用补丁的明确说明。尽管大多数修补程序需要一个简单的`apply`参数，但有些修补程序有先决条件和修补后步骤。有些修补程序甚至需要执行多个依赖修补程序。

PSU 的`README.txt`文件将指示您必须读取`README.html`文件。一般来说，在应用任何补丁之前，必须关闭数据库。Oracle 确实提供了所谓的在线补丁，出于高可用性考虑，不必关闭数据库。您必须检查`README.txt`(或者在这种情况下，检查`README.html`文件)以查看某个特定补丁是否符合在线补丁的条件。因为这种特殊的 PSU 要求关闭数据库，所以您会遇到一个中断窗口来应用补丁。

`opatch`可执行文件位于`$ORACLE_HOME/OPatch`目录中。应用补丁最简单的方法是将`opatch`可执行文件包含到您的`PATH`环境变量中。为此，只需将您的`PATH`环境变量导出为`$ORACLE_HOME/OPatch:$PATH`。

Note

确保从未压缩的补丁子目录中以`oracle`帐户的身份运行命令`opatch apply`。此外，在运行`opatch`之前，必须相应地设置操作系统环境变量`ORACLE_HOME`。

目录已经更改为 20299023。基于`README.html`文件，您可以用命令`opatch apply`应用这个补丁。

下面是应用这种 PSU 的 OPatch 流程:

`$ opatch apply`

`Oracle Interim Patch Installer version 12.1.0.1.7`

`Copyright (c) 2015, Oracle Corporation.  All rights reserved.`

`Oracle Home       : /u01/app/oracle/product/12.1.0/dbhome_2`

`Central Inventory : /u01/app/oraInventory`

`from           : /u01/app/oracle/product/12.1.0/dbhome_2/oraInst.loc`

`OPatch version    : 12.1.0.1.7`

`OUI version       : 12.1.0.2.0`

`Log file location : /u01/app/oracle/product/12.1.0/dbhome_2/cfgtoollogs/opatch/opatch2015-05-16_17-48-29PM_1.log`

`Verifying environment and performing prerequisite checks...`

`OPatch continues with these patches:   19769480  20299023`

`Do you want to proceed? [y|n]`

`y`

`User Responded with: Y`

`All checks passed.`

`Provide your email address to be informed of security issues, install and`

`initiate Oracle Configuration Manager. Easier for you if you use your My`

`Oracle Support Email address/User Name.`

`Visit`[`http://www.oracle.com/support/policies.html`](http://www.oracle.com/support/policies.html)T2】

`Email address/User Name:`

`You have not provided an email address for notification of security issues.`

`Do you wish to remain uninformed of security issues ([Y]es, [N]o) [N]:  Y`

`Please shutdown Oracle instances running out of this ORACLE_HOME on the local system.`

`(Oracle Home = ’/u01/app/oracle/product/12.1.0/dbhome_2’)`

`Is the local system ready for patching? [y|n]`

`y`

`User Responded with: Y`

`Backing up files...`

`Applying sub-patch ’19769480’ to OH ’/u01/app/oracle/product/12.1.0/dbhome_2’`

`Patching component oracle.rdbms.deconfig, 12.1.0.2.0...`

`Patching component oracle.xdk, 12.1.0.2.0...`

`Patching component oracle.tfa, 12.1.0.2.0...`

`Patching component oracle.rdbms.util, 12.1.0.2.0...`

`Patching component oracle.rdbms, 12.1.0.2.0...`

`Patching component oracle.rdbms.dbscripts, 12.1.0.2.0...`

`Patching component oracle.xdk.parser.java, 12.1.0.2.0...`

`Patching component oracle.oraolap, 12.1.0.2.0...`

`Patching component oracle.xdk.rsf, 12.1.0.2.0...`

`Patching component oracle.rdbms.rsf, 12.1.0.2.0...`

`Patching component oracle.rdbms.rman, 12.1.0.2.0...`

`Patching component oracle.ldap.rsf, 12.1.0.2.0...`

`Patching component oracle.ldap.rsf.ic, 12.1.0.2.0...`

`Verifying the update...`

`Applying sub-patch ’20299023’ to OH ’/u01/app/oracle/product/12.1.0/dbhome_2’`

`ApplySession: Optional component(s) [ oracle.has.crs, 12.1.0.2.0 ]  not present in the Oracle Home or a higher version is found.`

`Patching component oracle.tfa, 12.1.0.2.0...`

`Patching component oracle.rdbms.deconfig, 12.1.0.2.0...`

`Patching component oracle.rdbms.rsf, 12.1.0.2.0...`

`Patching component oracle.rdbms, 12.1.0.2.0...`

`Patching component oracle.rdbms.dbscripts, 12.1.0.2.0...`

`Patching component oracle.rdbms.rsf.ic, 12.1.0.2.0...`

`Patching component oracle.ldap.rsf, 12.1.0.2.0...`

`Patching component oracle.ldap.rsf.ic, 12.1.0.2.0...`

`Verifying the update...`

`Composite patch 20299023 successfully applied.`

`Log file location: /u01/app/oracle/product/12.1.0/dbhome_2/cfgtoollogs/opatch/opatch2015-05-16_17-48-29PM_1.log`

`OPatch succeeded.`

现在检查清单，看看补丁是否存在。要查看补丁列表，请将`lsinventory`参数传递给`opatch`命令，如下所示:

`[oracle@dal66a 20299023]$ opatch lsinventory |grep ^Patch`

`Patch  20299023  : applied on Sat May 16 17:49:12 CDT 2015`

`Patch description:  "Database Patch Set Update : 12.1.0.2.3 (20299023)"`

在这个清单列表中，您正在对输出进行筛选，并寻找以单词`Patch`开头的行来确定应用的补丁。

Note

通过按 Shift+6 指定的`^`(插入符号)符号表示该行开头的元字符。通过从`opatch inventory`命令的输出中对`^Patch`进行过滤，您将查找以`Patch`开头的行的第一个字母，以检索仅已成功应用到 Oracle 主目录的补丁程序的高级摘要。

从输出中可以看到，12.0.1.2.3 PSU 应用于 Oracle 主目录。您可以执行命令`opatch lsinventory -detail`来生成所有补丁的详细输出。

你还没有完成。您仍然需要对利用此 Oracle 主目录的每个数据库执行补丁后操作。在使用 PSU 的 Oracle Database 11g 中，通过执行`catbundle.sql` SQL 脚本来修补数据库:

`SQL> @catbundle.sql psu apply`

从 Oracle Database 12c 开始，您必须从`$ORACLE_HOME/OPatch`目录执行`datapatch`脚本:

`$ cd $ORACLE_HOME/OPatch`

`$ ./datapatch –verbose`

`datapatch`取代了执行`catbundle.sql`脚本来应用数据库的数据库部分的需要。

### 它是如何工作的

OPatch 是 Perl 脚本和 Java 类的集合，提供了将 PSU 和临时(一次性)补丁应用和回滚到 Oracle 数据库环境的能力。`opatch`是调用 Perl 模块和 Java 类的主要驱动程序。尽管最低的`perl`要求是 5.005_03，Oracle 建议`perl`版本至少是 5.6 或更高。通过在补丁程序集 6880880 上执行简单搜索，可以从 MetaLink 的“补丁程序&更新”选项卡下载 OPatch。有关其他信息，请查看 MetaLink 简讯 224346.1。

OPatch 要求 Linux 服务器上有 Java 运行时环境(JRE)。此外，它对 Linux 服务器上的`jar`、`fuser`、`ar`、`make`等系统命令也有要求。补丁信息和备份驻留在`$ORACLE_HOME/.patch_storage/{patch_file}`目录中。

正如您可以使用`apply`参数安装补丁一样，您也可以使用`rollback`参数卸载补丁。`rollback`参数接受一个附加参数`-id`，以指定要回滚的补丁号。

在此示例中，您回滚了解决方案中应用的同一个修补程序:

`$ opatch rollback -id 20299023`

Oracle 提供 PSU 中已知错误和问题的最关键修复程序的累积季度补丁。我们鼓励客户应用 PSU 来避免许多已知问题。我们建议客户在 PSU 上应用 N-1。对于四月份，客户应申请一月份的 PSU。如果您的上线日期是很久以后，您可以应用最近的 PSU。

Oracle 提供其季度安全补丁更新(spu)，以前称为关键补丁更新(CPU)，以解决数据库和应用服务器产品的安全漏洞。非安全性修补程序通常包含在 CPU 中，因为它们是依赖修补程序。您可能会收到电子邮件通知您何时有更新可供下载。我们建议您仔细检查季度 spu，并及时应用它们。

Note

如果您有 GI 堆栈和 Oracle 数据库软件，GI 堆栈必须始终比 Oracle 数据库软件具有更高的版本、更高的补丁程序集和更高的 PSU。

## 11-14.克隆 Oracle 主目录

### 问题

您希望轻松地将完全修补的 Oracle 软件安装从一台数据库服务器克隆到另一台数据库服务器。您希望克隆过程是将软件简单地压缩和解压缩到新的服务器上，并从原始服务器上应用的所有补丁程序中充分受益。

### 解决办法

如果您碰巧是一名 DBA，并且仍然在创建 Oracle 二进制文件的`tar`档案，那么正如俗话所说，您可以继续鱼与熊掌兼得。复制 Oracle 二进制文件比从光盘或解压缩的媒体软件安装软件要容易得多，特别是如果源 Oracle 软件完全修补了最新版本的 Oracle PSUs/一次性补丁或一组已经过质量保证(QA)团队全面审查的补丁。

如果您的桌面和 Linux 服务器之间的 WAN 连接速度很慢，您可以用一个命令完成需要几个小时才能完成的工作。只需一个命令，您就可以提供一个完全打好补丁的 Oracle 软件堆栈，如果您的 Oracle 主目录安装了大量补丁，可能需要几天时间才能交付。如果您不喜欢静默安装选项，您还必须找到一个 X 服务器或 VNC 服务器，并为其设置`DISPLAY`环境变量。

在这个解决方案中，您将看到如何在使用`rcp` / `scp`、`tar`、zip/unzip 或`rsh` / `ssh`命令从另一台服务器传输二进制文件后克隆 Oracle 主目录。首先，将`ORACLE_HOME`环境变量设置为您刚刚复制的新目录。例如，这个解决方案的`ORACLE_HOME`环境变量被设置为`/app/oracle/product/12.1.0.2/db`。从`$ORACLE_HOME/clone/bin`目录中，执行如下所示的`perl`命令，将 Oracle 数据库软件克隆到新的数据库服务器:

`$ perl clone.pl ORACLE_HOME=/app/oracle/product/12.1.0.2/db ORACLE_HOME_NAME=12102_home_base ORACLE_BASE=/app/oracle/product -ignoreSysPrereqs -invPtrLoc /etc/oraInst.loc`

`./runInstaller -clone -waitForCompletion  "ORACLE_HOME=/app/oracle/product/12.1.0.2/db" "ORACLE_HOME_NAME=12102_home_base" "ORACLE_BASE=/app/oracle/product" -ignoreSysPrereqs  -invPtrLoc  /etc/oraInst.loc  -silent -paramFile /app/oracle/product/12.1.0.2/db/clone/clone_oraparam.ini`

`Starting Oracle Universal Installer...`

`Checking Temp space: must be greater than 500 MB.   Actual 29399 MB    Passed`

`Checking swap space: must be greater than 500 MB.   Actual 3967 MB    Passed`

`Preparing to launch Oracle Universal Installer from /tmp/OraInstall2015-02-12_02-57-31PM. Please wait ...You can find the log of this install session at:`

`/app/oracle/oraInventory/logs/cloneActions2015-02-12_02-57-31PM.log`

`..................................................   5% Done.`

`..................................................   10% Done.`

`..................................................   15% Done.`

`..................................................   20% Done.`

`..................................................   25% Done.`

`..................................................   30% Done.`

`..................................................   35% Done.`

`..................................................   40% Done.`

`..................................................   45% Done.`

`..................................................   50% Done.`

`..................................................   55% Done.`

`..................................................   60% Done.`

`..................................................   65% Done.`

`..................................................   70% Done.`

`..................................................   75% Done.`

`..................................................   80% Done.`

`..................................................   85% Done.`

`..........`

`Copy files in progress.`

`Copy files successful.`

`Link binaries in progress.`

`Link binaries successful.`

`Setup files in progress.`

`Setup files successful.`

`Setup Inventory in progress.`

`Setup Inventory successful.`

`Finish Setup successful.`

`The cloning of 12102_home_base was successful.`

`Please check ’/app/oracle/oraInventory/logs/cloneActions2015-02-12_02-57-31PM.log’ for more details.`

`Setup Oracle Base in progress.`

`Setup Oracle Base successful.`

`..................................................   95% Done.`

`As a root user, execute the following script(s):`

`1\. /app/oracle/product/12.1.0.2/db/root.sh`

`..................................................   100% Done.`

作为先决条件检查的一部分，克隆过程将确定在`/tmp`目录中是否有足够的空间，以及是否有足够的交换空间可供 Oracle 使用。克隆过程将重置各种 shell 脚本，并用本地主机信息修改元数据信息。

`invPtrLoc`是一个可选参数，指定包含`oraInventory`位置的完全限定文件名。在 RAC 环境中不应该使用`invPtrLoc`参数。默认情况下，`oraInst.loc`文件位于 Linux 操作系统的`/etc`目录中，如下所示:

`inventory_loc=/u01/app/oraInventory`

`inst_group=oinstall`

默认情况下，`inventory_loc`会指向`oracle`用户账号的`$ORACLE_BASE`目录下一级(当`ORACLE_BASE`为`/u01/app/oracle`时为`/u01/app/oraInventory`)。作为预防措施，您应该在附加 Oracle 主目录之前备份`oraInventory`目录。当你执行`root.sh`时，它也会在静默模式下执行`root.sh`。

### 它是如何工作的

数据库管理员仍然继续从一台服务器向另一台服务器卸载 Oracle 二进制文件。在一些公司中，尤其是非 RAC 环境中，DBA 使用一个命令将二进制文件从开发数据库服务器复制到 QA 和生产数据库服务器，比如将`tar`传送到`ssh`。

下面是一个流行的单行脚本，您可以利用它将 Oracle 二进制文件从 Oracle 主目录之上的一个目录级别复制到目标节点:

`tar cvf - {DIR_NAME} |ssh {target_node} "cd /apps/oracle/product/12.1.0.2; tar xvf -"`

Note

在将 Oracle 数据库软件从源数据库服务器复制到目标数据库服务器之前，不需要关闭数据库或监听程序。对于 GI 软件，您必须解锁 GI 软件堆栈，这将关闭集群。

通过管道传递给`ssh`的`tar`命令确保符号链接作为符号链接被复制。这种方法最好的一点是，您不必为了存储`tar`档案的本地和远程副本而招致双重存储。

克隆 Oracle Database 12c 时需要 Perl 版本 5.6 或更高版本。当将 Oracle 软件克隆到一个新的服务器上时，要确保满足所有的先决条件，因为 perl `clone.pl`进程不会验证它们。

从 Oracle Database 10g 开始，Oracle 支持从源服务器和目标服务器克隆 Oracle 主目录。目标服务器必须安装所有的 Linux 先决条件和软件包，以确保克隆过程成功。您可以将生产 Oracle 主目录克隆到较低的环境，如 QA 或 DEV 环境，以确保源和目标 Oracle 主目录中的所有补丁程序都是相同的。您可以战略性地定位克隆过程，以将数据库从当前版本升级到更高版本。例如，您可以将较新版本的 Oracle 主目录克隆到生产数据库服务器。在转换窗口期间，您可以简单地将 Oracle 主目录切换到较新的版本，并执行安装后脚本来升级数据库目录。

## 11-15.附加 Oracle 主目录

### 问题

您希望合并多个 Oracle 产品清单或重建/重新创建所有 Oracle 主目录的主产品清单，因为产品清单已损坏。

### 解决办法

从`$ORACLE_HOME/oui/bin`目录，您可以执行`attachHome.sh` shell 脚本。Oracle 提供了一个 shell 脚本来将 Oracle 主目录连接到`oraInventory`。`attachHome.sh`脚本有以下内容:

`$ cat attachHome.sh`

`#!/bin/sh`

`OHOME=/u01/app/oracle/product/12.1.0/dbhome_2`

`OHOMENAME=OraDB12Home1`

`CUR_DIR=`pwd``

`cd $OHOME/oui/bin`

`./runInstaller -detachhome ORACLE_HOME=$OHOME ORACLE_HOME_NAME=$OHOMENAME $* > /dev/null 2>&1`

`./runInstaller -attachhome ORACLE_HOME=$OHOME ORACLE_HOME_NAME=$OHOMENAME $*`

`cd $CUR_DIR`

执行`attachHome.sh`脚本会产生以下结果:

`$ ./attachHome.sh`

`Starting Oracle Universal Installer...`

`Checking swap space: must be greater than 500 MB.   Actual 4095 MB    Passed`

`The inventory pointer is located at /etc/oraInst.loc`

`’AttachHome’ was successful.`

根据`attachHome.sh` shell 脚本，在附加新的 Oracle 主目录之前，该脚本首先将 Oracle 主目录与`oraInventory`分离。在 Oracle 的早期版本中，runInstaller 程序使用`–attachHome`选项执行，并提供 Oracle 主目录位置和 Oracle 主目录名，如下所示:

`$ ./runInstaller -silent -attachHome ORACLE_HOME="/u01/app/oracle/product/12.1.0/dbhome_2" ORACLE_HOME_NAME=" OraDB12Home1"`

`Starting Oracle Universal Installer...`

`Checking swap space: must be greater than 500 MB.   Actual 8174 MB    Passed`

`The inventory pointer is located at /etc/oraInst.loc`

`’AttachHome’ was successful.`

您甚至可以通过指定一个名为`CLUSTER_NODES`的附加参数来附加 RAC Oracle 主目录，该参数必须用花括号括起来，如下所示:

`CLUSTER_NODES={rac3,rac4}`

### 它是如何工作的

执行`attachHome.sh` shell 脚本，将 Oracle 主目录附加到 Oracle 中央清单。您必须从每个 Oracle 主目录执行`attachHome.sh`脚本。成功附加新的 Oracle 主目录后，您可以查看`inventory.xml`文件的内容，以确认新的 Oracle 主目录已列出。

如前所述，`oraInventory`目录位置位于`$ORACLE_BASE`的下一层。下面是`inventory.xml`文件的样子:

`$ cat $ORACLE_BASE/../oraInventory/ContentsXML/inventory.xml`

`<?xml version="1.0" standalone="yes" ?>`

`<!-- Copyright (c) 1999, 2014, Oracle and/or its affiliates.`

`All rights reserved. -->`

`<!-- Do not modify the contents of this file by hand. -->`

`<INVENTORY>`

`<VERSION_INFO>`

`<SAVED_WITH>12.1.0.2.0</SAVED_WITH>`

`<MINIMUM_VER>2.1.0.6.0</MINIMUM_VER>`

`</VERSION_INFO>`

`<HOME_LIST>`

`<HOME NAME="OraDB12Home1" LOC="/u01/app/oracle/product/12.1.0/dbhome_2" TYPE="O" IDX="1"/>`

`</HOME_LIST>`

`<COMPOSITEHOME_LIST>`

`</COMPOSITEHOME_LIST>`

`</INVENTORY>`

您可以看到`OraDB12Home1`的`ORACLE_HOME_NAME`在 XML `inventory`文件中被列为成员。