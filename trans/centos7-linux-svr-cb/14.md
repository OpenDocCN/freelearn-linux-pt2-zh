# 第十四章。使用 SELinux

在本章中，我们将涵盖以下主题:

*   安装和配置重要的 SELinux 工具
*   使用 SELinux 安全上下文
*   使用策略
*   SELinux 故障排除

# 简介

本章是一个努力揭开**安全增强 Linux** ( **SELinux** )神秘面纱的食谱集合，这是一种成熟的技术，通过在基本安全系统中添加额外的安全特性来强化您的 Linux 系统。它在 CentOS 世界中已经存在了很多年，但是对于许多系统管理员来说，它仍然是一个鲜为人知且令人困惑的话题。

# 安装和配置重要的 SELinux 工具

任何 Linux 系统最显著的安全特性是提供访问控制——通常称为 **自主访问控制**(**DAC**)——允许对象(如文件)的所有者为其设置安全属性(例如，使用`chown`和`chmod`命令决定谁可以读取或写入文件)。虽然这种古老且非常简单的安全系统在古代 UNIX 时代已经足够了，但它并不能满足所有现代的安全要求，在现代，服务器和服务不断连接到互联网。

通常，攻击者可以利用有缺陷或配置错误的应用程序以及对它们的权限来启动安全漏洞。这就是 SELinux 被开发出来的原因。其主要目的是增强 Linux 下 DAC 系统的安全性。它是通过在数模转换器之上增加一个额外的安全层来实现的，这个安全层被称为 **【强制访问控制】** ( **MAC** )，它可以为系统的每个组件提供细粒度的访问控制。SELinux 已经在 CentOS 7 上启用，绝对推荐任何直接连接到互联网的服务器使用。在这个食谱中，我们将安装额外的工具并配置它们，以更好地管理您的 SELinux 系统，并帮助进行故障排除和监控过程。

## 做好准备

要完成此食谱，您将需要一个具有超级用户权限的 CentOS 7 操作系统的工作安装和一个到互联网的连接，以便下载额外的软件包。为了获得最佳的学习体验，您最好按照它们出现的顺序逐个学习本章的配方，因为它们是相互建立的。

## 怎么做...

在本书中，我们已经应用了一些程序来管理我们的 SELinux 环境，比如来自`rpm` `policecoreutils-python`包的`semanage`。如果您错过了安装，我们将从安装开始(如果您之前已经安装过，请跳过步骤 1):

1.  以 root 用户身份登录，安装以下基本工具包以使用 SELinux:

    ```
    yum install policycoreutils-python

    ```

2.  现在，我们需要一些额外的工具，这些工具也将在本章后面的课程中用到:

    ```
    yum install setools setools-console setroubleshoot*

    ```

3.  接下来，安装并配置 SELinux 手动页面，因为它们在 CentOS 7 上默认不可用，但对于以后获取有关特定策略、安全上下文和 SELinux Booleans 的详细信息很重要。首先，我们需要安装另一个包:

    ```
    yum install policycoreutils-devel

    ```

4.  然后，让我们为系统上当前可用的所有 SELinux 安全上下文策略生成所有手册页，然后更新手动页面数据库:

    ```
    sepolicy manpage -a -p /usr/share/man/man8; mandb

    ```

## 它是如何工作的...

按照这个方法，我们安装了 SELinux 日常工作所需的所有工具。此外，我们生成了所有可用的 SELinux 手动页面，这将是我们在使用 SELinux 时的主要信息来源，也是以后对 SELinux 服务进行故障排除的主要信息来源。

SELinux 有两个主要的和基本的术语，在进入本章剩余的食谱之前，我们需要了解它们:**标签**(或者更确切地说，安全上下文)和 **策略**。从 SELinux 的角度来看，一个 Linux 系统被分成许多不同的对象。例如，对象是系统中的所有文件、进程、用户、套接字和管道。在 SELinux 上下文中，每个这样的对象都有一个特殊的标签。SELinux 策略是使用在这些对象上定义的标签来控制对这些对象的访问的规则:在对这样的对象的每次访问尝试(例如，文件读取)时，如果有针对特定标签的规则来做出访问控制决定(允许或拒绝访问)，则将搜索系统可用的所有 SELinux 策略。

那么，我们从这次经历中学到了什么？

许多系统管理员似乎像躲避瘟疫一样躲避 SELinux*，许多说明手册和教程中的一种趋势倾向于在安装 CentOS 7 后立即完全禁用它，因为人们似乎害怕它，不想惹它，或者如果某些网络服务不能开箱即用地正常工作，他们甚至会感到沮丧。通常，他们会将任何连接问题归咎于 SELinux，因此，与其通过深入研究 SELinux 的内部工作机制来找出真正的原因，不如完全禁用它看起来更容易。如果您禁用它，您就错过了 CentOS 7 最关键的安全功能之一，该功能可以在发生攻击时防止对您的系统造成大量伤害！在过去的几年里，SELinux 项目有了很大的发展，比以往任何时候都更容易使用。已经出现了许多方便的工具来使用它，我们获得了更多完整的策略集来处理所有可用的主要应用程序和服务。通过安装这些工具，我们现在可以使用 SELinux，并以最方便的方式使用它。*

 *## 还有更多...

说到 SELinux，有三种不同的模式。虽然 **增强**是唯一真正保护我们并增强我们服务器安全性的模式，但还有另外两种模式:**禁用** 和 **许可**。Disabled 意味着 SELinux 被关闭，这在本书中永远不会成为我们的选项，也不会进一步讨论，因为摆脱这个神奇的 CentOS 功能没有任何意义。禁用时，我们的系统不会被 SELinux 增强，而良好的旧数模转换器系统是我们手头唯一的保护来源。许可模式意味着 SELinux 已打开，策略规则已加载，并且所有对象都标记有特定的安全上下文，但系统并未强制实施这些策略。这就像很多基于 Linux 的命令行工具都有的一个模拟运行参数:它在 SELinux 增强的安全保护下模拟系统，并且系统会像真实运行时一样记录每个 SELinux 策略违规。这是调试系统或分析正常、强制运行对系统造成的后果的好方法。

通常，如果您不确定使用 SELinux 的影响，就会使用它。由于这种模式并没有真正为我们提供任何额外的安全性，如果我们想要增强安全性，我们最终需要切换到**强制**模式！同样，这是保护我们的唯一模式；SELinux 在加载了所有策略的情况下完全运行，并在系统上实施这些规则。您应该始终瞄准任何系统上的强制模式！要查看当前模式，使用命令`sestatus`。我们可以在输出中的`Current mode`行看到当前的 SELinux 模式。在 CentOS 7 上，SELinux 默认处于强制模式，这再次告诉我们系统受到它的完全保护。要将此模式更改为许可模式，请使用命令`setenforce` `permissive`。现在，再次使用`sestatus`验证您的设置。要将您的更改恢复到强制模式，请使用`setenforce enforcing`。使用`setenforce`设置 SELinux 模式只是暂时设置，重启后不会存活(看一下`sestatus`输出中的`Mode from config`文件)。要永久更改，请打开`/etc/selinux/config`文件并更改`SELINUX=`配置参数。

# 使用 SELinux 安全上下文

正如我们从本章前面的食谱中了解到的，SELinux 完全是关于标签和政策的。在本食谱中，我们将向您展示如何使用这些标签，也称为安全上下文。

## 做好准备

要完成此方法，您将需要具有 root 权限的 CentOS 7 操作系统的有效安装。假设您正在逐个配方地完成本章，那么到目前为止，您应该已经安装了上一个配方中的 SELinux 工具，并为策略生成了所有 SELinux 手册页。正如您可能注意到的，我们将在本食谱中向您展示的一些命令已经在本书的其他食谱中得到应用。我们将在这里详细解释它们。要使用`netstat`程序，用 YUM 包管理器安装包`net-tools`。

## 怎么做...

正如我们在前面的食谱中所了解到的，SELinux 系统中的几乎每个组件都是一个对象(文件、目录、进程、用户等等)。我们将首先向您展示如何使用`-Z`命令行标志打印出各种对象的 SELinux 标签，SELinux 系统上的许多基本 Linux 命令都支持该标志。

1.  首先，以 root 用户身份登录，并键入以下命令，从各种对象中探索 SELinux 安全上下文信息:

    ```
    id -Z
    ls -Z
    ps -auxZ
    netstat -tulpenZ

    ```

2.  接下来，要列出系统上文件和目录的所有可用安全上下文名称，请使用以下命令(我们只过滤了`httpd`标签):

    ```
    semanage fcontext -l | grep httpd

    ```

3.  接下来，让我们创建一个新的空文件，我们可以使用:

    ```
    touch /tmp/selinux-context-test.txt

    ```

4.  显示新文件的当前安全上下文(应包含类型`user_tmp_t` ):

    ```
    ls -Z /tmp/selinux-context-test.txt

    ```

5.  最后，将`user_tmp_t`类型改为随机的`samba_share_t`标签名称:

    ```
    semanage fcontext -a -t samba_share_t /tmp/selinux-context-test.txt
    restorecon -v /tmp/selinux-context-test.txt

    ```

6.  执行测试以验证您的更改:

    ```
    ls -Z /tmp/selinux-context-test.txt

    ```

## 它是如何工作的...

在这个食谱中，我们向您展示了如何显示各种 SELinux 对象类型的标签(安全上下文)，如何显示所有可用的标签名称，以及如何在文件对象的示例中修改或设置它们。日常使用 SELinux 增强系统时，大多数管理员会确认我们必须管理的最重要的对象是文件、目录和进程。另外，您需要记住每个 SELinux 对象只能有一个安全上下文。

那么，我们从这次经历中学到了什么？

正如我们已经看到的，我们可以在许多不同的标准 Linux 命令行工具上使用`-Z`参数来打印出它们的 SELinux 安全上下文。这里，我们向您展示了显示用户、文件和目录、进程和网络连接的标签的示例，我们可以使用`id`、`ls`、`ps`和`netstat`命令进行查询。在这些命令的输出中，我们看到每个这样的对象的每个安全上下文标签由三个值组成:用户(由`_u`标记)、角色(`_r`)和类型(`_t`)。在标准的 SELinux 类型中，类型字段被用作做我们所有访问控制决策的主要机制(这被称为目标)，所以我们经常称整个 SELinux 访问控制过程为 **类型强制** ( **TE** )。

对象标签中的其他值用户和角色只是非常高级的 SELinux 配置所必需的，这里不讨论。为了显示在我们的系统上使用的所有可用的上下文类型，使用命令行`seinfo -t`。这些 SELinux 类型是我们需要理解的一个非常重要的概念。对于文件和目录对象，它们用于*将彼此相关的对象组捆绑在一起，并且应该受到相同的保护或处理，以便我们可以对它们定义特定的策略规则。例如，我们可以在标准邮件假脱机目录`/var/spool/mail`中分配类型为`mail_spool_t`的每个文件，然后创建一个访问规则策略，在该策略中我们将使用该类型来允许特定的访问。在进程的上下文中，类型值称为域。在这里，类型被用作隔离和*沙箱*进程的一种方式:任何具有指定域名的进程只能与同一域中的其他进程通信和交互(有一些例外，如这里没有讨论的转换)。这种通过域隔离进程的*大大降低了安全风险。当流程受到损害时，它们只会损害自己，而不会损害其他任何东西。**

### 注

SELinux 有时被称为沙盒系统。从软件总是会有 bug 的假设出发，SELinux 提供了隔离软件组件的方法，这样一个组件中的漏洞不会危及另一个组件。

如果输入`ps -auxZ`，还会看到有进程运行在名为`unconfined_t`的域中。使用此标签运行的进程不受 SELinux 策略的保护，这意味着，如果未受限制的进程受到危害，SELinux 不会阻止攻击者访问其他系统资源和数据。在这里，安全性回到标准的数模转换器规则，这将是你唯一和排他性的保护。

在我们讨论了如何显示安全上下文之后，接下来我们向您展示了如何设置和更改它们。在一些较旧的文档以及一些 SELinux 策略`man`页面中，您会遇到名为`chcon`的工具的例子，该工具用于修改对象的安全上下文。这个工具的使用不再是推荐的方法，你应该总是用更新的`semanage fcontext -a -t`命令行结合`restorecon`程序来替换这样的命令行例子。对于`semanage`，您提供带有`-t`的标签类型名称，然后提供您想要为其设置的文件名。然后，通过`restorecon`，您可以提供您想要应用`semanage`之前所做更改的文件名。这是必要的，因为安全上下文可以在两个级别上设置。它可以设置为策略和文件系统级别。`chcon`命令直接在文件系统上设置新的上下文，而策略上下文不会改变。这可能是一个问题，例如，如果您希望稍后重置或更改文件系统的安全上下文(这称为重新标记)，这意味着所有安全上下文都将从策略应用到文件系统，覆盖您用`chcon`所做的所有更改。因此，最好使用`semanage`，它将写入策略，然后使用`restorecon`，它将策略标签同步到文件系统，保持一切最新。如果要为目录而不是单个文件设置标签，可以使用正则表达式；查看一些示例和更多命令行选项；键入`man semanage-fcontext`并浏览至`EXAMPLES`部分。

# 与政策合作

每个 SELinux 系统的核心是政策。这些是定义所有对象之间的访问权限和关系的确切规则。正如我们之前所了解的，我们系统的所有对象都有标签，其中一个标签是类型标识符，可以用来强制执行策略制定的规则。在每个启用 SELinux 的系统中，默认情况下，禁止对任何对象的所有访问，除非已经定义了策略规则。在这里，我们将向您展示如何查询和定制 SELinux 策略。正如您可能注意到的，一些命令已经在本书的其他配方中应用，例如`httpd`或`ftpd`守护程序。在这里，你会发现政策是如何运作的。

## 做好准备

要完成此方法，您将需要具有 root 权限的 CentOS 7 操作系统的有效安装。假设您正在逐个配方地完成本章，那么到目前为止，您应该已经安装了上一个配方中的 SELinux 工具，并为策略生成了所有 SELinux 手册页。对于我们在这里的测试，我们将使用 Apache 网络服务器，因此请确保它已安装并在您的系统上运行(请参考[第 12 章](12.html#2TEN41-4cf34a6d07944734bb93fb0cd15cce8c "Chapter 12. Providing Web Services")、*提供网络服务*中的食谱*安装 Apache 并提供网页*)。

## 怎么做...

1.  首先，以 root 用户身份登录，并键入以下命令以显示所有 SELinux 布尔策略设置，这些设置仅由`httpd`守护程序过滤:

    ```
    semanage boolean -l | grep httpd

    ```

2.  要获得关于特定策略及其包含的布尔值的更多信息，请阅读相应的手册页；例如，对于`httpd`键入以下内容:

    ```
    man httpd_selinux

    ```

3.  在这里，在`httpd`策略的手册页中，我们将找到关于每个可用的`httpd`策略布尔的详细信息。比如有一节是关于`httpd_use_nfso`的。要切换单个策略功能，请使用`setsebool`命令以及带有`on`或`off`参数的策略布尔名称，如下所示:

    ```
    setsebool httpd_use_nfs on
    setsebool httpd_use_nfs off

    ```

## 它是如何工作的...

在这个食谱中，我们向您展示了如何使用 SELinux Booleans。请记住，SELinux 遵循最小特权模型，这意味着 SELinux 策略只为任何对象启用最少的功能；像系统服务一样，他们需要执行他们的任务，仅此而已。可以在运行时使用相应的 SELinux Booleans 来控制(激活或停用)策略的这些特性，而无需了解策略编写的内部工作原理。这是一个使策略可定制且极其灵活的概念。在本书的其他食谱中，我们已经使用了启用 SELinux Booleans 来添加特殊的策略功能，例如启用 Apache 或 FTP 主目录，默认情况下这些都是禁用的。

我们从这次经历中学到了什么？

SELinux Booleans 就像开关，用于启用或禁用 SELinux 策略中的某些功能。我们使用`semanage`命令来显示系统上所有可用的 Booleans，并通过`http`进行过滤，只获取与该服务相关的 Booleans。如你所见，你的系统中有大量Booleans 可用，大部分被禁用或关闭(最小特权模式)；要获得关于特定策略及其布尔值的更多信息，请使用我们在以前的配方中安装的 SELinux 手册页。有时，很难找到感兴趣的特定手册页。使用以下命令搜索可用的手册页名称:`man -k _selinux | grep http`。在我们的示例中，`httpd_selinux`是获取有关`httpd`政策的详细信息的正确手册页。最后，如果我们决定切换特定的 SELinux 布尔特征，我们将使用`setsebool`命令。您应该记住，以这种方式设置 Booleans 只在重新启动之前有效。要使这些设置永久化，请使用`-p`标志，例如`setsebool -P httpd_use_nfs on`。

## 还有更多...

到目前为止，我们从之前的食谱中获得了所有的知识，现在我们能够展示一个我们将所有东西放在一起的例子。在这里，我们将看到 SELinux 安全上下文和策略在`httpd`服务中的作用。如果 Apache 网络服务器正在运行，我们可以使用下面的行获得`httpd`进程的 SELinux 域名:

```
ps auxZ | grep httpd

```

这将向我们展示`httpd`域(类型)被称为`httpd_t`。要获取我们的 web 根目录的 SELinux 标签，请键入以下命令:

```
ls -alZ /var/www/html

```

这将告诉我们，我们的 Apache 网络服务器的网络根目录的安全上下文类型被称为`httpd_sys_content_t`。现在，有了这些信息，我们可以从我们的策略中获得 Apache 域的确切规则:

```
sesearch --allow | grep httpd_t

```

这将打印出所有可用的`httpd`策略规则。如果我们过滤`httpd_sys_content_t`上下文类型的输出，下面一行将再次出现文件:

```
allow httpd_t httpd_sys_content_t : file { ioctl read getattr lock open } 

```

这向我们显示了哪个源目标上下文被允许访问，哪个目标目标上下文，以及哪些访问权限。在我们的 Apache 网络服务器示例中，这指定了作为域`httpd_t`运行的`httpd`进程可以访问、打开和修改文件系统上与`httpd_sys_content_t`上下文类型匹配的所有文件(在`/var/www/html`目录中的所有文件都与该标准匹配)。现在，为了验证这个规则，创建一个临时文件并将其移动到 Apache web 根目录:`echo "CentOS7 Cookbook" > /tmp/test.txt;mv /tmp/test.txt /var/www/html`。任何文件都会继承创建它的目录的安全上下文。如果我们直接在 web 根目录中创建文件，或者复制文件而不是移动它(复制意味着创建副本)，它将自动处于正确的`httpd_sys_content_t`上下文中，并且可以被 Apache 完全访问。但是，当我们从`/tmp`目录移动文件时，它将作为`user_tmp_t`类型留在 web 根目录中。如果您现在尝试获取网址，例如，`curl http://localhost/test.txt`，您应该会收到一条 403 禁止消息。这是因为`user_tmp_t`类型不是文件对象的`httpd_t`策略规则的一部分，因为如前所述，策略规则中未定义的所有内容都会被默认阻止。为了使文件可访问，我们现在将其安全上下文标签更改为正确的类型:

```
semanage fcontext -a -t httpd_sys_content_t /var/www/html/test.txt
restorecon -v /var/www/html/test.txt

```

现在，再次获取`curl http://localhost/test.txt`，应该是可访问的，并打印出正确的文本:CentOS7 食谱。

请记住，如果复制文件，安全上下文类型将从目标父目录继承。如果要在复制时保留原上下文，请使用`cp -preserve=context`代替。

# 排除 SELinux 故障

在本食谱中，您将学习如何对 SELinux 策略进行故障排除，当对某些 SELinux 对象的访问被拒绝时，这是最常需要的，您需要找出原因。在本食谱中，我们将向您展示如何使用`sealert`工具，该工具将创建人类可读和可理解的错误消息来使用。

## 做好准备

要完成此方法，您将需要具有 root 权限的 CentOS 7 操作系统的有效安装。假设您正在一个接一个地使用本章的方法，那么现在您应该已经安装了 SELinux 工具并在本章中应用了*使用策略*方法，因为我们将产生一些 SELinux 拒绝事件，以便向您展示如何使用日志文件工具。

## 怎么做...

1.  首先，以 root 用户身份登录并引发 SELinux 拒绝事件:

    ```
    touch /var/www/html/test2.html
    semanage fcontext -a -t user_tmp_t /var/www/html/test2.html
    restorecon -v /var/www/html/test2.html
    curl http://localhost/test2.html

    ```

2.  现在，让我们生成一个最新的人类可读日志文件:

    ```
    sealert -a /var/log/audit/audit.log

    ```

3.  在程序的输出中，您将获得任何 SELinux 问题的详细描述，在每个所谓的警报结束时，您甚至会找到一个建议的解决方案来修复问题；在我们的示例中，感兴趣的警报应该为(输出被截断)，如下所示:

    ```
    SELinux is preventing /usr/sbin/httpd from open access on the file /var/www/html/test2.html.
    /var/www/html/test2.html default label should be httpd_sys_content_t

    ```

## 它是如何工作的...

在本食谱中，我们向您展示了如何使用`sealert`程序轻松解决 SELinux 问题。我们首先通过在 web 根目录中创建一个新文件并为其分配一个错误的上下文类型值`user_tmp_t`，引发了 SELinux 拒绝访问问题，该值没有在`httpd`策略中定义的访问规则。然后，我们使用`curl`命令尝试获取网站，并在SELinux 日志中实际生成**访问向量缓存** ( **AVC** ) 拒绝消息。当 SELinux 拒绝访问时，会记录拒绝消息。存储所有 SELinux 日志信息的主要来源是审核日志文件，可在`/var/log/audit/audit.log`找到，更容易阅读的拒绝消息也将写入`/var/log/messages`。这里，我们使用`sealert`工具，而不是手动清除错误消息并合并两个日志文件，这是一个方便的程序，它将解析审计和消息日志文件，并以人类可读的格式呈现有价值的 AVC 内容。在每条警报消息的末尾，您还会找到一个建议的问题解决方案。请注意，这些是自动生成的消息，在应用之前应该始终询问。*