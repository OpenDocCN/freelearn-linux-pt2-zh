# 第四章。用 YUM 管理包

在本章中，我们将涵盖以下主题:

*   使用 YUM 更新系统
*   使用 YUM 搜索包
*   使用 YUM 安装软件包
*   使用 YUM 删除包
*   保持 YUM 干净整洁
*   知道你的优先事项
*   使用第三方存储库
*   创建 YUM 存储库
*   使用转速包管理器

# 简介

本章是一个食谱的集合，提供了增长服务器所需工具的回顾。包管理是任何基于 Linux 的系统的核心，本章的目的是强调在基于 CentOS 的服务器上管理软件包所需的关键工具。

# 使用 YUM 更新系统

在本食谱中，我们将研究**黄狗更新程序**、**修改后的** ( **YUM** )包管理器在运行系统更新方面的作用。每隔一段时间，你可能会意识到一个更新，或者只是希望发现一个是否存在。对每个服务器管理员来说，应用补丁和更新是一项常规任务，而一个最新的系统可以帮助提高或确保您的服务器的安全性，因为软件错误和漏洞总是被发现，并且必须立即修复。在这个食谱中，你将学习如何在 YUM 的帮助下实现这一点。

## 做好准备

要完成此方法，您需要安装具有 root 权限的 CentOS 7 操作系统、您选择的基于控制台的文本编辑器以及互联网连接，以便于下载其他软件包。

## 怎么做...

您可以根据需要经常运行此配方，但应根据您自己选择的时间表频繁运行，因为您完全知道有时某些更新可能需要完全重新启动系统:

1.  以 root 用户身份登录，检查您安装的软件包是否有任何更新。为此，请登录并键入以下内容:

    ```sh
    yum check-update

    ```

2.  如果没有可用的更新，则更新过程将结束，不需要做进一步的工作。但是，如果有可用的更新，YUM 现在将返回一个列表，其中包含系统已知的存储库中的所有包更新。要完成更新过程，请键入以下命令:

    ```sh
    yum -y update

    ```

3.  通过使用`-y`标志，前面的命令现在将绕过确认交易摘要的需要，并且您的系统现在将经历立即更新过程。完成后，您将获得一份最终报告，确定安装了哪些依赖项以及更新了哪些软件包。
4.  Generally speaking, no further work is required and you may resume typical operations. However, if a new kernel has been installed, or an important security update has taken place, it may be necessary to reboot the system for the new changes to take effect. To do this, type the following:

    ```sh
    reboot

    ```

    ### 注

    虽然在实践中对于更新是否需要完全系统重启有很多争论，但这只是在内核更新后才考虑，内核更新是对`glibc`和在引导过程中激活的特定基于安全的功能的更新。

## 它是如何工作的...

YUM 是 CentOS 的默认包管理系统，它的部分作用是自动计算哪些包可能需要更新，需要哪些依赖项，并以非常简单的方式管理更新系统的整个过程。

那么，我们从这次经历中学到了什么？

我们通过使用带有`check-update`选项的`yum`命令检查我们的系统是否有任何更新来启动食谱。这样，YUM 现在将检查一个中央存储库，以确认更新是否适用于我们的系统。存储库是包含准备好的软件包和实用程序的远程目录或网站。YUM 将使用该工具自动定位并获取正确的**红帽包管理器** ( **RPM** ) 和依赖项，如果有更新可用，那么 YUM 将相应地做出响应，提供可用包和依赖项的完整摘要。因此，YUM 是一个非常有用的工具，毫无疑问，它的机制确实有助于简化与包管理相关的过程，因为它可以与存储库对话，这使我们不必手动查找和安装新的应用程序或更新。如果有可用的更新，输出将显示哪些包受到影响，然后我们可以使用百胜的`update`参数继续更新系统。在这种情况下，前面的命令包括`-y`标志。这样做是为了避免需要同意给出的交易摘要，并确认我们已经同意在运行之前的检查后进行这些更新。否则，您只需使用 *Y* 键确认请求即可。

## 还有更多...

您也可以使用 update 参数来更新单个程序包，而不是整个系统，方法是提供程序包名称，如 so: `yum update package_name`。YUM 将用于确保在安装过程中满足应用程序的所有要求，并且它将自动为系统中尚未存在的任何依赖项安装软件包。然而，我相信你会很高兴听到这一点，如果一个新的应用程序有与现有软件相冲突的要求，YUM 将中止该过程，而不会对您的系统进行任何更改。如果您想使用特定的时间间隔自动更新您的系统，您可以安装`yum-cron`包，它可以高度定制，但不在本书的范围内。安装后，使用`man yum-cron`启动。

# 使用 YUM 搜索包裹

在这个食谱中，我们将调查使用 YUM 找到一个包的作用。YUM 是为了改进 RPM 软件包的安装而开发的，它用于访问越来越多的软件包，这些软件包提供了您的服务器提供的全套服务。YUM 使用起来很简单，但是如果你不确定一个包叫什么，那么你作为服务器管理员的职责可能会变得更难。为了克服这一点，YUM 维护了广泛的发现工具，本食谱的目的是向您展示如何使用该功能来搜索各种存储库并找到您需要的包。

## 做好准备

要完成此方法，您将需要具有 root 权限的 CentOS 7 操作系统的工作安装、您选择的基于控制台的文本编辑器以及到互联网的连接。

## 怎么做...

这个食谱将向您展示如何通过调用 YUM 的搜索选项来找到一个或多个包。为此，您需要以 root 用户身份登录并完成以下过程:

1.  要搜索单个包，用适当的短语、字符串或参数替换`keyword`值，并键入以下内容:

    ```sh
    yum search keyword

    ```

2.  等待搜索结果汇总，生成列表后，只需将`package_name`替换为适当的值:

    ```sh
    yum info package_name

    ```

    ，即可查询显示的任意包
3.  如果上述结果令人满意，并且您想要查看与所讨论的包相关联的依赖项列表，请键入以下内容:

    ```sh
    yum deplist package_name

    ```

## 它是如何工作的...

用百胜搜索包裹的方法和你在 **环球网** ( **WWW** 上搜索任何东西的方法一样。您可以搜索的单词类型可以是您喜欢的特定类型，也可以是通用类型。它们甚至可以由完整的或部分的单词组成；找到一个你可能感兴趣的包后，你会注意到这个食谱也向你展示了如何发现关于这个包的额外信息。

那么，我们从这次经历中学到了什么？

百胜保留了广泛的搜索功能，允许你通过关键词、包名和路径名查询包。例如，如果您想找到编译 C、Objective-C 和 C++代码的正确包，可以使用`yum search compiler` 查询。当在命令行上使用这些搜索词时，会有许多相关的结果，每个包都带有一个简短的描述，使我们能够使用一个简单的消除过程来选择最明显或最相关的值。考虑到这一点，您可以使用`info`参数查询 YUM，以了解某些包的更多信息。此选项显示了完整的包详细信息，以及包打算提供的功能的详细描述。一般来说，你可能不需要知道任何进一步的细节。

但是，可能有些情况下，你想知道这个包是如何与整个服务器交互的(尤其是当你正在处理源安装或故障排除损坏的包时)，所以我们可以使用 YUM 的`deplist`参数，该参数可以给出相当详细的报告；如果您碰巧有任何损坏的包，您可以简单地使用这个输出来详细说明您可能需要或不需要安装哪些依赖项来修复底层问题。当调试依赖项或使用基于源代码的安装时，此命令特别有用。

## 还有更多...

有时，您可能不想搜索特定的包，相反，您可能更喜欢以目录样式的格式显示存储库的内容。同样，这很容易做到，YUM 通过以下命令提供了这一功能。如果您想简单地列出系统当前使用的所有可用软件包，请键入`yum list all`。但是，因为这个列表可能非常详尽，所以您可能更喜欢使用`yum list all | less`来浏览结果。以类似的方式，如果你想简单地列出所有当前安装在你的系统上的软件，键入`yum list installed | less`。如果您想确定哪些包提供了特定的文件或功能，只需随时运行以下命令，用与您自己的需求更相关的东西替换`your_filename_here`:`yum provides your_filename_here`。

# 使用 YUM 安装软件包

在本食谱中，我们将调查 YUM 在您的服务器上安装新软件包中的作用。每个服务器管理员的一项重要任务是安装应用程序和服务。有几种不同的方法可以实现这一点，但最有效的方法涉及 YUM 包管理器。YUM 能够搜索任意数量的存储库，自动解决包依赖关系，并指定一个或多个包的安装。YUM 是一种在服务器上安装软件包的现代而明确的方法，这个食谱的目的是向您展示它是如何完成的。

## 做好准备

要完成此方法，您需要安装具有 root 权限的 CentOS 7 操作系统、您选择的基于控制台的文本编辑器以及互联网连接，以便于下载其他软件包。如果你已经找到了一些有趣的安装包也很好，可以通过使用*使用 YUM 搜索包*食谱的说明来学习。

## 怎么做...

这个方法将向您展示如何通过调用 YUM 安装选项来安装一个或多个包。为此，您需要以 root 用户身份登录并完成以下过程:

1.  要将安装到单个包装中，将`package_name`值替换为适当的值，并键入以下内容:

    ```sh
    yum install package_name

    ```

2.  您的系统现在将提供需要您批准的交易报告。因此，当出现提示时，只需使用 *Y* 或 *N* 键回应，并按下*返回*键接受或拒绝交易，如下所示:

    ```sh
    Is this ok [y/d/N]: y

    ```

3.  如果您拒绝了交易，则不需要进一步的工作，您将退出包管理例程。但是，如果你已经确认了交易，那就观察一下你的安装进度，最后它会给你显示一条`Complete!`信息。
4.  恭喜你！您现在已经成功安装了您选择的软件包。

## 它是如何工作的...

所有包都以 RPM 包文件格式存储，YUM 的角色是提供对存储在互联网上各种存储库中的那些文件的访问。YUM 是 CentOS 软件包管理背后的力量，它确实让安装过程变得非常容易，但是我们从这次经历中学到了什么？

调用`install`命令后，YUM 将对各个存储库进行搜索，以便找到与所讨论的包相关联的相关头和元数据。例如，如果您想安装一个名为`wget`的包，您可以从发出`install`命令开始，如这样:`yum install wget`。YUM 随后将定位该包并生成一个事务摘要，该摘要不仅将指示所需的磁盘大小和预期的安装大小，还将指示所请求的包所需的任何必要的依赖关系。然后，百胜将检查几个不同的存储库(`base`、`extras`和`updates`),在解决了任何必要的依赖关系后，百胜将要求我们在继续安装过程之前确认请求。因此，如您所见，通过使用 *Y* 键，我们将向 YUM 提供完成请求的权限，这反过来将导致下载、验证和安装相关的包。

## 还有更多...

有时您可能希望一次安装多个软件包。要做到这一点，只需调用相同的`install`命令，但不要命名单个包，只需确定您可能需要的包的完整列表，这样就形成了一个长长的购物清单:

```sh
yum install package_name1 package_name2 package_name3

```

通过这种方式可以安装的包的数量是无限的，但是总是在每个包名之间留一个空格，并将命令保持在一行。对于很长的安装说明，可能会出现换行。

您不需要以任何特定的顺序列出包装，请求将以与原始配方中完全相同的方式进行处理，同样，在列出交易摘要后，它将保持待定状态，直到被确认或拒绝。再次，使用 *Y* 键确认您的请求，以便流程完成。

# 使用 YUM 移除包

在本食谱中，我们将调查使用 YUM 的作用，其目的是从您的服务器中删除包。在服务器的生命周期内，可能不再需要某些应用程序和服务。在这种情况下，为了优化工作环境，您通常会想要删除此类包，本食谱的目的是向您展示如何做到这一点。

## 做好准备

要完成此方法，您将需要具有 root 权限的 CentOS 7 操作系统的工作安装、您选择的基于控制台的文本编辑器以及到互联网的连接。

## 怎么做...

本食谱将通过调用`yum remove`选项向您展示如何移除一个或多个包装。为此，您需要以 root 用户身份登录并完成以下过程:

1.  要移除单个包装，用适当的值替换`package_name`值，并键入以下内容:

    ```sh
    yum remove package_name

    ```

2.  等待交易汇总及确认提示显示，然后按 *Y* 键确认，或按 *N* 键拒绝交易，如下图:

    ```sh
    Is this ok [y/d/N]: y

    ```

3.  如果您拒绝了该交易，则不需要进一步的工作，您将退出 YUM。但是，如果您已经确认了交易，那么只需观察拆包的进度，直到确认并打印出一条`Complete!`消息。

## 它是如何工作的...

不再需要的应用程序可以用 YUM 删除。这个过程非常直观，类似于安装一个新的软件包，它只需要您确认您想要删除的软件包的名称。

那么，我们从这次经历中学到了什么？

调用`remove`命令后，YUM 会搜索你的系统，发现相关的包；通过读取包头和元数据，它还将确定这会影响哪些依赖关系。例如，如果我们想要删除一个名为`wget`的包，我们将从发出像这样的`remove`命令开始:`yum remove wget`。然后，YUM 会从您的系统中找到包的详细信息，并获得一个事务摘要，其中可能包括不再需要的任何必要的依赖关系。打印出来的交易将保持待定状态，直到您指示 YUM 删除相关的包。确认后，YUM 将完成交易，反过来将导致一个或多个包的移除。如果摘要引用了任何依赖项，您应该格外小心，因为其他 rpm 可能需要这些依赖项。如果您担心某些依赖关系应该保留在系统上，那么结束当前事务并简单地停用或禁用相关软件通常是一个好主意。与`install`命令一样，您也可以一次删除多个包，在包名称之间留出一个空格:

```sh
yum remove package_name1 package_name2 package_name3

```

# 保持百胜的干净整洁

在本食谱中，我们将研究 YUM 在确保工作缓存保持最新方面的作用。作为其典型操作模式的一部分，YUM 将创建一个由元数据和包组成的缓存。这些文件非常有用，但是随着时间的推移，它们的大小会累积到这样的程度，以至于您可能会发现 YUM 的行为不稳定或不符合预期。这种情况发生的频率可能因系统而异，但它通常意味着 YUM 缓存系统需要您立即关注。这种情况可能会非常令人沮丧，但本食谱的目的是提供一个快速解决方案，帮助您清理缓存并将 YUM 恢复到其原始工作状态。

## 做好准备

要完成此方法，您需要安装具有 root 权限的 CentOS 7 操作系统、您选择的基于控制台的文本编辑器以及互联网连接，以便于下载其他软件包。

## 怎么做...

在我们开始之前，重要的是要认识到，在我们对当前问题进行故障排除时，可以根据需要随时运行相同的配方，以保持 YUM 处于最佳工作状态:

1.  我们将从要求 YUM 清除任何缓存的包信息开始这个食谱。为此，请以 root 用户身份登录，并键入以下内容:

    ```sh
    yum clean packages

    ```

2.  让系统有时间响应，完成后，键入以下命令删除任何缓存的基于 XML 的元数据:

    ```sh
    yum clean metadata

    ```

3.  再次等待 YUM 响应，准备就绪后，键入以下命令删除任何缓存的数据库文件:

    ```sh
    yum clean dbcache

    ```

4.  接下来，您需要清理所有文件以确认前面的说明，并确保不使用不必要的磁盘空间。为此，请键入以下行:

    ```sh
    yum clean all

    ```

5.  最后，您将希望通过键入下面显示的内容来重建 YUM 缓存:

    ```sh
    yum makecache

    ```

## 它是如何工作的...

YUM 是一个非常强大的工具，以其解决包依赖和自动化包管理过程的能力而闻名，但是就像所有事情一样，有时即使是最好的实用程序也会混淆，并可能报告错误或表现不稳定。解决这个问题相对来说很简单，这个方法也可以让您的包管理器在操作系统的生命周期内保持健康的运行状态。

那么，我们从这次经历中学到了什么？

在其典型操作期间，YUM 将创建一个元数据和包的缓存，可以在`/var/cache/yum`找到。这些文件是必不可少的，但是随着它们大小的增加，该缓存最终会降低该实用程序的整体使用速度，甚至可能会导致一些问题。为了解决这种情况，我们首先使用以下命令，使用 YUM 的`clean packages`参数选项清理当前基于包的缓存。然后，我们使用命令`clean metadata`清理元数据缓存，这将删除任何多余的基于 XML 的文件。YUM 使用 SQLite 数据库作为其正常操作的一部分，因此下一步是使用`clean dbcache` 参数移除任何剩余的数据库文件。下一步是清理与已启用的存储库相关联的所有文件，以便回收任何未使用的磁盘空间:`yum clean all`。最后，我们通过使用`makecache`选项重建缓存，将 YUM 恢复到正常工作状态。

## 还有更多...

在一个典型的服务器上，YUM 是一个很好的工具，可以解决与包依赖和包管理相关的最复杂的问题。但是，在您故意混合不兼容的存储库或使用不完整的源代码的情况下，YUM 可能无法提供帮助。

### 注

请记住，在这种情况下，您应该将以下建议视为一种临时补救措施。忽视百胜提供的任何警告的倾向只会在以后导致更大的问题。

如果出现这种情况，并且错误是基于 RPM 的，作为临时修复，您可以使用以下命令跳过损坏的包:

```sh
yum -y update --skip-broken

```

该命令将允许 YUM 通过绕过任何有错误的包继续工作，但是如前所述，这应该仅被视为临时修复。您应该始终知道，依赖关系中断的系统不被认为是健康的系统。无论如何都要避免这种情况，在这种情况下，修复这样的错误应该成为您的首要任务。

# 知道自己的优先事项

在这个食谱中，我们将通过安装一个名为 **YUM 优先级**的插件来调查准备 YUM 管理额外存储库的任务。YUM 能够从各个远程位置搜索、删除、安装、检索和更新软件包。这些特性使 YUM 成为一个强大的工具，但是如果您决定添加一个额外的第三方存储库，冲突有可能会使系统不稳定。稳定性是使用 CentOS 操作系统的众多优势之一，本食谱的目的是向您展示如何保持这种信心，同时允许添加新的存储库。

## 做好准备

要完成此方法，您需要安装具有 root 权限的 CentOS 7 操作系统、您选择的基于控制台的文本编辑器以及互联网连接，以便于下载其他软件包。

## 怎么做...

本食谱将向您展示如何准备 YUM，以便通过安装和配置 YUM 优先级来管理使用一个或多个第三方存储库的过程:

1.  要开始此食谱，请以 root 用户身份登录并键入以下内容:

    ```sh
    yum install yum-plugin-priorities

    ```

2.  确认安装，完成后输入如下所示:

    ```sh
    vi /etc/yum/pluginconf.d/priorities.conf

    ```

3.  您应该确保该文件指示插件已启用。它应该显示指令`enabled = 1`。预计您不需要更改此文件中的任何内容，但是如果您已经做了任何更改，只需保存并关闭文件，然后继续。
4.  我们现在需要为每个存储库建立一个优先级值。这是一个按升序排列的数值，其中最高优先级被赋予最低的数字。为此，打开如下所示的文件:

    ```sh
    vi /etc/yum.repos.d/CentOS-Base.repo

    ```

5.  在`[base]`段末尾增加以下一行:

    ```sh
    priority=1

    ```

6.  现在，在`[updates]`部分的末尾添加以下一行:

    ```sh
    priority=1

    ```

7.  最后，在`[extras]`段的末尾增加以下一行:

    ```sh
    priority=1

    ```

8.  完成后，在运行包更新前保存并关闭文件:

    ```sh
    yum update

    ```

## 它是如何工作的...

YUM priorities 是一个简单的插件，它使 YUM 能够决定在安装和更新新包时哪些存储库将承担最高优先级。通过确保任何特定的包总是从同一个存储库中安装或更新，使用这个插件将减少包混淆的机会。这样，您可以添加无限数量的存储库，并使 YUM 能够保持对包管理的控制。

那么，我们从这次经历中学到了什么？

用这个插件增强 YUM 只是简单地安装`yum-plugin-priorities`包，并确保它在其配置文件中被启用。然后，我们发现优先级是按升序设置的，其中最低值优先于所有其他值。当然，这有助于简化整个过程，因此，我们确保默认存储库被赋予了值`1` ( `priority=1`)。这将确保默认存储库保持最高的优先级，因此当您决定添加额外的存储库时，您可以为它们分配 2、3、4…和 10 或更多的优先级值。另一方面，应该注意的是，我们只在三个主要部分设置了该值:`[base]`、`[updates]`和`[extras]`。简单来说，这只是因为其他部分被禁用。例如，您可能已经注意到`/etc/yum.repos.d/CentOS-Base.repo`中的`[centosplus]`部分包括以下行:`enabled=0`，而`[updates]`和`[extras]`部分将该值显示为`enabled=1`。当然，如果您打算激活这个存储库，您将需要为它设置一个优先级值，但是对于这个配方来说，这样的操作不是必需的。最后，我们运行了一个简单的 YUM 包更新，以便激活我们修改后的设置。

因此，正如我们所看到的，YUM priorities 是一个非常灵活的包，当您想要扩展您的安装选项时，它使您能够确定什么存储库优先。但是，您应该始终意识到 YUM 优先级可能不适合您的系统，因为您赋予它决定哪些包将被忽略、安装哪些包、更新哪些包以及以什么顺序从哪个存储库中获取它们的权力。对于大多数倾向于不远离典型服务器功能的用户来说，这可能不是一个直接的问题；你甚至可以安全地忽略这个警告。但是如果稳定性和安全性是压倒一切的考虑，并且您确实打算使用来自外部存储库的附加包，那么您应该仔细考虑这个插件的使用，或者至少考虑和研究所使用的第三方存储库的完整性。

# 使用第三方存储库

在本食谱中，我们将研究通过安装 EPEL 和雷米存储库来充分利用 CentOS 可用的软件包的愿望。CentOS 是一个基于企业的操作系统，它以稳定性为荣，在您的服务器的生命周期内，您需要的每一个软件都可能无法在默认存储库中找到。也有可能您需要当前软件的更新包，由于这些原因，许多服务器管理员选择安装 EPEL 和雷米存储库。这些不是唯一可用的存储库，但是因为它们代表了最流行的组合之一，所以本食谱的目的是向您展示如何将 EPEL 和雷米存储库添加到您的系统中。

## 做好准备

要完成此方法，您需要安装具有 root 权限的 CentOS 7 操作系统、您选择的基于控制台的文本编辑器以及互联网连接，以便于下载其他软件包。

## 怎么做...

在我们开始之前，假设您已经遵循了之前向您展示如何安装和激活 YUM 优先级的方法。

1.  首先，以 root 用户身份登录，并使用 YUM:

    ```sh
    yum install epel-release

    ```

    安装 EPEL 发布库
2.  Next, from your home directory, type the following commands to download the `remi release` `rpm` package:

    ```sh
    curl -O http://rpms.famillecollet.com/enterprise/remi-release-7.rpm

    ```

    ### 注

    请注意，当您阅读此内容时，此网址可能已更改；如果是，请做一些互联网研究，看看是否有新的网址可用。

3.  前面的文件现在应该位于您的个人文件夹中。要继续，请键入以下命令:

    ```sh
    rpm -Uvh remi-release-7.rpm

    ```

4.  安装完成后，用您最喜欢的文本编辑器打开 Remi 存储库文件:

    ```sh
    vi /etc/yum.repos.d/remi.repo

    ```

5.  将`enabled=0`更改为`enabled=1`，并在`[remi]`部分的末尾添加线条`priority=10`。
6.  现在，用您最喜欢的文本编辑器打开 EPEL 存储库文件:

    ```sh
    vi /etc/yum.repos.d/epel.repo

    ```

7.  再次，如果没有自动设置，将`enabled=0`更改为`enabled=1`，并在`[epel]`部分添加线条`priority=10`。
8.  要完成，更新 YUM，如下所示:

    ```sh
    yum update

    ```

9.  如果有更新，选择 *Y* 继续。完成更新过程后，您现在可以从 Remi 和 EPEL 存储库中下载和安装软件包，作为默认情况下使用的软件包的补充。

## 它是如何工作的...

为了使用并享受第三方存储库的好处，您需要首先使用 YUM 和 RPM 包管理器安装并启用它。

那么，我们从这次经历中学到了什么？

从配方开始，安装 Remi 和 EPEL 存储库的任务是一个非常顺利的过程。虽然使用 YUM 安装 EPEL 存储库对于更改是非常安全的，但是 Remi 的前面的 URL 是由存储库所有者自行决定维护的，所以您应该始终确保它们是最新的。但是，在获得必要的存储库设置文件后，就需要应用基于 RPM 的命令，以便在您的系统上安装所有必要的存储库文件。完成此操作后，我们需要打开每个已安装存储库的相关配置文件并启用它们(通过将`enabled=0`更改为`enabled=1`)并设置优先级值(`priority=10`)。虽然前一个值只会打开存储库，但是当我们调用`update`命令时，YUM 会使用后一个值来正确识别哪些存储库是最合适的。正如前面关于 YUM 优先级的食谱中所讨论的，简单的经验法则是基于记住“数字越低，优先级越高”这句话。这本身(取决于您的原因)可能不是一件坏事，但就本食谱而言，它表明默认的 CentOS 存储库应该优先于所有其他存储库。当然，您可能不同意这一点，是的，没有什么能阻止您对第三方供应商应用相同的优先级规则，但我在深入之前提醒您，如果这是针对任务关键型生产服务器，情况尤其如此。请记住，如果所有优先级值都相同，那么默认情况下，YUM 将尝试下载最新版本。

将 Remi 和 EPEL 设置为比现有的基于 CentOS 的存储库更高的值的原因是基于考虑安全更新的需要。除非您另有决定，否则建议您首先从 CentOS 获取基本文件。这包括但不限于内核更新、SELinux 和相关包。第三方存储库应该用于无法从原始来源获得的附加包，或者用于访问 CentOS 基本版本可能不可用的特定更新。这可能包括像 Apache、MariaDB 或 PHP 这样的包。最后一个脚注，您会注意到 Remi 和 EPEL 存储库共享相同的优先级值。这是设计好的，因为这些存储库通常被视为合作伙伴。但是，如果您决定开始混合存储库，或者使用这个方法作为安装这里没有提到的其他存储库的网关，那么您应该始终根据具体情况对每个第三方进行研究和评估。Remi 和 EPEL 的存储库非常受欢迎，所以如果你真的打算添加更多的第三方资源，请围绕这个主题阅读，仔细选择你的存储库，并保持忠诚。

## 还有更多...

CentOS 7 还有许多其他有趣的存储库，例如 ELRepo，它专注于与硬件相关的包，如文件系统驱动程序、图形驱动程序、网络驱动程序、声音驱动程序以及网络摄像头或视频驱动程序。前往至[http://elrepo.org](http://elrepo.org)了解如何安装和访问。

# 创建一个 YUM 存储库

如果您在本地网络中维护多个 CentOS 服务器，并希望节省互联网带宽或一次又一次地加速下载相同的远程存储库包，或者处于对客户端访问任何远程 CentOS 存储库都被阻止的非常严格的网络环境中，您可能需要考虑运行自己的 YUM 存储库。如果您想向本地用户推出一些定制的或非官方的 RPM 包(例如内部配置文件或程序)，或者如果您只想创建一个官方的 CentOS 7 存储库镜像站点，拥有自己的存储库也是一个很好的解决方案。在本食谱中，我们将向您展示如何建立您自己的第一个 YUM CentOS 7 存储库，以及如何将其服务于您的本地网络。

## 做好准备

要完成此方法，您需要安装具有 root 权限的 CentOS 7 操作系统，一个您选择的基于控制台的文本编辑器，以及一个互联网连接，以便于下载其他软件包。要使这个方法起作用，您还需要将 CentOS 7 Everything DVD iso 文件映像放在服务器的根主目录中，如果您还没有下载，请参考[第 1 章](01.html#E9OE1-4cf34a6d07944734bb93fb0cd15cce8c "Chapter 1. Installing CentOS")、*安装 CentOS* 中第一个方法的详细描述(但是下载最新的 `CentOS-7-x86_64-Everything-XXXX.iso`文件，而不是最小的 iso 文件)。此外，我们需要一个运行的 Apache 网络服务器来将我们的 YUM 存储库共享给我们的本地网络；请阅读[第 12 章](12.html#2TEN41-4cf34a6d07944734bb93fb0cd15cce8c "Chapter 12. Providing Web Services")、*提供 Web 服务*中的第一个食谱，以了解如何设置。

## 怎么做...

要创建我们自己的 YUM 存储库，我们需要`createrepo`程序，默认情况下，CentOS 7 上不安装这个程序。让我们从安装它开始我们的旅程。在本例中，我们将使用 YUM 存储库服务器的 IP 地址`192.168.1.7`:

1.  以 root 用户身份登录您的服务器，安装以下软件包:

    ```sh
    yum install createrepo

    ```

2.  接下来，对于您想要共享的每个存储库，在`/var/www/html/repository/`下的 Apache web 根文件夹下创建一个子文件夹，在 Apache 运行时将公开提供；例如，要共享完整的 CentOS 7 `Everything`存储库包，您可以使用:

    ```sh
    mkdir -p /var/www/html/repository/centos/7.1

    ```

3.  现在，将您选择的所有 RPM 包文件放入在此创建的存储库文件夹中。在我们的例子中，在我们将 iso 文件的内容装载到文件系统

    ```sh
    mount ~/CentOS-7-x86_64-Everything-1503-01.iso /mnt/
    cp -r /mnt/Packages/* /var/www/html/repository/centos/7.1/

    ```

    后，我们将把所有 RPM 包从`Everything` iso 映像文件放入我们新的本地存储库位置
4.  之后，我们需要为复制到 Apache web 根目录的所有新文件更新 SELinux 安全上下文:

    ```sh
    restorecon -v -R /var/www/html

    ```

5.  现在，对于我们想要设置的每个存储库，运行以下命令:

    ```sh
    createrepo --database /var/www/html/repository/centos/7.1

    ```

6.  恭喜，您现在已经成功创建了第一个 YUM 存储库，可以通过运行的 Apache 网络服务器从同一网络中的任何计算机访问该存储库。为了测试它，以 root 用户身份登录任何其他基于 CentOS 7 的系统，该系统可以 ping 我们的存储库服务器，并将我们的新存储库添加到其 YUM 存储库配置目录:

    ```sh
    vi /etc/yum.repos.d/myCentosMirror.repo

    ```

7.  将以下内容添加到该空文件中(适当更改`baseurl`以适合您自己的需要):

    ```sh
    [myCentosMirror]
    name=my CentOS 7.1 mirror
    baseurl=http://192.168.1.7/repository/centos/7.1
    gpgcheck=1
    gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-7

    ```

8.  保存并关闭文件，然后在客户端测试您的新存储库是否可用(它应该出现在列表中):

    ```sh
    yum repolist | grep myCentosMirror

    ```

9.  现在，为了测试我们新的 YUM 存储库，我们可以尝试以下命令:

    ```sh
    yum --disablerepo="*" --enablerepo="myCentosMirror" list available

    ```

## 它是如何工作的...

在本食谱中，我们向您展示了安装和设置本地 YUM 存储库是多么容易。然而，我们只向您展示了如何创建所有 CentOS 7 Everything iso RPM 包的镜像站点，但是您可以重复这个过程来创建您想要与网络共享的每种包的 YUM 存储库。

那么，我们从这次经历中学到了什么？

建立您自己的 YUM 存储库只需安装`createrepo`包，并将您想要共享的所有 RPM 包复制到 Apache 文档根目录下您选择的子文件夹中(在我们的示例中，我们必须将 CentOS 7 Everything iso 文件装载到文件系统中，以便访问我们想要共享的包含 RPM 包的文件)。由于 Apache 的文档根目录在 SELinux 的控制下，之后我们需要将这个目录下所有新 RPM 文件的安全上下文设置为`httpd_sys_content_t`类型标签；否则，无法通过 web 服务器进行访问。最后，我们需要在我们的新存储库文件夹上运行`createrepo`命令，这将创建我们的新存储库的元数据，任何希望稍后连接到存储库以对其进行查询的 YUM 客户端都需要该元数据。

之后，为了测试我们的新存储库，我们在另一个 CentOS 7 系统上创建了一个新的存储库定义文件，该系统想要使用这个新服务，并且必须与我们的 YUM 存储库服务器在同一个网络中。在这个定制的`.repo`配置文件中，我们将正确的 URL 路径放入存储库，启用`gpg`检查，并采用标准的 CentOS 7 `gpgkey`以便我们的 YUM 客户端可以证明 RPM 包官方存储库包的有效性。最后，我们使用带有`--disablerepo="*"`和`--enablerepo="myCentosMirror"`参数的`yum`命令，这将确保只使用我们新的自定义存储库作为源。您可以将这两个参数与任何其他`yum`命令结合使用，如`install`、`search`、`info`、`list`等。这只是为了测试；如果您想将新的存储库与现有的存储库相结合，请使用 YUM 优先级(如本章中的另一个食谱所示)。

## 还有更多...

现在，在我们向我们的网络宣布新的集中式 YUM 存储库之前，我们应该首先更新自 CentOS Everything iso 发布以来发生变化的所有 RPM 包。为了做到这一点，访问[http://www.centos.org](http://www.centos.org)并选择一个地理上靠近您当前位置的`rsync://`镜像链接。例如，如果您位于德国，一个选项可能是[rsync://FTP . hosteurope . de/centos/](http://rsync://ftp.hosteurope.de/centos/)(有关导航 CentOS 网站的更多详细说明，请阅读[第 1 章](01.html#E9OE1-4cf34a6d07944734bb93fb0cd15cce8c "Chapter 1. Installing CentOS")、*安装 CentOS* 中的第一个食谱)。此外，在使用`rsync`协议之前，我们需要安装`rsync`包(`yum install rsync`)，如果还没有安装的话。现在，打开下面的空脚本文件`vi ~/update-myCentosMirror-repo.sh`文件，放入以下内容(如果需要，相应替换`rsync://`位置):

```sh
rsync -avz rsync://ftp.hosteurope.de/centos/7/os/x86_64/Packages/ /var/www/html/repository/centos/7.1
restorecon -v -R /var/www/html

```

现在，使用`chmod +x ~/update-myCentosMirror-repo.sh`使文件可执行，并使用`~/update-myCentosMirror-repo.sh`运行它。这应该会将您的存储库更新到最新版本。最后，为了自动化这个过程，让我们创建一个 cron 作业，它将在每晚凌晨 2:30 用其他镜像站点更新我们的存储库包(打开`crontab -e`):

```sh
30 2 * * * /root/update-myCentosMirror-repo.sh

```

# 与转速包管理器一起工作

CentOS 7 系统上的所有软件都是通过 RPM 包分发的。大多数情况下，YUM 包管理器是执行软件安装和维护的任何系统管理员的首选，只要有可能，就强烈推荐使用它，因为它提供系统完整性检查，并具有出色的包依赖性解决方案。在本食谱中，我们将向您展示管理您的包的替代方法。我们将探索 RPM 软件包管理器，这是一个强大的工具，用于构建、安装、查询、验证、更新和删除单个 RPM 软件包。虽然它不像百胜那样*智能*，因为它不能解决包依赖或与存储库一起工作，但它今天仍然是相关的，因为它提供了百胜不提供的非常有用的查询选项，并且它可以用来手动安装单个软件包。

## 做好准备

要完成此方法，您需要安装具有 root 权限的 CentOS 7 操作系统、您选择的基于控制台的文本编辑器和互联网连接，以便于下载更多的 RPM 软件包。

## 怎么做...

我们从互联网上下载一个`rpm`包来开始这个食谱，我们将使用这个包向您展示一个`rpm`命令如何工作的例子:

1.  We will begin by logging in as root into the root's home directory and downloading the pipe view program from the EPEL repository, which cannot be found in the official CentOS repository:

    ### 注

    ```sh
    cd ~;curl -O http://dl.fedoraproject.org/pub/epel/7/x86_64/p/pv-1.4.6-1.el7.x86_64.rpm

    ```

    请注意，当您阅读此内容时，包的网址可能已更改。

2.  下载完成后，我们将使用以下`rpm`命令安装该软件包:

    ```sh
    rpm -Uvh ~/pv-1.4.6-1.el7.x86_64.rpm

    ```

3.  如果安装已经完成，让我们通过查询 RPM 数据库来检查包的安装是否成功:

    ```sh
    rpm -qa | grep "pv-"

    ```

4.  也可以直接测试`pv`程序(按 *Ctrl* + *C* 键退出):

    ```sh
    dd if=/dev/urandom | pv | dd of=/dev/null

    ```

5.  我们现在可以使用`rpm`命令丰富的查询选项来显示已安装软件包的有用信息:

    ```sh
    rpm -qi pv
    rpm -ql pv
    rpm -qd pv

    ```

6.  最后，如果你不喜欢或者不再需要的话，让我们去掉这个包:

    ```sh
    rpm -e pv

    ```

## 它是如何工作的...

在这里，在这个食谱中，我们向您介绍了转速包管理器，这是管理转速包的原始程序。RPM 包是软件分发的打包标准，在文件中包含有用的元数据，用于验证所包含软件的作者身份(例如，使用 PGP 进行签名验证)和完整性。安装包含二进制程序的包，而不是手动从头编译和构建它们，要容易得多，也更一致，但是 RPM 包也可以包含任何类型的文件，例如源代码或只是文档文件。如介绍中所述，`rpm`命令有六种不同的操作模式:构建、安装、卸载、更新、查询和验证 rpm 包。在这里，在这个食谱中，我们向您展示了如何使用最重要的五个操作(我们没有展示构建 RPM)。

那么，我们从这次经历中学到了什么？

我们首先以 root 用户身份登录，从非官方的 EPEL CentOS 存储库中下载`pv` (pipe viewer) rpm 包示例(EPEL 包含高质量的附加包，经过彻底的检查并正式确认；手动使用`curl`查看*使用第三方存储库*配方(了解更多关于 EPEL 存储库的信息)，因为它在官方存储库中不可用，但可能是一个非常有用的工具。

### 注

尽管互联网上有许多 RPM 存储库和下载源，但出于安全和兼容性的原因，在生产系统上，您应该考虑只安装来自有效且信誉良好的存储库和源的官方 CentOS 7 RPM 软件包。一般来说，所包含的包最好由许多专家和用户进行测试和审查。

下载的包文件的名称可以通过以下方式读取，它遵循 RHEL/CentOS 包的以下非强制命名约定:

```sh
pv-1.4.6-1.x86_64.rpm  = package name (pv)-version number (1.4.6)-release(1)-CPU architecture (x86_64)

```

接下来，我们使用 RPM 包管理器安装下载的`pv`包，可以使用命令行上的`rpm`命令执行。我们将其与`-Uvh`命令参数以及下载的软件包 rpm 文件的全名一起使用。

### 注

如果使用 rpm 命令安装或升级 rpm 软件包，应始终使用`-Uvh`，但有一个例外；它们是内核包。`-U`会在更新时移除旧包，如果安装新内核，这不是你想要的。请在这里使用`-i`(用于安装)，因为这将保留旧的内核文件，以便在遇到一些问题时可以回到早期版本。

`-U`是安装或升级软件包的参数。如果系统上没有安装软件包，它将被安装；否则`rpm`如果它的 RPM 包版本比安装的版本新，会尝试升级它。`-v`参数打印更详细的输出，而`-h`显示漂亮的进度条。当您尚未在系统上启用 EPEL 存储库时，安装`pv`软件包将会收到以下警告消息:

```sh
pv-1.6.0-1.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 3fc56f51: NOKEY

```

RPM 将在安装前自动检查包签名的有效性，以确保包的内容在签名后没有被修改。此外，它检查 RPM 包是否可信，因为它应该由官方第三方权威供应商使用加密密钥签名。您可以忽略此消息，因为来自 EPEL 存储库的包来自安全的来源。要永久信任 EPEL 来源，您可以使用以下命令在系统上安装其`gpg`公钥，并删除所有未来的签名警告消息:

```sh
rpm --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7

```

成功地安装了这个包之后，我们现在有了一个很好的命令行工具`pv`来显示数据通过 Unix 管道的进度，如果您正在通过管道传输大量数据，而您通常永远不知道当前的进度状态，这将非常有用。之后，我们使用带有`-q`标志的`rpm`命令，查询存储 CentOS 7 系统上所有已安装软件包信息的 RPM 数据库。在处理 RPM 数据库时，我们必须使用真实的包名(`pv`)而不是我们最初安装包时使用的文件名(`pv-1.4.6-1.x86_64.rpm`)。删除已安装的包时也是如此；请指定包名，而不是版本号或完整文件名。

为了获得已安装软件包的详细信息，`pv`，我们使用了`-qi` ( `i`为信息)，带有`-ql`参数；我们显示了包中所有文件的完整文件名和路径。`-qd`展示了包含文档的包中的所有文件。要了解更多查询选项，请键入`man rpm`并查看`PACKAGE QUERY OPTIONS`部分。

总之，我们可以说，在系统管理员的生活中，有一些情况需要安装一个不是通过官方存储库分发的软件(例如，非开源的、尖端的程序或测试版，具有不允许将其放入存储库的许可证的软件，如 Java，或独立开发人员的软件)，并且需要下载单独的 RPM 包并手动安装它们。在引擎盖下，YUM 还依赖并在后台使用 rpm 包管理器，所以你也可以使用 YUM 程序安装 RPM 文件(`yum install <filename.rpm>`)。但是，当查询您下载的 rpm 文件或系统上安装的软件包时，有些情况下最好使用较旧的`rpm`命令，而不必安装额外的基于 YUM 的软件，如`yum-utils`。

RPM 最大的弱点是不支持存储库，并且缺少依赖管理系统。如果您单独使用 RPM 在 CentOS 系统上安装所有软件，您将很容易遇到包依赖问题，因为您无法安装特定的包，因为它依赖于其他一些包。通常，当您试图安装依赖包时，您需要它们所依赖的其他包，等等。这个可以是非常繁琐的工作，应该总是用 YUM 来代替来避免。

## 还有更多...

`rpm`命令不仅可以用来查询 rpm 数据库中已安装软件包的信息，还可以用来查询自己下载的 rpm 文件。例如，使用`-qlp`参数显示本地`rpm`包文件中的所有文件:

```sh
rpm -qlp ~/pv-1.4.6-1.el7.x86_64.rpm

```

要从`rpm`文件中获取包的详细信息，请使用`-qip`参数，如下所示:

```sh
rpm -qip ~/pv-1.4.6-1.el7.x86_64.rpm

```

如果你想安装一个本地下载的并且有依赖关系的 RPM 包，你可以使用`yum localinstall`命令。一旦提供了本地包的文件名，这将安装本地包，并将尝试解决来自远程源的所有依赖关系，例如:

```sh
wget http://location/to/a/rpm/package_name.rpm
yum localinstall package_name.rpm

```