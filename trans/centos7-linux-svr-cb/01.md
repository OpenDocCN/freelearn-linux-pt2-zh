# 一、安装 CentOS

在本章中，我们将介绍:

*   在 Windows 或 OS X 上下载中央处理器并确认校验和
*   在 Windows 或 OS X 上创建 USB 安装媒体
*   使用图形安装程序执行 CentOS 安装
*   通过 HTTP 运行网络安装
*   使用 kickstart 文件安装 CentOS
*   重新安装引导加载程序
*   在救援模式下排除系统故障
*   入门和自定义引导加载程序
*   使用额外的管理和开发工具更新安装并增强最小安装

# 简介

本章是食谱的集合，涵盖了安装 CentOS 7 操作系统的基本实践。本章的目的是向您展示如何快速启动和运行 CentOS，同时让您能够通过一些“交易技巧”来定制您的安装。

# 在 Windows 或 OS X 上下载 CentOS 并确认校验和

在本食谱中，我们将学习如何使用典型的 Windows 或 OS X 台式电脑下载和确认一个或多个 CentOS 7 磁盘映像的校验和。CentOS 通过 HTTP、FTP 或 rsync 协议从位于世界各地的一系列镜像站点或通过 BitTorrent 网络以各种格式提供。对于从互联网下载非常重要的文件，例如操作系统映像，验证这些文件的校验和被认为是最佳做法，以确保任何生成的介质在安装时都能正常运行。这也确保了文件是真实的，并且来自原始来源。

## 做好准备

要完成这个配方，假设您使用的是一台典型的基于 Windows 的(Windows 7、Windows Vista 或类似的)或具有完全管理权限的 OS X 计算机。您将需要互联网连接来下载所需的安装文件，并且还需要访问带有适当软件的标准 DVD/CD 光盘刻录机，以便从图像文件创建相关的安装光盘。出于本食谱的目的，假设所有下载都将存储在您个人的`C:\Users\<username>\Downloads`文件夹中，或者如果使用 OS X 系统，则存储在`/Users/<username>/Downloads`文件夹中。

## 怎么做...

无论您下载的安装文件类型如何，以下技术都可以应用于 CentOS 项目提供的所有映像文件:

1.  让我们从在网络浏览器中访问 http://www.centos.org T2 开始，导航到按钮链接立即获取中心 T4。然后点击文本中当前镜像列表**的链接**。
2.  镜像站点是分类的，因此从结果链接列表中，选择一个地理位置靠近您当前位置的镜像。比如你在伦敦(英国)，可以选择**欧盟**和**英国**的镜子。现在通过选择 HTTP 或 FTP 链接来选择镜像站点。
3.  做出选择后，您现在将看到所有可用 CentOS 版本的目录列表。要继续，只需点击相应的文件夹，上面写着`7`。接下来，您将看到一个额外的目录列表，如`atomic`、`centosplus`、`cloud`等。我们继续选择`isos`目录。
4.  CentOS 7 目前只支持 64 位架构，所以浏览到唯一可用的标有`x86_64`的目录，这是 64 位版本的容器。
5.  现在，您将看到一系列可供下载的文件。首先下载一份被识别为`md5sum.txt`的有效校验和结果。
6.  如果你是 CentOS 的新手或者打算遵循本书中的食谱，那么最小的安装是理想的。这包含最少数量的具有功能系统的包，因此选择以下内容(`XXXX`是此版本的月戳):

    ```sh
    CentOS-7-x86_64-Minimal-XXXX.iso

    ```

7.  仅在基于视窗的系统上(在苹果电脑上，这个工具是系统中已经有的，在浏览器中访问[http://mirror.centos.org/centos/dostools/](http://mirror.centos.org/centos/dostools/)，下载程序`md5sum.exe`。
8.  现在在窗口上，打开命令提示符(通常在**开始** | **所有程序** | **附件** | **命令提示符**并在将要打开的窗口中键入以下命令(按下所有行末尾的*回车*键):

    ```sh
    cd downloads
    dir

    ```

9.  在 OS X，打开程序**查找器** | **应用程序** | **实用程序** | **终端**，然后键入以下命令(按下所有行末尾的*回车*键):

    ```sh
    cd ~/Downloads
    ls

    ```

10.  现在，您应该可以看到下载文件夹中的所有文件(包括所有下载的 CentOS 安装映像文件、md5sum.txt 文件以及 Windows 上的 md5sum.txt 程序)。
11.  根据显示的文件名，修改以下命令，以检查下载的 ISO 映像文件的校验和。在 Windows 上，键入以下命令(相应地更改`XXXX`月戳):

    ```sh
    md5sum.exe CentOS-7-x86_64-Minimal-XXXX.iso

    ```

12.  在 OS X，改为使用:

    ```sh
    md5 CentOS-7-x86_64-Minimal-XXXX.iso

    ```

13.  按下*返回*键继续，然后等待命令提示符响应。响应称为 MD5 和，结果可能如下所示:

    ```sh
    d07ab3e615c66a8b2e9a50f4852e6a77  CentOS-7-x86_64-Minimal-1503-01.iso

    ```

14.  现在查看总和，并在`md5sum.txt`中与特定图像文件的相关列表进行比较(在文本编辑器中打开)。如果两个数字都匹配，那么您可以确信您确实下载了有效的 CentOS 映像文件。如果没有，您下载的文件可能已损坏，因此请通过再次下载图像文件来重新启动此过程。
15.  完成后，只需使用您喜欢的桌面软件将您的图像文件刻录到空白光盘或 DVD-ROM 中，或者从中创建一个 USB 安装介质，我们将在本章的下一个食谱中向您展示。

## 它是如何工作的…

那么我们从这次经历中学到了什么？

下载 CentOS 安装映像的行为只是构建完美服务器的第一步。虽然这个过程非常简单，但很多人确实忘记了需要确认校验和。在本书中，我们将使用最少的安装映像，但是您应该知道还有其他安装选项可供您选择，例如网络安装、DVD、一切和各种 LiveCDs。

# 在 Windows 或 OS X 上创建 USB 安装介质

在本食谱中，我们将学习如何在 Windows 或 OS X 上创建 USB 安装介质。如今，越来越多越来越多的服务器系统、台式电脑和笔记本电脑在发货时没有任何光驱。使用 USB 设备安装新的操作系统(如 CentOS Linux)对他们来说至关重要，因为没有其他安装选项可用，因为没有其他方法可以引导安装介质。此外，使用通用串行总线介质安装中央处理器比使用光盘方法要快得多。

## 做好准备

在我们开始之前，假设您已经遵循了之前的方法，其中向您展示了如何下载最小的 CentOS 映像并确认相关映像文件的校验和。还假设所有下载(包括下载的国际标准化组织文件)都存储在您的`C:\Users\<username>\Downloads`文件夹中，或者如果使用 OS X 系统，则存储在`/Users/<username>/Downloads`文件夹中。接下来，您将需要一个免费的 USB 设备，它可以被您的操作系统发现，有足够的总空间，并且是空的或者上面有可以丢弃的数据。为最小版本的 CentOS 7 准备安装介质所需的通用串行总线设备的总空间必须大约为 700 兆字节。如果您在 Windows 计算机上工作，您将需要一个正常的互联网连接来下载其他软件。在 OS X，您需要一个管理员用户帐户。

## 怎么做...

要开始这个食谱，启动你的 Windows 或 OS X 操作系统，然后连接一个有足够容量的免费 USB 设备，等待它被 Windows 下的**文件管理器**或 OS X 下的**查找器**发现

1.  在一个基于视窗系统上，我们需要下载一个名为`dd`的附加软件。在你最喜欢的浏览器中访问[http://www.chrysocome.net/dd](http://www.chrysocome.net/dd)。现在下载你能在那里找到的最新的`dd-XX.zip`文件，`XX`是最新的稳定版本号。比如`dd-0.5.zip`。
2.  在窗口上，使用**文件管理器**导航到您的`Downloads`文件夹。在这里你会找到`dd-05.zip`文件。右键点击**提取全部**，提取`dd.exe`文件，不创建任何子目录。
3.  在 Windows 上，打开命令提示符(通常位于**开始** | **所有程序** | **附件** | **命令提示符**)并键入以下命令:

    ```sh
    cd downloads
    dd.exe --list

    ```

4.  在 OS X，打开程序**查找器** | **应用程序** | **实用程序** | **终端**，然后键入以下命令:

    ```sh
    cd ~/Downloads
    diskutil list

    ```

5.  在 Windows 上，要找到要用作安装介质的正确 USB 设备的名称，请查看`removable media`部分下的命令输出。在下面，你应该找到一条以`Mounting on`开始的线，然后是一个驱动器号，例如`\.\e:`。这个神秘的书面驱动器号是我们下一步需要的最重要的部分，所以请写下来。
6.  在 OS X，设备路径可以在前一个命令的输出中找到，其格式为`/dev/disk<number>`，其中`number`是磁盘的唯一标识符。磁盘编号从零开始(`0`)。磁盘`0`很可能是 OS X 恢复磁盘，而磁盘`1`很可能是你的主 OS X 安装。要识别您的 USB 设备，请尝试将`NAME`、`TYPE`和`SIZE`列与您的 u 盘规格进行比较。如果您已经识别了设备名称，请记下它，例如`/dev/disk3`。
7.  在 Windows 上，键入以下命令，假设您选择作为安装介质的 USB 设备具有 Windows 设备名称`\\.\e:`(根据需要更改此名称，并注意您键入的内容–这可能会造成巨大的数据丢失)。另外，在下一个命令中用正确的`iso`文件版本号替换`XXXX`:

    ```sh
    dd.exe if=CentOS-7-x86_64-Minimal-XXXX.iso of=\\.\e: bs=1M

    ```

8.  在 OS X，您需要两个命令来询问管理员密码(将`XXXX`和`disk3`替换为正确的版本号和正确的 USB 设备路径):

    ```sh
    sudo diskutil unmountDisk /dev/disk3
    sudo dd if=./CentOS-7-x86_64-Minimal-XXXX.iso of=/dev/disk3 bs=1m

    ```

9.  `dd`程序结束后，会输出一些统计数据，说明在复制过程中花了多长时间以及传输了多少数据。在 OS X，忽略任何关于磁盘不可读的警告消息。
10.  恭喜你！您现在已经创建了第一个 CentOS 7 USB 安装介质。现在，您可以在 Windows 或 OS X 中安全地移除 USB 驱动器，并从物理上拔下设备，将其用作在目标机器上安装 CentOS 7 的引导设备。

## 它是如何工作的...

那么我们从这次经历中学到了什么呢？

本食谱的目的是向您介绍使用`dd`命令行程序在 USB 设备上创建 CentOS 安装 ISO 文件的精确副本的概念。`dd`程序是一个基于 Unix 的工具，可用于将位从源文件复制到目标文件。这意味着源被一点一点地读取并写入目的地，而不考虑内容或文件分配；它只涉及读取和写入纯原始数据。它需要两个基于文件名的参数:输入文件(`if`)和输出文件(`of`)。我们将使用 CentOS 图像文件作为我们的输入文件名，将其精确地克隆到 USB 设备上`1:1`，该设备可以通过其设备文件作为我们的输出文件参数来访问。`bs`参数定义块大小，即一次要复制的数据量。请小心，这是一个绝对的专家工具，在复制目标上的数据时会覆盖目标上的任何现有数据，而无需进一步确认或任何安全检查。所以至少要仔细检查你目标 USB 设备的设备盘符，千万不要混淆！例如，如果您在`D:`安装了第二个硬盘，在`E:`安装了您的 USB 设备(在 OS X，分别在`/dev/disk2`和`/dev/disk3`)，并且您将驱动器号`E:`与`D:`(或`/dev/disk3`与`/dev/disk2`)混淆，您的第二个硬盘将被擦除，几乎没有机会恢复任何丢失的数据。所以要小心处理！如果对正确的输出文件设备有疑问，千万不要启动`dd`程序！

总之，可以公平地说，对于为 CentOS 7 创建 USB 安装介质，还有其他远比`dd`命令更方便的解决方案可用，例如 Fedora Live USB Creator。但是这个方法的目的不仅仅是创建一个现成的 CentOS USB 安装程序，而且是让你习惯`dd`命令。这是每个 CentOS 系统管理员都应该知道如何使用的常见 Linux 命令。它可以用于各种各样的日常任务。例如，用于安全擦除硬盘、测试网络速度或创建随机二进制文件。

# 使用图形安装程序执行中央操作系统的安装

在本食谱中，我们将学习如何使用 CentOS 7 中引入的新图形安装程序界面来执行 CentOS 的典型安装。在许多方面，这被认为是安装系统的推荐方法，因为它不仅为您提供了创建所需硬盘分区的能力，还可以通过许多方式(例如，键盘布局、软件包选择、安装类型等)自定义您的安装。然后，您的安装将形成一个服务器的基础，您可以在此基础上构建、开发和运行将来可能想要提供的任何类型的服务。

## 做好准备

在我们开始之前，假设您已经遵循了之前的方法，其中向您展示了如何下载 CentOS 映像、确认相关映像文件的校验和以及创建相关的安装光盘或 USB 介质。您的系统必须是 64 位(x64_86)架构，必须至少有 406 MB 的 RAM 来加载图形安装程序(如果安装图形窗口管理器，如 Gnome，建议 1 GB 或更多)，并且至少有 10 GB 的可用硬盘空间。

## 怎么做...

要开始此方法，请插入您的安装介质(光盘或 USB 设备)，重新启动计算机，并在启动过程中按正确的键选择引导设备。然后从列表中选择插入的设备(对于许多计算机，这可以使用 *F11* 或 *F12* 来实现，但在您的系统上可能会有所不同。请参考您的主板手册)。

1.  在欢迎使用闪屏上，预选了**测试该媒体&安装 CentOS 7** 选项，我们将使用该选项。准备好之后，按下*返回*键继续。
2.  加载一些初始文件后，安装程序开始测试安装介质。一次测试需要 30 秒到 5 分钟，如果安装介质上有任何错误，将会报告。当这个过程完成时，系统将最终加载图形安装程序。
3.  CentOS 安装程序现在将显示图形安装欢迎屏幕。从这一点开始，您可以使用键盘和鼠标(强烈建议使用后者)，但是如果您打算使用键盘，请记住启用键盘上的数字锁。
4.  在左侧，您可以看到主语言类别，在右侧，您可以看到安装程序的子语言。您也可以使用左下角的文本框搜索语言。对语言设置的所有更改将立即生效，因此当您准备好时，选择**继续**按钮继续。
5.  现在我们到达主安装菜单，叫做**安装总结**。
6.  这里显示的大多数选项已经有了一些预定义的值，可以在不改变的情况下使用，其他没有任何默认值并且需要您注意的选项用红色感叹号标记，就像**系统**类别下的**安装目的地**一样。所以让我们用鼠标点击它。
7.  单击**安装目的地**按钮后，您将看到当前连接到您的计算机的所有硬盘设备的图形列表，您可以使用该列表安装操作系统。您可以通过单击正确的硬盘符号来选择目标硬盘。然后它会在上面打上一个复选标记。如果您不确定正确的硬盘，请尝试通过比较菜单中显示的品牌和总大小来识别它。在安装继续之前，您必须选择一个硬盘。请谨慎选择您的目标硬盘，因为它会在安装过程中擦除其上的任何现有数据。准备好之后，点击**完成**按钮。
8.  如果您的选择的硬盘已经包含数据，那么当点击**完成时，**您可能会看到一条警告/错误消息。信息可能是:**您没有足够的空间安装 CentOS** 。别担心！这是意料之中的，消息只是要求您重新初始化硬盘，因为 CentOS 只能安装在空磁盘上。在大多数情况下，尤其是硬盘上有多个分区的情况下，只需点击**回收空间**，将显示一个新窗口，其中包含该驱动器上所有分区的详细列表。这里只需点击**全部删除**，然后再次点击**回收空间**即可丢弃该磁盘上的任何数据，这将完成磁盘初始化任务，并使您能够继续下一步。完成后，点击**完成**按钮。
9.  回到**安装总结**画面，**安装目的地**项上的感叹号现在应该没了。
10.  或者，我们可以点击**系统类别**下的**网络&主机名**。在下一页的左侧，您可以选择要连接到互联网的主网络适配器，并通过单击选择它。对于所选设备，点击右侧的开关启用，并使用开关的**开**位置自动连接。最后，在关闭此子菜单之前，将它的文本字段中的主机名更改为适当的名称。点击**完成**。
11.  现在回到**安装总结**画面，所有重要设置都已经做好或者已经得到预定义值，所有感叹号都没有了。如果您对这些设置满意，请点击**开始安装**按钮或适当更改设置。
12.  在下一个屏幕上，当新系统在后台安装时，您需要为根用户创建并确认根密码。选择不少于六个字符的安全密码。
13.  在此屏幕上，您还可以创建一个强烈推荐的标准用户帐户。如果你创建了一个新用户，不要勾选**让这个用户成为管理员**。准备好之后，点击**完成**(如果输入的是弱密码，需要点击两次确认)
14.  CentOS 现在将在后台对您的硬盘进行分区和格式化，并解决任何依赖关系，安装程序将开始写入硬盘。这可能需要一些时间，但是进度条会指示您的安装状态。完成后，安装程序将通知您整个过程已经完成，并且安装成功。所以当你准备好了，点击**重启**按钮。现在从驱动器中释放安装介质。
15.  恭喜你！您现在已经在计算机上安装了 CentOS 7。

## 它是如何工作的…

在这个食谱中，你已经发现了如何安装 CentOS 7 操作系统。已经介绍了图形安装过程的典型方法，现在您可以使用额外的配置更改和包来开发服务器，这些更改和包将适合您希望服务器履行的角色。这种图形安装程序的目的是非常直观和灵活，并使安装非常容易，因为它将引导用户通过一些强制性任务，他必须履行之前，安装主系统可以开始。

# 通过 HTTP 运行网络安装

在本食谱中，我们将学习如何启动通过 HTTP 运行网络安装的过程(使用网址方法)，以便安装 CentOS 7。这是一个过程，在这个过程中，使用一个小的映像文件来引导计算机，让用户只选择和安装他想要的软件包和服务，而不通过网络连接进行其他操作，从而提供了极大的灵活性。

## 做好准备

在我们开始之前，假设您已经知道如何下载和校验 CentOS 7 安装映像，以及如何从中创建相关的安装介质。对于这里的这个配方，我们需要下载并创建 netinstall 映像的安装介质(下载最新的 CentOS-7-x86 _ 64-NetInstall-xxxx . iso 文件)，而不是本章另一个配方中显示的最小 ISO。此外，假设您至少已经完成了一次图形安装过程，以确切知道如何从安装介质引导并使用安装程序。

## 怎么做...

要开始此食谱，请插入您准备好的网络安装介质，从中启动您的计算机，并等待欢迎屏幕出现:

1.  在欢迎闪屏上，预选了选项**测试该媒体&安装 CentOS 7** ，我们将使用该选项。准备好之后，按下*返回*键继续。
2.  After the tests finish, the graphical installer will load and present the typical graphical installation summary screen.

    ### 注

    这里，除了对**网络&主机名**和**安装源**菜单项(用红色感叹号显示)进行以下强制性更改之外，安装程序应完全按照正常的图形安装方法进行配置。

3.  在我们通过网络安装 CentOS 之前，我们必须确保我们有一个工作正常的网络连接。因此，您应该首先点击**网络&主机名**菜单项，并将您的一个网络适配器激活到连接状态。有关更多详细信息，请参考正常安装方法。
4.  接下来，点击**安装源**进入设置。由于我们将通过 HTTP(也称为 URL 方法)安装，您应该保留在**中选择的网络默认**您想使用哪个安装源** **？**段。**
***   现在在标准`http://`文本字段中输入以下网址，我们将使用该网址在[http://mirror.centos.org/centos/7/os/x86_64/](http://%20http://mirror.centos.org/centos/7/os/x86_64/)下载所有需要的安装包。*   或者，您也可以使用您必须提前创建的个人存储库(参见[第 4 章](04.html#1AT9A1-4cf34a6d07944734bb93fb0cd15cce8c "Chapter 4. Managing Packages with YUM")、*使用 YUM* 管理包)*   准备好之后，点击**完成**开始初始化过程。*   成功后，安装程序将开始检索适当的`install.img`文件。这可能需要几分钟才能完成，但一旦解决，进度条将显示所有下载活动。当此过程成功完成时，**安装源**的感叹号将消失，但会弹出另一个感叹号，告诉用户它缺少**软件选择**。点击它，选择任何适合你的需求。至于这个食谱的用途，只需在**基础环境**下选择**最小安装**，然后点击**完成**。*   如果您想要使用的**安装源**保持灰色并且无法更改，则您的网络适配器存在连接问题。如果是这种情况，请返回配置**网络&主机名**并更改网络设置，直到达到连接状态。*   CentOS 7 现在将以通常的方式安装操作系统，并在此过程完成时向您表示祝贺。这可能比从物理安装介质安装要慢，因为所有软件包都必须从互联网上检索。**

 **## 它是如何工作的...

这个食谱的目的是向您介绍 CentOS 网络安装过程的概念，以便向您展示这种方法有多简单。通过完成此方法，您不仅通过将初始下载限制在安装过程所需的文件上节省了时间，而且还能够利用完整的图形安装方法，而不需要完整的 DVD 套件。

# 使用 kickstart 文件安装 CentOS 7

虽然在单个服务器上使用图形安装实用程序手动安装 CentOS 7 很好，但在多个系统上安装可能会很繁琐。Kickstart 文件可以自动化服务器系统的安装过程，这里我们将展示如何做到这一点。它们是简单的基于文本的配置文件，提供了如何设置和安装目标系统的详细和准确的说明(例如，要安装哪个键盘布局或附加软件包)。

## 做好准备

要成功完成此方案，您需要访问已安装的 CentOS 7 系统，以检索我们想要使用的 kickstart 配置文件，并用于自动安装。在这个预装的 CentOS 服务器上，您还需要一个可用的互联网连接来下载其他软件。

接下来，我们需要为 DVD 或“一切”映像下载并创建安装媒体(下载最新的`CentOS-7-x86_64-DVD-XXXX.iso`或`CentOS-7-x86_64-Everything-XXXX.iso`文件)，而不是本章另一个食谱中显示的最小 iso 文件。然后，您需要另一个 USB 设备，它必须在 Linux 系统上可读写(格式化为 FAT16、FAT32、EXT2、EXT3、EXT4 或 XFS 文件系统)。

## 怎么做...

为了让这个方法起作用，我们首先需要从另一个完成的 CentOS 7 安装中物理访问现有的 kickstart 文件，我们将把它用作新的 CentOS 7 安装的模板。

1.  在现有的 CentOS 7 系统上以 root 用户身份登录，通过键入以下命令并按下*返回*键来执行(这将向您显示文件的详细信息):

    ```sh
    ls -l /root/anaconda-ks.cfg

    ```

2.  接下来，物理插入一个 USB 设备，然后键入以下命令，该命令将为您提供当前连接到计算机的所有硬盘设备的列表:

    ```sh
    fdisk -l

    ```

3.  尝试通过将设备的大小、分区和识别的文件系统与您的 USB 设备的规格进行比较来识别设备名称。设备名称将是某种类型的`/dev/sdX,`，其中`X`是字母字符，例如`b`、`c`、`d`、`e`、…等等。如果您无法使用`fdisk`命令为您的 USB 媒体找到正确的设备名称，请尝试以下技巧:运行`fdisk -l`两次-首先使用插入式 USB 设备，然后使用插入式 USB 设备，并比较第二个输出如何变化-它比第一个输出多一个设备名称:您感兴趣的设备名称！
4.  如果您在列表中找到了正确的设备名称，请创建一个目录将其装载到当前文件系统中:

    ```sh
    mkdir /mnt/kickstart-usb

    ```

5.  接下来，假设您选择的 USB 分区位于`/dev/sdc1`(根据需要更改此分区):

    ```sh
    mount /dev/sdc1 /mnt/kickstart-usb

    ```

    ，实际将记忆棒安装到该文件夹中
6.  现在，我们将在 USB 设备上创建 kickstart 文件的工作副本，用于定制:

    ```sh
    cp /root/anaconda-ks.cfg /mnt/kickstart-usb

    ```

7.  接下来，用你喜欢的文本编辑器在 USB 设备上打开复制的 kickstart 文件(这里我们将使用编辑器 nano，如果你还没有安装它，请键入`yum install nano` ):

    ```sh
    nano /mnt/kickstart-usb/anaconda-ks.cfg

    ```

8.  我们现在将修改文件，以便在新的目标系统上安装 CentOS。在 nano 中，使用向上和向下箭头键转到以(`<your_hostname>`将是您在安装过程中给出的主机名的名称，例如`minimal.home`)开头的行:

    ```sh
    network  --hostname=<your_hostname>

    ```

9.  现在编辑`<your_hostname>`字符串，给它一个新的唯一主机名。例如，在任何现有名称的末尾添加一个`-2`，如下所示:

    ```sh
    network  --hostname=minimal-2.home

    ```

10.  接下来，使用上下箭头键向下移动光标，直到它停在表示`%packages.`的那一行。在它的正下方添加以下几行(您可以进一步自定义并提供您想要自动安装的附加软件包):

    ```sh
    mariadb-server
    httpd
    rsync
    net-tools

    ```

11.  现在保存并关闭文件，在 nano 编辑器中使用组合键 *Ctrl* + *o* (也就是说，按住键盘上的 *Ctrl* 键，然后按住 *o* 键，不要松开 *Ctrl* 键)来写更改。然后按*返回*确认文件名，按 *Ctrl* + *x* 退出编辑器。
12.  接下来，安装以下 CentOS 包:

    ```sh
    yum install system-config-kickstart

    ```

13.  现在，我们使用`ksvalidator`程序验证 kickstart 文件的语法，该程序包含在我们刚刚安装的包中:

    ```sh
    ksvalidator /mnt/kickstart-usb/anaconda-ks.cfg

    ```

14.  如果`config`文件没有错误，现在使用以下命令卸载 u 盘:

    ```sh
    cd
    umount /mnt/kickstart-usb

    ```

15.  当您再次收到新的命令提示符时，请从系统中拔出带有 kickstart 文件的 USB 设备，以便在目标机器上实际使用。
16.  现在，您需要使用刚刚创建的 kickstart 文件物理访问要安装 CentOS 的目标计算机。断开安装过程中不需要的任何其他外部文件存储。
17.  打开电脑电源，放入您准备好的 CentOS 安装介质(必须是 CentOS DVD 或在 CD/DVD 光盘或 USB 设备安装程序上准备好的 Everything 安装盘映像)。此外，将包含您在前面步骤中刚刚创建的 kickstart 文件的 u 盘连接到计算机(如果您使用 u 盘安装 CentOS，那么您总共需要两个空闲的 USB 端口来完成此方法)。
18.  接下来，启动服务器，并在初始启动屏幕中按下正确的键，这与启动您刚刚连接的 CentOS 安装介质相关。
19.  CentOS 安装程序开始加载后，将显示通用标准 CentOS 7 安装欢迎屏幕，光标将预先选择选项**测试该介质&安装 CentOS 7** 。
20.  接下来，按一下键盘上的 *Esc* 键切换到`boot: prompt`。
21.  Now we are ready to start the kickstart installation. To do this, you need to know the exact partition name on the USB device where the kickstart file is located. Type the following command, assuming that your partition is at `/dev/sdc1` (change this as required), and press the *Return* key to start the kickstart installation process:

    ```sh
    linux ks=hd:sdc1:/anaconda-ks.cfg

    ```

    ### 注

    如果您找不到 u 盘的正确设备和分区名称，您必须在救援模式下启动目标系统(参考*在救援模式下对系统进行故障排除*方法)，通过将其大小、分区和识别的文件系统与 u 盘的规格进行比较来识别正确的设备名称和分区号。

22.  新系统现在使用提供的 kickstart 文件中的说明自动安装。您可以观看安装输出消息，因为它向用户显示了详细的安装进度。
23.  如果系统已完成安装，请重新启动系统并登录到您的新机器，以验证新系统已按照我们使用 kickstart 文件描述的方式进行了设置。

## 它是如何工作的...

在本食谱中，您已经看到运行 CentOS 7 安装的每台服务器都将 kickstart 文件保存在其根目录中，该文件包含安装过程中如何设置系统的详细信息。kickstart 文件可用于自动安装具有相同配置的多个系统。这可以节省大量重复工作的时间，因为在安装过程中不需要用户交互。此外，如果目标机器不满足图形安装的最低内存要求，但需要文本模式安装程序不提供的其他功能(如系统的自定义分区)时，我们可以使用此方法。Kickstart 配置文件是简单的纯文本文件，可以从头手动创建。因为有很多不同的命令可以使用 kickstart 语法来构建您的系统，所以我们使用了一个现有的文件作为模板，并根据我们的需要对其进行了定制，而不是从全新的开始。我们没有使用最小安装映像来驱动 kickstart 安装，因为我们安装了一些不包含在最小 ISO 文件中的额外软件包，例如 Apache 网络服务器。

# 开始并定制引导加载程序

当您打开计算机时，引导加载程序是第一个启动的程序，负责加载并向底层操作系统传输控制。如今，几乎任何现代 Linux 发行版都使用 **GRand Unified Bootloader 版本 2** ( **GRUB2** )来启动系统。它在配置上有很大的灵活性，支持很多不同的操作系统。在本食谱中，我们将展示如何通过禁用菜单显示的等待时间来定制 GRUB2 引导加载程序，从而缩短引导系统所需的时间。

## 做好准备

要完成此方法，您将需要以 root 权限访问已安装的 CentOS 7 操作系统(最小或任何其他 CentOS 7 安装类型都可以)。此外，您需要对基于文本的编辑器(如 nano)有一些基本的经验，以便更改配置文件。

## 怎么做...

我们首先用我们选择的文本编辑器打开主 GRUB2 配置文件，并对其进行修改。

1.  首先以 root 用户身份登录到您的系统，并创建 GRUB2 配置文件的副本，以便在需要时进行备份和回滚。按*返回*键完成:

    ```sh
    cp /etc/default/grub /etc/default/grub.BAK

    ```

2.  用以下命令打开我们想要编辑的主 GRUB2 配置文件，然后按下*返回*键(这里我们将使用编辑器 nano，如果您还没有安装它，请键入`yum install nano` ):

    ```sh
    nano /etc/default/grub

    ```

3.  在光标所在的第一行按*回车*键，在顶部插入新的一行，然后插入以下一行:

    ```sh
    GRUB_HIDDEN_TIMEOUT=0

    ```

4.  在下一行的开头加上`#`符号，如图所示:

    ```sh
    GRUB_TIMEOUT=0

    ```

5.  现在使用的 *Ctrl* + *将文件保存在 nano 中(并且*返回*以确认要保存的文件名)。使用 *Ctrl* + *x* 退出编辑器，然后运行以下命令:

    ```sh
    dmesg | grep -Fq "EFI v"

    ```* 
6.  如果前面的命令没有产生任何输出，运行以下命令:

    ```sh
    grub2-mkconfig -o /boot/grub2/grub.cfg

    ```

7.  否则，如果有输出，运行:

    ```sh
    grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg

    ```

8.  如果`grub2-mkconfig`成功，它将打印`Done.`现在使用以下命令重新启动您的系统:

    ```sh
    reboot

    ```

9.  在重新启动过程中，您会注意到 GRUB2 启动菜单将不再出现，系统将更快启动。

## 它是如何工作的...

完成这个配方后，我们现在知道如何定制 GRUB2 引导加载程序。在这个非常简单的食谱中，我们只向您展示了对引导加载程序的非常基本的修改，但它可以做得更多！它支持多种文件系统，几乎可以引导任何兼容的操作系统。如果您计划在同一台机器上运行多个操作系统，这也特别有用。要了解更多有关 GRUB2 配置文件语法的信息，请键入`info grub2` | `less`命令，然后转到`6.1 Simple configuration handling`部分(阅读[第 2 章](02.html#MSDG1-4cf34a6d07944734bb93fb0cd15cce8c "Chapter 2. Configuring the System")、*配置系统*中的*使用较少的*导航文本文件，了解如何浏览本文档)。

# 在救援模式下排除系统故障

我们都会犯错误，对于新手 Linux 系统管理员来说尤其如此。Linux 可能会有一个陡峭的学习曲线，在你的职业生涯中，迟早会有一个点，由于多种原因，包括硬件问题或配置错误等人为错误，你的 CentOS 安装无法启动。如果这种情况发生在您身上，那么您可以使用 CentOS 救援模式来启动一个无法启动的系统，并尝试撤销您的错误或找出问题的根源。在本食谱中，我们将向您展示使用该选项的三个常见用例:

*   如果 CentOS 未启动，访问文件系统以恢复重要数据或撤销对配置文件的更改
*   如果忘记了，请更改根密码
*   在安装了 CentOS 的同一硬盘上安装另一个操作系统时，重新安装可能会损坏的引导加载程序

## 做好准备

要完成此配方，您将需要标准安装的 CentOS 7 操作系统介质(光盘或 USB 设备)。要从系统中恢复数据，您需要将某种外部存储设备连接到系统，例如外部硬盘或与另一台计算机的工作网络连接，以将所有宝贵的数据复制到不同的位置。

## 怎么做...

要开始这个方法，您应该从 CentOS 安装光盘或 USB 设备引导您的服务器，等待直到第一个欢迎闪屏出现，光标在**测试这个媒体&安装 CentOS 7** 菜单选项。

### 到达救援模式

1.  从主菜单中，使用向下箭头键选择**故障排除**，然后按*返回*键继续。
2.  在**故障排除**屏幕上，使用向下箭头键突出显示**救援中枢系统**。准备好之后，按下*返回*键继续。
3.  经过一段加载时间后，我们进入救援屏幕，其中包括各种确认子屏幕。要开始此部分，使用左右箭头键选择**继续**并按下*返回*键继续。
4.  在第一个子屏幕上，选择**确定**并按下*返回*键继续。
5.  再次，在下面的子画面中，选择**确定**并按下*返回*键继续。
6.  在下一屏，选择**启动**外壳，使用*选项卡*键，高亮**确定**并按*返回*键继续。
7.  通过完成上述步骤，您将启动一个 shell 会话。您会在显示屏底部注意到这一点。shell 会话的当前状态如下:

    ```sh
    bash-4.2#_

    ```

8.  在提示符下，键入以下指令来更改根文件系统，然后按下*返回*键来完成您的请求:

    ```sh
    chroot /mnt/sysimage

    ```

9.  恭喜你！你刚刚进入救援模式。要随时退出，只需键入以下命令，然后按下*返回*键完成您的请求(现在不要这样做，因为这会重新启动系统):

    ```sh
    reboot

    ```

10.  达到基本救援模式后，根据问题类型，我们有以下选项。

### 访问文件系统

如果您现在处于救援模式，并且需要从文件系统备份重要文件，则需要一个数据传输的目标位置。要将我们要恢复的数据从服务器传输到另一台计算机，请物理连接一个外部 USB 设备。您也可以使用网络存储进行恢复。例如，您可以导入 NFS 服务器共享并将数据复制到其中。参考[第七章](07.html#20R681-4cf34a6d07944734bb93fb0cd15cce8c "Chapter 7. Building a Network")、*搭建网络*中的*与 NFS 合作*食谱。

1.  在救援模式命令行，输入以下命令，显示当前所有连接到系统的分区，然后按*返回*键完成请求:

    ```sh
    fdisk -l

    ```

2.  现在，您需要找到正确的设备名称以及所连接设备的分区号；将各种设备的总大小或文件系统输出与棒上的规格进行比较可以帮助您完成这一过程。您也可以尝试以下技巧:运行`fdisk -l`命令两次，首先使用插入的 USB 设备，然后再次使用拔出的 USB 设备，并比较两个命令的输出。它应该与您正在搜索的设备名称不同！
3.  如果您在列表中找到了正确的设备名称，请创建一个目录，将记忆棒安装到文件系统中:

    ```sh
    mkdir /mnt/hdd-recovery

    ```

4.  接下来，将磁盘分区装入该文件夹。这里我们假设感兴趣的 USB 设备具有设备名称`sdd1`(如果系统不同，请更改):

    ```sh
    mount /dev/sdd1 /mnt/hdd-recovery

    ```

5.  如果您需要访问原始系统的硬盘根分区，例如更改导致启动问题的配置文件或进行完整或部分备份，救援系统会自动将其安装在特定文件夹下(在`/mnt/sysimage`下)。例如，如果您需要备份您的 Apache 网络服务器配置文件，请使用:

    ```sh
    cp -r /mnt/sysimage/etc/http /mnt/hdd-recovery

    ```

6.  如果您需要访问当前挂载的根分区之外的分区上的数据，请使用`fdisk -l`来识别感兴趣的分区。然后创建一个目录，将分区装载到其中，并更改到该目录以访问您的数据，就像装载 USB 设备时一样。
7.  要完成文件备份，请键入:

    ```sh
    reboot

    ```

### 访问文件系统

1.  如果您处于更改根密码的救援模式，只需使用以下命令并提供新密码:

    ```sh
    passwd

    ```

2.  要完成更改密码，请键入:

    ```sh
    reboot

    ```

### 重新安装 CentOS 引导加载程序

1.  我们现在将使用`fdisk`命令找到所有当前分区的名称。为此，请键入以下指令，然后按下*返回*键以完成您的请求:

    ```sh
    fdisk –l

    ```

2.  现在运行以下命令:

    ```sh
    dmesg | grep -Fq "EFI v"

    ```

3.  如果前面的命令没有产生任何输出，请在引导列的`fdisk`列表中查找`*`符号，以找到正确的开始分区，并假设您的引导磁盘位于`/dev/sda1`(根据需要进行更改)，请键入以下内容:

    ```sh
    grub2-install /dev/sda

    ```

4.  否则，如果有输出，则改为运行:

    ```sh
    yum reinstall grub2-efi shim

    ```

5.  如果没有报告错误，控制台应做出如下响应:

    ```sh
    # this device map was generated by anaconda
    (hd0) /dev/sda

    ```

6.  最后一步的控制台输出已经确认 GRUB 现在已经成功恢复。
7.  要重新启动计算机，请键入:

    ```sh
    reboot

    ```

## 它是如何工作的...

通过救援模式环境提供的工具可以解决各种各样的问题。这些问题通常指的是引导问题，但也可能来自不同的类型，例如忘记根密码。救援模式可以拯救生命，了解它是一项非常重要的技能。因此，人们认为，这样一种方法应该近在咫尺。

### 类型

请记住，在使用引导加载程序命令时一定要小心，因为使用不当会导致操作系统无法启动。

# 使用额外的管理和开发工具更新安装并增强最小安装

在本食谱中，我们将学习如何使用额外的工具来增强最小安装，这些工具将为您提供各种管理和开发选项，这反过来将在服务器的生命周期中证明是至关重要的，并且对于本书中的一些食谱来说是必不可少的。最小安装可能是安装服务器最有效的方式，但话虽如此，最小安装确实需要一些额外的功能，以使其成为更引人注目的模式。

## 做好准备

要完成此方法，您需要最低限度地安装具有 root 权限的 CentOS 7 操作系统，并连接到互联网，以便于下载更多软件包。

## 怎么做...

我们将通过更新系统开始这个食谱。

1.  要更新系统，请以 root 用户身份登录，并键入:

    ```sh
    yum -y update

    ```

2.  CentOS 现在将搜索相关更新，如果可用，将安装这些更新。完成后，根据更新的内容(即内核和新的安全特性，仅举几个例子)，您可以决定重新启动计算机。为此，请键入:

    ```sh
    reboot

    ```

3.  您的服务器现在将重新启动并返回登录屏幕。我们现在将完成这个配方，并使用一系列将来会非常有用的包组来增强我们当前的安装。为此，请以 root 用户身份登录，并键入:

    ```sh
    yum -y groupinstall "Base" "Development Libraries" "Development Tools"
    yum -y install policycoreutils-python

    ```

## 它是如何工作的...

本食谱的目的是增强 CentOS 7 操作系统的最小安装，通过这样做，您不仅向自己介绍了 **黄狗更新程序修改后的** ( **YUM** )包管理器(我们将在本书的后面部分回到这一点)，而且您现在有了一个能够立即运行大量应用程序的系统。

那么我们从这次经历中学到了什么呢？

我们通过更新系统来启动配方，以确保它是最新的。在这个阶段，重启系统通常是个好主意。预计我们不会经常这样做，但预计在安装操作系统后首次更新时会这样做，因为很可能会有重大变化。这背后的原因通常是基于利用新内核或修改后的安全更新的愿望。在下一阶段，食谱向您展示了如何添加一系列将来可能会非常有用的包组。为了节省时间，我们包装了安装三个主要软件包组的说明:`Base`、`Development Libraries,`和`Development Tools`。仅上述操作就安装了 200 多个单独的包，从而使您的服务器能够即时编译代码并运行大量应用程序，这可能是您在服务器生命周期中所需要的。要查看一个组内所有包的列表，例如，从`Base,`运行`yum groupinfo Base`命令。我们安装的另一个软件包是`policycoreutils-python`，它提供了管理对 Linux 的安全增强访问控制的工具和程序，我们将在本书的各个章节中经常使用它。**