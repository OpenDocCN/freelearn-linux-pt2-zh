# 扫描和审计 Linux

在本章中，我们将讨论以下内容:

*   在 Linux 上安装防病毒软件
*   用 ClamAV 扫描
*   寻找 rootkits
*   使用审计守护程序
*   使用 ausearch 和 aeroport 读取日志
*   使用 systemctl 审核系统服务

# 在 Linux 上安装防病毒软件

在当今的环境中，病毒和恶意威胁可以在任何系统中找到，包括 Linux。因此，作为系统管理员，我们可以在我们的 Linux 服务器上使用防病毒软件。

**ClamAV** ，就是这样一款开源杀毒软件，用于检测和清除 Linux 系统上的病毒、木马、恶意软件和其他威胁。

# 准备好

ClamAV 可以从 Ubuntu 的默认存储库中安装。但是如果要从源码安装，可以从:[http://www.clamav.net/download.html.](http://www.clamav.net/download.html)下载官方源码

# 怎么做...

在本节中，我们将看到如何在我们的 Ubuntu 服务器上安装 ClamAV 防病毒软件:

1.  在开始安装工具之前，我们将通过运行以下命令来更新存储库:

![](assets/c2b4aacd-d50d-4c20-adf7-762ab2f6ab83.png)

2.  接下来，我们将运行以下命令来安装 ClamAV 防病毒软件:

![](assets/0121c472-38b7-45c9-8ebf-cd5377bd54b6.png)

![](assets/5fc8438b-d102-429d-bcd0-17a67f980363.png)

3.  我们还可以使用以下命令为同一工具安装图形用户界面:

![](assets/777972f1-47f5-4ca0-909a-7498a7e18aea.png)

4.  安装完成后，我们可以通过运行以下命令来检查安装的软件包版本:

![](assets/17c757fb-9e36-43cf-9765-86c28569ab48.png)

5.  命令行版本可以通过使用`clamscan`后跟适当的选项来使用。
6.  要打开 ClamAV 的 GUI 版本，请转到主菜单，并搜索工具，如下所示:

![](assets/cc03fc20-fb38-4c56-8f52-31d90b5031bb.png)

7.  当我们打开 GUI 版本时，它将如下所示打开:

![](assets/6c69c9d2-0f42-4a84-9610-5946fb592d05.png)

# 它是如何工作的...

ClamAV 可以很容易地安装在 Linux 系统上，要么使用 Linux 的默认存储库，要么从其官方网站下载源代码。

ClamAV 可以从命令行和图形用户界面中使用。

# 用 ClamAV 扫描

**ClamAV** 是一款跨平台的杀毒软件，能够检测不同类型的恶意软件，包括病毒。它包括各种实用程序，如命令行扫描程序、数据库更新程序和多线程守护程序，使其成为一个强大的工具。

# 准备好

我们必须安装该工具的命令行版本或图形用户界面版本，然后才能在系统上运行扫描。该工具可以按照上一节中的讨论进行安装。

# 怎么做...

在这一节中，我们将看到如何使用 ClamAV 来执行扫描；按照我们的要求。

1.  作为第一步，我们将检查工具的帮助菜单，以查看 ClamAV 支持的不同选项，如下所示:

![](assets/994cc242-2d72-459e-9546-c6caba67bd8a.png)

2.  如下图所示，ClamAV 支持扫描过程中使用的各种选项:

![](assets/b86e75dd-4d77-4460-8fb1-b4925aa1feca.png)

3.  我们现在开始扫描`/home`目录，如下图所示:

![](assets/2bcd0143-9511-4230-b33f-0fffc1624b73.png)

4.  扫描完成后，它会显示如下扫描摘要:

![](assets/de95d551-0bbf-4a3d-b2a4-9218c666e5ff.png)

5.  我们也可以使用图形用户界面版本运行扫描。打开工具后，我们通过单击设置来更改扫描设置。这将打开一个窗口，如下所示:

![](assets/9c776481-b7fa-4f4f-96e8-6b53f5ced102.png)

在前面的窗口中，根据我们的要求选中或取消选中选项。

6.  接下来，单击扫描文件或扫描目录开始相应的扫描:

![](assets/8b725f78-30fa-4830-97e1-ac613967bade.png)

7.  扫描将开始运行，如下所示:

![](assets/e4f75832-5b9f-41ac-abb8-0cf338398b34.png)

8.  扫描完成后，如果未发现威胁，它将显示调查结果或显示以下消息:

![](assets/01ace307-c67c-4052-8ba5-adbad03696b4.png)

9.  通过单击更新，我们可以检查软件可用的特征码更新:

![](assets/47dacb3d-cf88-4e48-b215-192b004d3dee.png)

# 它是如何工作的...

**ClamAV** 是一个通用的工具，支持多种文件格式和多种签名语言，大多数病毒会使用它们来利用系统。它可以执行多线程扫描。

# 寻找 rootkits

如今，连接到互联网的服务器每天都面临不断的攻击。作为系统管理员，建议您定期进行检查，以确保没有攻击者能够进入。

通过使用不同的工具，我们可以防止恶意软件和 rootkits 安装到我们的服务器上。

# 准备好

在我们的 Linux 系统上使用扫描工具没有具体要求。

# 怎么做...

在本节中，我们将了解如何安装和配置 Linux rootkit 扫描工具，并按照我们的要求使用:

1.  首先，我们将安装`chkrootkit`，一个经典的 Linux rootkit 扫描仪，如下图所示:

![](assets/cdfadde7-8f57-4f2a-8860-4bcd75546e23.png)

2.  安装软件后，我们可以通过运行以下命令来检查软件的安装路径:

![](assets/c47c2f6c-1545-4538-be7f-ec0bacb7980d.png)

3.  接下来，我们查看“帮助”菜单，了解可用于运行该工具的选项:

![](assets/69a3f2d4-714a-46c1-baf2-1fd0a8b90f71.png)

4.  如果我们想查看 chkrootkit 中可用测试的列表，我们可以运行以下命令:

![](assets/6085af77-e95f-4966-8189-3b57f7515b75.png)

5.  现在，让我们开始扫描，如下所示:

![](assets/817e7d19-d931-42a4-ace0-7830d7300f2b.png)

6.  正如我们在扫描输出中看到的，软件正在检查所有已知的 rootkit 签名:

![](assets/07a656cf-e224-43b3-9c84-756c54fd2283.png)

7.  另一个众所周知的可以用来扫描 rootkits 的工具是`rkhunter`。通过运行以下命令安装该工具:

![](assets/2566bf41-5426-46ba-a127-0e81a08ca044.png)

8.  接下来，查看帮助菜单，查看运行软件时可以使用的选项:

![](assets/3afcc33d-9bd9-470e-8bbd-e8b3a2d40bee.png)

9.  现在，开始扫描，如下所示:

![](assets/750cfdbd-ff6e-4689-9261-2caccc64185a.png)

10.  如输出所示，已检查所有已知的 rootkit 签名，但未找到任何签名:

![](assets/fde92c07-f971-46a8-8d44-75c9f7b4946c.png)

11.  最后，当扫描完成时，该工具将显示扫描摘要，如下所示:

![](assets/0c11f4ea-83f5-43e5-8628-0f1b2e5a1a11.png)

# 它是如何工作的...

Chkrootkit 和 rkhunter 都是基于 Linux 的开源 rootkit 扫描工具，有助于扫描可能存在于 Linux 机器中的 rootkit。

这两个工具都使用基于签名的扫描来检查 Linux 系统上的 rootkits 和任何其他恶意软件。

# 使用审计守护程序

当我们谈论保护系统时，它包括许多程序，审计系统就是其中之一。Linux 系统有一个名为**audited**的预装工具，负责将审计记录写入磁盘。

# 准备好

在 Linux 系统上使用 auditd 没有具体要求。

# 怎么做...

在本节中，我们将了解如何使用 auditd 来进行审计:

1.  如果该工具尚未安装在我们的 Linux 发行版上，我们可以通过运行以下命令来安装它:

```sh
apt-get install auditd
```

2.  安装软件包时，作为安装过程的一部分，它还会安装一些其他工具。安装的工具之一是`auditctl`，它有助于控制软件的行为，也有助于添加规则。

3.  我们可以通过运行以下命令来检查工具的版本:

![](assets/764dc05a-b374-4f20-b7f4-52439f17df93.png)

4.  首次安装 auditd 时，它还没有任何可用的规则。这可以通过运行以下命令来检查:

![](assets/aa9b87a7-ae10-4789-b65f-87fe1aaaba5c.png)

5.  现在，让我们看看“帮助”菜单，查看可以与该工具一起使用的其他选项:

![](assets/13e67e3d-9846-4fc8-9f12-620802d4bfe8.png)

6.  要开始使用`auditd`工具，需要有规则。我们可以添加审核文件的规则，如下所示:

![](assets/3d9a2f51-01cf-48a6-acb2-a0446e4ef2a6.png)

在前面的命令中，`-w`选项将告诉 auditd 在指定的文件上保持监视。`p`选项指定 auditd 应该触发的权限。然后`wxa`分别指读、写、执行和属性。

7.  我们还可以添加监视目录的规则，如下所示:

![](assets/36b77be8-3610-4cca-8f99-483869db5c4a.png)

8.  如果我们现在检查规则列表，我们会得到以下输出:

![](assets/adf32b9c-ee8d-496f-9634-8c4dd623c4b1.png)

# 它是如何工作的...

`auditd`有助于定义规则，根据这些规则，它将监视指定的文件和目录。如果对这些文件和目录进行了任何更改，则`auditd`将根据已定义的规则触发。

# 使用 ausearch 和 aeroport 读取日志

在前一节中，我们已经看到了如何使用 auditd 工具来定义规则和监视特定的文件和目录。

要从审核的日志文件中检索数据，我们可以使用`ausearch`工具，通过使用`aureport`，我们可以基于这些日志生成报告。

`ausearch`是一个命令行工具，用于根据事件和其他搜索条件搜索 auditd 守护程序的日志文件。

类似地，`aureport`也是一个命令行工具，帮助从 audidt 守护程序的日志文件创建有用的摘要报告。

# 准备好

当我们安装 auditd 守护程序时，它也会安装 ausearch 和 aureport 工具。所以使用这些工具不需要额外的安装。

# 怎么做...

在本节中，我们将看到如何使用 ausearch 和 aureport 工具来读取 auditd 守护程序的日志文件并从中创建报告:

1.  查找审计日志的默认位置是`/var/log/audit/audit.log`。如果我们查看这个文件的内容，我们会得到如下所示的输出:

![](assets/66f71006-0deb-484e-8a39-914dc407a01d.png)

正如我们在这个输出中看到的，日志包含大量数据，我们很难从这个文件中获得特定的信息，仅仅通过查看它的内容。

2.  因此，我们将使用`ausearch`以更强大、更高效的方式搜索日志。首先，我们检查工具的帮助文件，了解可以使用的选项:

![](assets/2307eb9d-8a64-4749-aaf8-1f672b04bb47.png)

3.  假设我们想要检查与特定运行进程相关的日志；我们可以通过使用`-p`标志并将进程 ID 传递给`ausearch`命令来做到这一点，如下所示:

![](assets/f25213f0-8ff1-4d6e-ad8e-7aefe661c798.png)

正如我们在这个输出中看到的，现在只显示特定流程标识的信息。

4.  如果我们想检查用户帐户的失败登录尝试，我们可以通过运行以下命令来完成:

![](assets/4ce998d3-b9a9-46a7-96b5-497915899be4.png)

5.  要查找任何特定用户帐户的用户活动，我们可以运行以下命令:

![](assets/15f515d7-21f5-41e7-887a-008b2b5e9870.png)

在前面的命令中，`pentest`是我们要查询的用户名。

6.  我们还可以使用`ausearch`查询任意用户在给定时间段内执行的动作。在下面的命令中，我们使用`-ts`作为开始日期/时间，使用`-te`作为结束日期/时间:

![](assets/5ed92c4b-385a-47c8-ba73-2a833d5b3a46.png)

7.  如果我们想基于 auditd 守护程序添加的审核规则关键字创建报告，我们可以使用以下命令，使用`-k`标志:

![](assets/1e2c139a-f761-4afc-bb08-79159a8e6a38.png)

9.  如果我们想将数字实体转换为文本(如 UID 转换为帐户名)，在使用前面的命令创建的报表中，我们可以添加`-i`标志，如下所示:

![](assets/581dd5aa-c190-458c-bc60-eb3eb325569c.png)

10.  要创建与用户身份验证相关的事件报告，我们可以使用以下命令:

![](assets/560574b8-aa7c-4fb9-bfe5-d077335141f0.png)

11.  要创建所有登录的报告，我们使用`-l`标志，如下所示:

![](assets/21855408-41f4-4f6e-a433-867025a9d906.png)

12.  如果我们想要查看失败登录事件的报告，我们可以使用以下命令:

![](assets/2c6e9a29-ee6a-4b8d-8ac1-66939d1032ea.png)

13.  类似于`ausearch`，我们可以使用`aureport`创建特定时间段的报表，如下图所示:

![](assets/bf39122d-bdc6-4fbf-8947-587aa036633a.png)

# 它是如何工作的...

ausearch 和 aureport 与 auditd 守护程序一起工作。使用 auditd 记录事件数据的日志文件，ausearch 可以帮助我们按照要求通读日志。同样，使用 aureport，我们可以基于 auditd 守护程序的日志文件创建有用的报告。

# 使用 systemctl 审核系统服务

**Systemd** 是一个 init 系统，也是一个系统管理器，已经成为 Linux 系统的新标准。为了控制这个初始化系统，我们有一个中央管理工具，叫做 systemctl。使用 systemctl，我们可以检查服务状态，管理服务，更改它们的状态，并使用它们的配置文件。

# 准备好

大多数 Linux 发行版都实现了 systemctl，所以它是预装的。

如果任何特定的 Linux 发行版没有预安装它，这意味着特定的 Linux 发行版没有使用 init 系统。

# 怎么做...

在本节中，我们将讨论如何使用 systemctl 命令对服务执行各种操作:

1.  为了确认我们的 Linux 发行版是否支持 systemctl，我们可以只运行命令`systemctl`，如下所示:

![](assets/a9305c09-0b3a-47fd-a230-c9dccd83de7d.png)

如果我们得到如这里所示的输出，它确认命令正在工作。如果我们收到一个错误，`bash: systemctl is not installed`，这意味着系统不支持该命令，因为它正在使用一些其他的初始化系统。

2.  如果我们想要检查任何特定服务的状态，例如 SSHD 服务，我们可以使用`systemctl`，如下所示:

![](assets/1e26d107-46b6-41e7-b573-f9bf1d6edc5d.png)

显示的输出清楚地告诉我们，SSHD 服务运行良好。

3.  要停止或启动任何服务，我们使用以下命令:

![](assets/2a5c0549-d27a-4f62-94a8-38329d29aa25.png)

4.  我们可以使用`systemctl`重新启动正在运行的服务。此外，如果任何特定服务支持重新加载其配置文件(无需重新启动)，我们可以使用带有`systemctl`命令的`reload`选项来实现，如下所示:

![](assets/982cd36a-4f87-4d48-a64b-f841cb8b25cd.png)

5.  我们可以使用`systemctl`命令查看 systemd 知道的所有活动单元的列表，如下所示:

![](assets/9902bd99-d69a-49c1-990e-68071c6f69e4.png)

6.  有时，我们可能希望看到特定服务的依赖树。这可以通过使用如下所示的`systemctl`命令来完成:

![](assets/6840785c-7d81-452a-8f9c-bc1a3dcbf026.png)

# 它是如何工作的...

`systemctl`允许我们与`systemd`实例进行交互和控制。我们将`systemctl`实用程序用于任何类型的服务和系统状态管理。

使用`systemctl`命令的不同选项，我们可以使用服务执行不同的活动。