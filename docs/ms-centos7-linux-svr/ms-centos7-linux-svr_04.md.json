["```\n$ sudo firewall-cmd --permanent --add-port=25/tcp\n$ sudo firewall-cmd --permanent --add-port=465/tcp\n$ sudo firewall-cmd --permanent --add-port=587/tcp\n$ sudo firewall-cmd --permanent --add-port=995/tcp\n$ sudo firewall-cmd --permanent --add-port=993/tcp\n$ sudo firewall-cmd --permanent --add-port=143/tcp\n$ sudo firewall-cmd --permanent --add-port=110/tcp\n$ sudo firewall-cmd --reload\n\n```", "```\n$ sudo yum install ntpd\n\n```", "```\n$ sudo nano /etc/ntp.conf\n\n```", "```\n#server 0.centos.pool.ntp.org iburst\nserver LOCAL_NTP_SERVER_IP_ADDRESS iburst\n\n```", "```\n$ sudo systemctl start ntpd\n$ sudo systemctl enable ntpd\n\n```", "```\n$ hostname -f\n\n```", "```\n$ sudo nano /etc/hosts\n$ sudo nano /etc/hostname\n\n```", "```\n$ sudo hostnamectl set-hostname\n\n```", "```\n$ sudo cat /etc/resolv.conf\n\n```", "```\n$ sudo nano /etc/resolv.conf\n\n```", "```\n$ sudo nano /etc/yum.repos.d/CentOS-Base.repo\n\n```", "```\n[base]\nname=CentOS-$releasever - Base\nexclude=postfix\n\n#released updates\n[updates]\nname=CentOS-$releasever - Updates\nexclude=postfix\n```", "```\n$ sudo yum --enablerepo=centosplus install postfix\n$ sudo yum install dovecot mariadb-server dovecot-mysql\n\n```", "```\n$ sudo nano /etc/postfix/main.cf\n\n```", "```\nmyhostname = server.packt.co.uk\n```", "```\nmydomain = packt.co.uk\n```", "```\nmyorigin = $mydomain\n```", "```\ninet_interfaces = all\n```", "```\nmydestination = $myhostname, localhost.$mydomain, localhost, $mydomain\n```", "```\nmynetworks = 127.0.0.0/8, 192.168.8.0/24, 10.0.1.0/24\n```", "```\nhome_mailbox = maildir/\n```", "```\nsmtpd_banner = $myhostname ESMTP\n```", "```\nmessage_size_limit = 10485760\n```", "```\nmailbox_size_limit = 1073741824\n```", "```\nsmtpd_sasl_type = dovecot\nsmtpd_sasl_path = private/auth\nsmtpd_sasl_auth_enable = yes\nsmtpd_sasl_security_options = noanonymous\nbroken_sasl_auth_clients = yes\nsmtpd_sasl_local_domain = $myhostname\nsmtpd_recipient_restrictions = permit_mynetworks,permit_auth_destination,permit_sasl_authenticated,reject\n```", "```\n$ sudo postconf -e 'myhostname = mailserver.packt.co.uk'\n\n```", "```\n$ sudo systemctl restart postfix\n$ sudo systemctl enable postfix\n\n```", "```\n$ echo \"Testing the Postfix mail service\" | mail -s \"This is a test mail\" user2@server.packt.co.uk && tail -f /var/log/maillog\n\n```", "```\nserver postfix/local[28480]: 98E2F61B6365: to=<user2@server.packt.co.uk>, relay=local, delay=0.02, delays=0.01/0/0/0, dsn=2.0.0, status=sent (delivered to maildir)\n\n```", "```\n$ sudo yum install mariadb-server\n\n```", "```\n$ sudo systemctl enable mariadb.service\n$ sudo systemctl start mariadb.service\n\n```", "```\n$ sudo mysql_secure_installation\n\n```", "```\n$ sudo mysql -u root -p\n\n```", "```\n> CREATE DATABASE mail;\n\n```", "```\n> USE mail;\n\n```", "```\n> GRANT SELECT, INSERT, UPDATE, DELETE ON mail.* TO 'mail_admin'@'localhost' IDENTIFIED BY 'mail_admin_password';\n> GRANT SELECT, INSERT, UPDATE, DELETE ON mail.* TO 'mail_admin'@'localhost.localdomain' IDENTIFIED BY 'mail_admin_password';\n\n```", "```\n> FLUSH PRIVILEGES;\n\n```", "```\n> CREATE TABLE domains (domain varchar(50) NOT NULL, PRIMARY KEY (domain) );\n\n```", "```\n> CREATE TABLE forwardings (source varchar(80) NOT NULL, destination TEXT NOT NULL, PRIMARY KEY (source) );\n\n```", "```\n> CREATE TABLE users (email varchar(80) NOT NULL, password varchar(20) NOT NULL, PRIMARY KEY (email) );\n\n```", "```\n> CREATE TABLE transport ( domain varchar(128) NOT NULL default '', transport varchar(128) NOT NULL default '', UNIQUE KEY domain (domain) );\n\n```", "```\n> quit\n\n```", "```\nbind-address=127.0.0.1\n```", "```\n$ sudo systemctl restart mariadb.service\n\n```", "```\n$ sudo nano /etc/postfix/mysql-virtual_domains.cf\n\n```", "```\nuser = mail_admin\npassword = mail_admin_password\ndbname = mail\nquery = SELECT domain AS virtual FROM domains WHERE domain='%s'\nhosts = 127.0.0.1\n```", "```\n$ sudo nano /etc/postfix/mysql-virtual_forwardings.cf\n\n```", "```\nuser = mail_admin\npassword = mail_admin_password\ndbname = mail\nquery = SELECT destination FROM forwardings WHERE source='%s'\nhosts = 127.0.0.1\n```", "```\n$ sudo nano /etc/postfix/mysql-virtual_mailboxes.cf\n\n```", "```\nuser = mail_admin\npassword = mail_admin_password\ndbname = mail\nquery = SELECT CONCAT(SUBSTRING_INDEX(email,'@',-1),'/',SUBSTRING_INDEX(email,'@',1),'/') FROM users WHERE email='%s'\nhosts = 127.0.0.1\n```", "```\n$ sudo nano /etc/postfix/ mysql-virtual_email2email.cf\n\n```", "```\nuser = mail_admin\npassword = mail_admin_password\ndbname = mail\nquery = SELECT email FROM users WHERE email='%s'\nhosts = 127.0.0.1\n```", "```\n$ sudo chmod o= /etc/postfix/mysql-virtual_*.cf\n$ sudo chgrp postfix /etc/postfix/mysql-virtual_*.cf\n\n```", "```\n$ sudo groupadd -g 5000 vmail\n$ sudo useradd -g vmail -u 5000 vmail -d /home/vmail -m\n\n```", "```\n$ sudo postconf -e 'virtual_alias_domains ='\n$ sudo postconf -e 'virtual_alias_maps = proxy:mysql:/etc/postfix/mysql-virtual_forwardings.cf, mysql:/etc/postfix/mysql-virtual_email2email.cf'\n$ sudo postconf -e 'virtual_mailbox_domains = proxy:mysql:/etc/postfix/mysql-virtual_domains.cf'\n$ sudo postconf -e 'virtual_mailbox_maps = proxy:mysql:/etc/postfix/mysql-virtual_mailboxes.cf'\n\n```", "```\n$ sudo postconf -e 'virtual_mailbox_base = /home/vmail'\n\n```", "```\n$ sudo postconf -e 'virtual_uid_maps = static:5000'\n$ sudo postconf -e 'virtual_gid_maps = static:5000'\n\n```", "```\n$ sudo systemctl restart postfix.service\n\n```", "```\n$ sudo nano /etc/postfix/main.cf\n\n```", "```\nvirtual_alias_domains = packtmail2.co.uk\nvirtual_alias_maps = hash:/etc/postfix/virtual\n```", "```\n$ sudo nano /etc/postfix/virtual\n\n```", "```\nuser1@mail.packtmail2.co.uk user1\n```", "```\n$ sudo postmap /etc/postfix/virtual\n$ sudo systemctl reload postfix\n\n```", "```\n$ sudo yum install dovecot\n\n```", "```\n$ sudo postconf -e 'smtpd_sasl_type = dovecot'\n$ sudo postconf -e 'smtpd_sasl_path = private/auth'\n$ sudo postconf -e 'smtpd_sasl_auth_enable = yes'\n$ sudo postconf -e 'broken_sasl_auth_clients = yes'\n$ sudo postconf -e 'smtpd_sasl_authenticated_header = yes'\n\n```", "```\n$ sudo postconf -e 'virtual_create_maildirsize = yes'\n$ sudo postconf -e 'virtual_maildir_extended = yes'\n\n```", "```\n$ sudo postconf -e 'proxy_read_maps = $local_recipient_maps $mydestination $virtual_alias_maps $virtual_alias_domains $virtual_mailbox_maps $virtual_mailbox_domains $relay_recipient_maps $relay_domains $canonical_maps $sender_canonical_maps $recipient_canonical_maps $relocated_maps $transport_maps $mynetworks $virtual_mailbox_limit_maps'\n$ sudo postconf -e 'virtual_transport = dovecot'\n$ sudo postconf -e 'dovecot_destination_recipient_limit = 1'\n\n```", "```\n$ sudo postconf -e 'smtpd_use_tls = yes'\n$ sudo postconf -e 'smtpd_tls_cert_file = /etc/pki/dovecot/certs/dovecot.pem'\n$ sudo postconf -e 'smtpd_tls_key_file = /etc/pki/dovecot/private/dovecot.pem'\n\n```", "```\n$ sudo nano /etc/postfix/master.cf\n\n```", "```\ndovecot   unix  -       n       n       -       -       pipe\n flags=DRhu user=vmail:vmail argv=/usr/libexec/dovecot/deliver -f ${sender} -d ${recipient}\n\n```", "```\n$ sudo cp /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf-backup\n\n```", "```\n$ sudo nano /etc/dovecot/dovecot.conf\n\n```", "```\n# We define the protocols that we want to be serving\nprotocols = imap pop3\n# Enable Dovecot to listen to all domains\nlisten = *\n# Define the time format to be shown at the log file\nlog_timestamp = \"%Y-%m-%d %H:%M:%S \"\n# Define the location of the received mails\nmail_location = maildir:/home/vmail/%d/%n/Maildir\n# Locate the files to be used for the SSL authentication\nssl_cert = /etc/pki/dovecot/certs/dovecot.pem\nssl_key = /etc/pki/dovecot/private/dovecot.pem\n\n# Define Mailbox main domain setting\nnamespace {\n    type = private\n    separator = .\n    prefix = INBOX.\n    inbox = yes\n}\n\n# Define the service users option \nservice auth {\n    unix_listener auth-master {\n        mode = 0600\n        user = vmail\n    }\n\n    unix_listener /var/spool/postfix/private/auth {\n        mode = 0666\n        user = postfix\n        group = postfix\n    }\n\nuser = root\n}\n\nservice auth-worker {\n    user = root\n}\n# Configure the protocol LDA\nprotocol lda {\n    log_path = /home/vmail/dovecot-deliver.log\n    auth_socket_path = /var/run/dovecot/auth-master\n    postmaster_address = postmaster@packt.co.uk\n}\n# Configure the protocol POP3\nprotocol pop3 {\n    pop3_uidl_format = %08Xu%08Xv\n}\n# Database configuration\npassdb {\n    driver = sql\n    args = /etc/dovecot/dovecot-sql.conf.ext\n}\n\nuserdb {\n    driver = static\n    args = uid=5000 gid=5000 home=/home/vmail/%d/%n allow_all_users=yes\n}\n```", "```\n$ sudo nano /etc/dovecot/dovecot-sql.conf.ext\n\n```", "```\ndriver = mysql\nconnect = host=127.0.0.1 dbname=mail user=mail_admin password=mail_admin_password\ndefault_pass_scheme = CRYPT\npassword_query = SELECT email as user, password FROM users WHERE email='%u';\n```", "```\n$ sudo chgrp dovecot /etc/dovecot/dovecot-sql.conf.ext\n$ sudo chmod o= /etc/dovecot/dovecot-sql.conf.ext\n\n```", "```\n$ sudo nano /etc/dovecot/conf.d/10-auth.conf\n\n```", "```\n# Line 10: needs to uncommented and changed\ndisable_plaintext_auth = no\n\n# Line 100: We need to add it login at the end\nauth_mechanisms = plain login \n```", "```\n$ sudo nano /etc/dovecot/conf.d/10-mail.conf\n\n```", "```\n# Line 30: Define the mailbox directory location\nmail_location = maildir:~/maildir\n```", "```\n$ sudo nano /etc/dovecot/conf.d/10-master.conf\n\n```", "```\n# Line 96-100: Set the user and group for the Unix listener section\nunix_listener /var/spool/postfix/private/auth {\n    mode = 0666\n    user = postfix \n    group = postfix \n}\n```", "```\n$ sudo nano /etc/dovecot/conf.d/10-ssl.conf\n\n```", "```\n# Line 8: change it yes\nssl = yes\n```", "```\n$ sudo nano /etc/aliases\n\n```", "```\npostmaster: root\nroot: postmaster@packt.co.uk\n```", "```\n$ sudo newaliases\n\n```", "```\n$ sudo systemctl restart postfix.service\n$ sudo systemctl restart dovecot.service\n$ sudo systemctl enable dovecot.service\n\n```", "```\n$ sudo tail /var/log/maillog\n\n```", "```\ndovecot: master: Dovecot v2.2.10 starting up for imap, pop3 (core dumps disabled)\n\n```", "```\n$ sudo yum install telnet\n\n```", "```\n$ telnet localhost 25\n\n```", "```\n> ehlo localhost\n\n```", "```\n250-server.packt.co.uk\n250-PIPELINING\n250-SIZE 10485760\n250-VRFY\n250-ETRN\n250-STARTTLS\n250-AUTH PLAIN\n250-AUTH=PLAIN\n250-ENHANCEDSTATUSCODES\n250-8BITMIME\n250 DSN\n\n```", "```\n> quit\n\n```", "```\n$ sudo mysql -u root -p\n\n```", "```\n> USE mail;\n\n```", "```\n> INSERT INTO domains (domain) VALUES ('packtmail.co.uk');\n\n```", "```\n> INSERT INTO users (email, password) VALUES ('user1@packtmail.co.uk', ENCRYPT('user_password'));\n\n```", "```\n$ sudo yum install mailx\n\n```", "```\n$ mailx user1@packtmail.co.uk\n\n```", "```\n$ sudo tail /var/log/maillog\n\n```", "```\nto=<user1@packtmail.co.uk>, relay=dovecot, delay=0.11, delays=0.07/0.01/0/0.03, dsn=2.0.0, status=sent (delivered via dovecot service) \n\n```", "```\n$ sudo tail /home/vmail/dovecot-deliver.log\n\n```", "```\nlda(user1@packtmail.co.uk): Info: msgid=<20150822073408.6537761B3936@server.packt.co.uk>: saved mail to INBOX\n\n```", "```\n$ sudo yum install mutt\n\n```", "```\n$ sudo cd /home/vmail/packtmail.co.uk/user1/Maildir/\n\n```", "```\n$ sudo mutt \u2013f .\n\n```", "```\ndn: uid=user,ou=people,dc=packtldap,dc=co,dc=uk\nobjectClass: posixAccount\nobjectClass: inetOrgPerson\nuid: user1\nhomeDirectory: /home/user1\nuserPassword: <passwordhash>\n```", "```\n$ sudo nano /etc/dovecot/dovecot.conf\n\n```", "```\n# Define the mail user and group UID and GID\nmail_uid = 5000\nmail_gid = 5000\n# Define the default Authentication method\nauth default {\n  mechanisms = plain\n  # Define the LDAP database password file\n  passdb ldap {\n          args = /etc/dovecot/dovecot-ldap.pass\n  }\n  # Define the LDAP database user file\n  userdb ldap {\n          args = /etc/dovecot/dovecot-ldap.user\n  }\n\n  # Define the socket Listening parameters \n  socket listen {\n        client {\n          path = /var/spool/postfix/private/auth\n          mode = 0660\n          user = postfix\n          group = postfix\n  }\n}\n```", "```\n$ sudo nano /etc/dovecot/dovecot-ldap.user\n\n```", "```\nhosts = packtldap.co.uk:389\nsasl_bind = no\nauth_bind = yes\nldap_version = 3\nderef = never\nbase = uid=%n,ou=people,dc=packtldap,dc=co,dc=uk\nscope = base\nuser_attrs = homeDirectory=home\ndn = uid=manager,dc=packtldap,dc=co,dc=uk\ndnpass = password\n```", "```\n$ sudo nano /etc/dovecot/dovecot-ldap.pass\n\n```", "```\nhosts = packtldap.co.uk:389\nsasl_bind = no\nauth_bind = yes\nldap_version = 3\nderef = never\nbase = uid=%n,ou=people,dc=packtldap,dc=co,dc=uk\nscope = base\ndn = uid=manager,dc=packtldap,dc=co,dc=uk\ndnpass = password\n```", "```\n$ sudo postconf -e 'accounts_server_host = packtldap.co.uk'\n$ sudo postconf -e 'accounts_search_base = ou=people,dc=packtldap,dc=co,dc=uk'\n$ sudo postconf -e 'accounts_query_filter = (&(objectClass=inetOrgPerson)(mail=%s))'\n$ sudo postconf -e 'accounts_result_attribute = homeDirectory'\n$ sudo postconf -e 'accounts_result_format  =  %s/Mailbox'\n$ sudo postconf -e 'accounts_scope = sub'\n$ sudo postconf -e 'accounts_cache = yes'\n$ sudo postconf -e 'accounts_bind = yes'\n$ sudo postconf -e 'accounts_bind_dn = uid=manager,dc=packtldap,dc=co,dc=uk'\n$ sudo postconf -e 'accounts_bind_pw = password'\n$ sudo postconf -e 'accounts_version = 3'\n$ sudo postconf -e 'virtual_transport = virtual'\n$ sudo postconf -e 'virtual_uid_maps = static:5000'\n$ sudo postconf -e 'virtual_gid_maps = static:5000'\n$ sudo postconf -e 'virtual_mailbox_base = /'\n$ sudo postconf -e 'virtual_mailbox_maps = ldap:accounts'\n$ sudo postconf -e 'virtual_mailbox_domains = packtldap.co.uk'\n\n```", "```\n$ sudo systemctl restart postfix.service\n$ sudo systemctl restart dovecot.service\n\n```", "```\n$ cd /etc/pki/tls/certs/\n\n```", "```\n$ sudo openssl genrsa -des3 -out mailserver.key 2048\n\n```", "```\n$ sudo yum install openssl\n\n```", "```\n$ sudo openssl rsa -in server.key -out server.key\n\n```", "```\n$ sudo make mailserver.csr\n\n```", "```\n$ sudo openssl x509 -in mailserver.csr -out server.crt -req -signkey mailserver.key -days 3650 \u2013sha256\n\n```", "```\n$ sudo nano \"/etc/postfix/main.cf\nsmtpd_tls_exclude_ciphers = aNULL, eNULL, EXPORT, DES, RC4, MD5, PSK, aECDH, EDH-DSS-DES-CBC3-SHA, EDH-RSA-DES-CDC3-SHA, KRB5-DE5, CBC3-SHA\nsmtpd_tls_dh1024_param_file = /etc/ssl/private/dhparams.pem\n\nsmtpd_tls_mandatory_protocols = !SSLv2, !SSLv3\nsmtpd_tls_protocols = !SSLv2, !SSLv3\nsmtp_tls_mandatory_protocols = !SSLv2, !SSLv3\nsmtp_tls_protocols = !SSLv2, !SSLv3\n\n```", "```\n$ cd /etc/ssl/private/\n$ sudo openssl dhparam -out dhparams.pem 2048\n$ sudo chmod 600 dhparams.pem\n\n```", "```\n$ sudo postconf -e 'smtpd_use_tls = yes'\n\n```", "```\n$ sudo postconf -e 'smtpd_tls_cert_file = /etc/pki/tls/certs/mailserver.crt'\n$ sudo postconf -e 'smtpd_tls_key_file = /etc/pki/tls/certs/mailserver.key'\n\n```", "```\n$ sudo postconf -e 'smtpd_tls_session_cache_database = btree:/etc/postfix/smtpd_scache'\n\n```", "```\n$ sudo nano /etc/postfix/master.cf\n\n```", "```\nsubmission     inet  n       -       n       -       -       smtpd\n  -o syslog_name=postfix/submission\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject\n  -o milter_macro_daemon_name=ORIGINATING\n\nsmtps       inet   n       -       n       -       -       smtpd\n  -o syslog_name=postfix/smtps\n  -o smtpd_tls_wrappermode=yes\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject\n  -o milter_macro_daemon_name=ORIGINATING\n```", "```\n$ sudo nano /etc/dovecot/conf.d/10-ssl.conf\n\n```", "```\n# Line8: change it to yes \nssl = yes\n```", "```\n# Line 14, 15: change the files location to the new one\nssl_cert = </etc/pki/tls/certs/mailserver.crt\nssl_key = </etc/pki/tls/certs/mailserver.key\n```", "```\n$ sudo systemctl restart postfix.service\n$ sudo systemctl restart dovecot.service\n\n```"]