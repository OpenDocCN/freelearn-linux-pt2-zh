# 九、使用 Cron 自动执行任务

在本章中，我们将介绍:

*   创建和运行 crontab 文件
*   每隔一周运行一次命令
*   从 crontab 文件报告错误

# 简介

cron 守护程序通常由操作系统自动启动，每分钟查看一次所有 crontab 文件。如果满足标准，则运行命令。在本章中，我们将展示如何使用 crontab 程序创建和维护 crontab 文件。

根据系统的设置方式，cron 作业是基于用户而被允许(允许或不允许)的。控制这个的文件在`/etc`中，命名为`cron.allow`和`cron.deny`。这些将在下一节中解释:

*   `cron.allow`:如果这个文件存在，那么用户必须在其中列出，才能使用 crontab
*   `cron.deny`:如果`cron.allow`不存在但是`cron.deny`存在，那么用户不能被列在`cron.deny`文件中

如果这两个文件都不存在，那么只有根用户可以使用该命令。在大多数 Linux 系统中，只有`cron.deny`存在，它是空的。在运行以下命令之前，请在您的系统上检查这一点。

我们将使用一个用户帐户来试验 crontab。`crontab`命令用于更改 crontab 文件，因为它不应该被直接编辑。要查看当前用户的 crontab，请运行`crontab -l`。

当前用户编辑 crontab 文件的命令是`crontab -e`。默认情况下，这将在 vi 编辑器中调出 crontab 文件。但是，您可以更改`EDITOR`环境变量以使用您想要的任何文本编辑器。

以下是典型用户 crontab 文件的格式:

```sh
#
#  crontab for jklewis
# Field 1   2    3            4              5             6
#      Min Hour Day of month Month of year  Day of week
#     0-59 0-23 1-31         1-12           0-6   0=Sun /path/command
#
# Days of the week: 0=Sun 1=Mon 2=Tues 3=Wed 4=Thu 5=Fri 6=Sat

```

我总是将这个模板添加到 crontab 文件的顶部，这样我就可以很容易地记住字段是什么。以下是 crontab 条目示例:

```sh
 10     0     *     *     0     /path/mycommand

```

这些值可以是整数、范围、元素或元素列表或星号。星号表示匹配所有有效值。

*   `#`:这表示一个注释行。它必须是行中的第一件事(不要放在一行的末尾)。
*   **场 1** :这是分钟。从 0 开始意味着 00:00。
*   **第二场**:这是整点。它从 0 开始，这意味着上午 12 点。
*   **字段 3** :这是一个月中的某一天。
*   **场 4** :这是一年中的月份。也可以使用名称。
*   **第五场**:这是一周中的一天。从 0 开始，这是星期天。也可以使用名称。
*   **字段 6** :这是要运行的路径/命令。

该示例条目将在每周日上午 12:10 运行`mycommand`。

### 类型

仅使用空格分隔字段。不要使用制表符。

# 创建和运行 crontab 文件

这里我们将展示一个创建和运行用户 crontab 文件的例子。

## 做好准备

确保您的系统按照*简介*中的概述进行设置。我们将使用两个终端会话，以便更容易地看到我们的结果。

## 怎么做...

以下是如何创建和运行 crontab 文件的示例:

1.  在终端会话中运行`tty`并记住输出。这将在步骤 10 中使用。
2.  在用户帐户下打开或使用另一个终端。我将像前面几章一样使用`jklewis`。
3.  让我们通过运行以下命令来查看 crontab 文件:

    ```sh
    crontab -l

    ```

4.  它可能会说类似`no crontab for jklewis`的话，这很好。
5.  现在让我们通过运行以下命令来制作一个
6.  它可能会说一些类似`no crontab for jklewis - using an empty one`的话，这很好。
7.  Crontab 应该在 vi 中调出一个临时文件(除非你已经像我一样在我的系统中更改了`EDITOR`变量)。在保存文件并结束会话之前，不会使用该文件。
8.  我建议将我在上面创建的模板剪切并粘贴到您的 crontab 文件中。这将使记住字段变得容易得多。
9.  现在让我们添加一个条目，我们可以看到它很快生效。在文件中插入以下行(剪切和粘贴应该有效):

    ```sh
    TTY=/dev/pts/17
    # crontab example 1
    *   *   *    *    *     date > $TTY; echo "Yes it works" > $TTY

    ```

10.  将`TTY`线更改为您在步骤 1 中找到的线。
11.  现在保存文件并退出会话。您应该会看到如下消息:

    ```sh
    crontab: installing new crontab

    ```

12.  在下一分钟，您应该会在另一个会话中看到类似以下的输出:

    ```sh
    Tue May  7 19:52:01 CDT 2013
    Yes it works

    ```

13.  我们用所有这些星号输入的条目意味着每分钟运行一次命令。再次编辑 crontab，并将该行更改为以下代码:

    ```sh
    */5    *   *   *   *   date > $TTY; echo "Every 5 minutes"  > $TTY

    ```

14.  这种奇怪的语法是一种跳过或增加值的方法。现在尝试以下命令:

    ```sh
    35     9     *     *     1-5   date > $TTY; echo "9:35 every week day"  > $TTY

    ```

15.  它在每个工作日(周一至 Fri)上午`9:35`运行。日字段中的`1-5`是一个范围。
16.  名称也可以用于日和月字段，如下命令:

    ```sh
    17   13    8     May   Wed   date > $TTY; echo "May 8 at  13:17"  > $TTY

    ```

17.  还有下面的命令:

    ```sh
    0   0    *     *      Fri   date > $TTY; echo "Run every  Friday at 12:00 am"  > $TTY

    ```

对于名字，使用标准的三个字母缩写，大小写无关紧要。使用名称可能更容易，但是，不能使用带名称的范围或步骤。

# 每隔一周运行一次命令

既然我们已经了解了 cron 的基础知识，那么如何设置一个条目来每隔一周运行一次命令呢？您可能会尝试类似以下代码的东西:

```sh
 *  *  *  *  0/2   /path/command

```

这意味着从周日开始，然后每隔一个周日跑步，对吗？不，这是错误的，但你经常在网站上看到这是一个解决方案。Cron 实际上并没有内置的方法来做到这一点，但是有一个解决方案。

## 怎么做...

以下是每隔一周运行一次命令的步骤:

1.  在你的主目录中创建以下脚本并命名为`cron-weekly1`(随意剪切和粘贴):

    ```sh
    #!/bin/sh
    # cron-weekly1
    # Use this script to run a cron job every other week
    FN=$HOME/cron-weekly.txt
    if [ -f $FN  ] ; then
     rm $FN
     exit
    fi
    touch $FN
    echo Run the command here

    ```

2.  通过运行以下命令使脚本可执行:

    ```sh
    chmod 755 cron-weekly1

    ```

3.  在您的用户帐户下运行以下命令:

    ```sh
    crontab -e

    ```

4.  增加以下一行:

    ```sh
     0  0  *  *  0    $HOME/cron-weekly1

    ```

5.  结束编辑会话。这将安装修改后的 crontab 文件。

## 它是如何工作的...

看看这个剧本。第一次运行时`cron-weekly.txt`文件不存在，所以创建，执行命令(你每隔一周要运行的那个)。第二周，当这个脚本再次运行时，它看到`cron-weekly.txt`文件在那里，将其删除，然后退出脚本(命令不运行)。这每周交替进行，有效地每隔一周运行一次命令。很酷吧？

在前面的`cron-weekly1`脚本中，命令在第一次运行时执行。您可以将此更改为从下周开始运行命令，方法是在`if`语句中移动行来运行命令。

虽然这样做很有诱惑力，但是不要在一行的末尾加上注释`#`。Cron 无法判断这是注释还是命令的一部分。如果 cron 报告了一些您不理解的错误，请检查错误位置的注释。是的，我承认我仍然不时这样做。

如果您做了 crontab 不喜欢的事情(如上一节中显示的`* * * * 0/2 command`行)，它通常会在您关闭会话时报告错误。然后它会给你重新编辑文件的选项。无论如何都要这样做，要么解决问题，要么至少评论一下这条线。您可以稍后再回去编辑它。

您可以通过运行`crontab -r`完全删除 crontab 文件。我建议在这样做之前做一个备份，以防万一。您应该能够通过您选择使用的任何文本编辑器将文件保存为新名称。

## 还有更多...

Crontab 文件可以利用环境变量。以下是一些常见的例子:

*   **SHELL** :这告诉操作系统使用特定的 SHELL，覆盖`/etc/passwd`文件中的内容。比如`SHELL=/bin/sh`。
*   **邮件到**:这个告诉 cron 把错误邮件给这个用户。语法是`MAILTO=<user>`也就是`MAILTO=jklewis`。
*   **CRON_TZ** :这是用来设置一个特定的时区变量，也就是`CRON_TZ=Japan`。

Cron 有一些快捷方式可以使用。这些字段用于代替 5 个时间和日期字段，如下所示:

<colgroup><col style="text-align: left"> <col style="text-align: left"></colgroup> 
| 

命令快捷方式

 | 

命令

 | 

输出

 |
| --- | --- | --- |
| **@重启** |   | 重启后运行一次 |
| **@每年或@每年** | **0 0 1 1 *** | 一年中的第一天，每月的第一天 |
| **@每月** | **0 0 1 * *** | 每月的第一天 |
| **@每周** | **0 0 * * 0** | 周日上午 12:00 跑步 |
| **@每日** | **0 0 * * *** | 每天上午 12:00 跑步 |
| **@小时** | **0 * * * *** | 每小时整点跑 |

所以在前面的例子中，我们可以把`@weekly $HOME/cron-weekly1`。

不要将 cron 用于任何时间敏感的任务。在命令运行之前，通常会有短暂的延迟，只有几秒钟。如果您需要比这更好的粒度，请使用脚本和睡眠例程。

您还可以为 root 用户设置 crontab。要查看更多信息，请使用`man -a crontab`。

# 从 crontab 文件报告错误

你可能在想，如果一个 crontab 文件有错误，电脑怎么上报？它通过使用 sendmail 系统向 crontab 用户发送邮件来实现这一点。

## 怎么做...

以下是 cron 如何报告错误的示例:

1.  使用用户帐户打开终端。
2.  通过运行以下命令编辑您的 crontab 文件:

    ```sh
    crontab -e

    ```

3.  现在让我们故意造成一个错误。滚动至底部，添加以下行:

    ```sh
    * * * *    date > /baddirectory/date.txt

    ```

4.  保存文件。等到下一分钟 cron 运行，然后在你的用户终端按*进入*。
5.  你应该看到一条消息说你有邮件。运行以下命令:

    ```sh
    mail

    ```

6.  应该有一封邮件指出错误(在这种情况下，找不到文件)。您可以通过按 *D* 然后按 *Q* 离开邮件来删除邮件。
7.  要完成，请务必重新编辑您的 crontab 文件，并删除我们刚刚添加的错误行。

## 还有更多...

您还可以监控`/var/log/cron`文件，查看 cron 全天在系统上做什么。这在第一次创建 crontab 文件并试图让它恰到好处时非常有用。