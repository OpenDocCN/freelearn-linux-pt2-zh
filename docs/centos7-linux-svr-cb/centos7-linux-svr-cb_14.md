# 第十四章：使用 SELinux

在本章中，我们将介绍以下主题：

+   安装和配置重要的 SELinux 工具

+   使用 SELinux 安全上下文

+   处理策略

+   故障排除 SELinux

# 引言

本章是一系列食谱的集合，旨在揭开**安全增强型 Linux**（**SELinux**）的神秘面纱，这是一种成熟的技术，用于使用基本安全系统中添加的额外安全功能来强化您的 Linux 系统。它在 CentOS 世界中已经存在多年，但对于许多系统管理员来说，它仍然是一个鲜为人知且令人困惑的话题。

# 安装和配置重要的 SELinux 工具

任何 Linux 系统最重要的安全特性是提供访问控制——通常称为**自主访问控制**（**DAC**）——它允许对象（如文件）的所有者为其设置安全属性（例如，使用`chown`和`chmod`命令决定谁可以读写文件）。虽然这种古老且非常简单的安全系统在古老的 UNIX 时代是足够的，但它并不能满足现代安全需求，其中服务器和服务不断连接到互联网。

通常，安全漏洞可以由攻击者通过利用有缺陷或配置错误的应用程序及其权限来发起。这就是为什么开发了 SELinux。其主要目的是增强 Linux 中 DAC 系统的安全性。它通过在 DAC 之上添加一个额外的安全层来实现这一点，该层称为**强制访问控制**（**MAC**），它可以为系统中的每个单独组件提供细粒度的访问控制。SELinux 已经在 CentOS 7 上启用，并且对于任何直接连接到互联网的服务器都是绝对推荐的。在本食谱中，我们将安装额外的工具并配置它们，以更好地管理您的 SELinux 系统，并帮助进行故障排除和监控过程。

## 准备工作

要完成这个食谱，您需要一个具有 root 权限的工作 CentOS 7 操作系统安装，以及一个互联网连接以下载额外的软件包。为了获得最佳学习体验，建议您按照本章中出现的顺序逐个食谱地进行，因为它们是相互构建的。

## 如何操作...

在本书中，我们已经应用了诸如`semanage`之类的程序，该程序来自`rpm` `policycoreutils-python`包，以管理我们的 SELinux 环境。如果您错过了安装它，我们将从这个食谱开始这样做（如果您之前已经这样做过，请跳过步骤 1）：

1.  以 root 身份登录并安装以下基本工具包以使用 SELinux：

    ```
    yum install policycoreutils-python

    ```

1.  现在，我们需要一些额外的工具，这些工具在本书的后续过程中也将需要：

    ```
    yum install setools setools-console setroubleshoot*

    ```

1.  接下来，安装并配置 SELinux 手册页，因为它们在 CentOS 7 上默认不可用，但对于获取有关特定策略、安全上下文和 SELinux 布尔值的详细信息非常重要。首先，我们需要安装另一个软件包：

    ```
    yum install policycoreutils-devel

    ```

1.  接下来，让我们为系统上当前可用的所有 SELinux 安全上下文策略生成所有手册页，然后更新手册页数据库：

    ```
    sepolicy manpage -a -p /usr/share/man/man8; mandb

    ```

## 它是如何工作的...

通过遵循这个配方，我们安装了日常工作中需要的所有 SELinux 工具。此外，我们生成了所有可用的 SELinux 手册页，这将是我们使用 SELinux 和解决 SELinux 服务问题时的主要信息来源。

SELinux 有两个主要和基本的术语，我们需要在深入了解本章其余部分的配方之前理解：**标签**（或更技术性地，安全上下文）和**策略**。从 SELinux 的角度来看，Linux 系统被划分为许多不同的对象。例如，对象是系统中的所有文件、进程、用户、套接字和管道。在 SELinux 上下文中，每个这样的对象都获得一个特殊的标签。SELinux 策略是使用定义在它们上的标签控制对这些对象的访问的规则：在每次尝试访问这样的对象（例如，文件读取）时，系统上可用的所有 SELinux 策略都将被搜索，以查看是否有针对特定标签的规则来做出访问控制决策（允许或拒绝访问）。

那么，我们从这次经历中学到了什么？

许多系统管理员似乎避免使用 SELinux*像瘟疫一样*，并且在许多指令手册和教程中倾向于在安装 CentOS 7 后立即完全禁用它，因为人们似乎害怕它，不想弄乱它，或者甚至感到沮丧，如果某些网络服务没有正确地从盒子中工作。通常，他们将任何连接问题归咎于 SELinux，因此看起来更容易完全禁用它，而不是通过深入了解 SELinux 的内部工作来找出真正的原因。如果你禁用它，你将错过 CentOS 7 最重要的安全功能之一，这可以在攻击事件中防止对你的系统造成很大伤害！在过去的几年中，SELinux 项目已经发展了很多，并且比以往任何时候都更容易使用。出现了许多方便的工具来使用它，并且我们得到了一套完整的工作策略来使用所有主要应用程序和服务。通过安装这些工具，我们现在准备好使用 SELinux 并以最方便的方式工作。

## 还有更多...

谈到 SELinux 时，有三种不同的模式。**增强**模式是唯一真正保护我们并增强服务器安全的模式，还有另外两种模式：**禁用**和**宽容**。禁用意味着 SELinux 被关闭，这在本书中永远不会成为我们的选项，并且不再进一步讨论，因为放弃这一出色的 CentOS 特性没有意义。当禁用时，我们的系统没有通过 SELinux 得到增强，我们手头唯一的保护来源是传统的 DAC 系统。宽容模式意味着 SELinux 已开启，策略规则已加载，所有对象都带有特定的安全上下文标签，但系统并不强制执行这些策略。这就像许多基于 Linux 的命令行工具的干运行参数：它在 SELinux 增强安全保护下模拟系统，并将系统记录的每个 SELinux 策略违规行为记录下来，就像在实际运行时一样。这是调试系统或分析正常强制运行对系统可能产生的后果的好方法。

通常，如果您不确定使用 SELinux 的影响，就会使用这种模式。由于这种模式并没有真正为我们提供任何额外的安全性，如果我们想要增强安全性，最终需要切换到**强制**模式！再次强调，这是唯一保护我们的模式；SELinux 完全运行，加载了所有策略，并在系统上强制执行这些规则。您应该始终在任何系统上追求强制模式！要查看当前模式，请使用命令`sestatus`。我们可以在输出中的`当前模式`行中看到当前的 SELinux 模式。在 CentOS 7 上，SELinux 默认处于强制模式，这再次告诉我们系统完全受到其保护。要将此模式更改为宽容模式，请使用命令`setenforce` `宽容`。现在，再次使用`sestatus`验证您的设置。要恢复更改回强制模式，请使用`setenforce enforcing`。使用`setenforce`设置 SELinux 模式只是暂时设置，它不会在重启后存活（查看`sestatus`输出中的`配置模式`文件）。要永久更改此设置，请打开`/etc/selinux/config`文件并更改`SELINUX=`配置参数。

# 使用 SELinux 安全上下文

正如我们从本章前一个配方中学到的，SELinux 都是关于标签和策略的。在本配方中，我们将向您展示如何使用这些标签，也称为安全上下文。

## 准备就绪

要完成这个配方，您需要一个具有 root 权限的 CentOS 7 操作系统的安装。假设您是通过本章的配方一步步进行的，那么到目前为止，您应该已经从前一个配方中安装了 SELinux 工具，并为策略生成了所有 SELinux 手册页。您可能会注意到，本配方中我们将向您展示的一些命令已经在本书的其他配方中应用过。我们将在这里详细解释它们。为了使用`netstat`程序，请使用 YUM 包管理器安装`net-tools`包。

## 如何做到这一点...

正如我们在之前的配方中学到的，SELinux 系统中的几乎每个组件都是一个对象（文件、目录、进程、用户等）。我们将从这个配方开始，向您展示如何使用`-Z`命令行标志打印出所有类型的对象的 SELinux 标签，这是 SELinux 系统上的许多基本 Linux 命令所支持的。

1.  首先，以 root 身份登录并键入以下命令，以从各种类型的对象探索 SELinux 安全上下文信息：

    ```
    id -Z
    ls -Z
    ps -auxZ
    netstat -tulpenZ

    ```

1.  接下来，要列出系统上所有文件和目录的可用安全上下文名称，请使用以下命令（我们仅过滤了`httpd`标签）：

    ```
    semanage fcontext -l | grep httpd

    ```

1.  接下来，让我们创建一个我们可以操作的新空文件：

    ```
    touch /tmp/selinux-context-test.txt

    ```

1.  显示新文件的当前安全上下文（应包含类型`user_tmp_t`）：

    ```
    ls -Z /tmp/selinux-context-test.txt

    ```

1.  最后，将`user_tmp_t`类型更改为随机的`samba_share_t`标签名称：

    ```
    semanage fcontext -a -t samba_share_t /tmp/selinux-context-test.txt
    restorecon -v /tmp/selinux-context-test.txt

    ```

1.  执行测试以验证您的更改：

    ```
    ls -Z /tmp/selinux-context-test.txt

    ```

## 它是如何工作的...

在本配方中，我们向您展示了如何显示各种 SELinux 对象类型的标签（安全上下文），如何显示所有可用标签名称，以及如何在文件对象的示例上修改或设置它们。在日常工作中，大多数管理员都会确认，我们必须管理安全上下文的最重要对象是文件、目录和进程。此外，您需要记住，每个 SELinux 对象只能有一个安全上下文。

那么，我们从这次经历中学到了什么？

正如我们所见，我们可以在许多不同的标准 Linux 命令行工具上使用`-Z`参数来打印出它们的 SELinux 安全上下文。在这里，我们向您展示了显示用户、文件和目录、进程以及网络连接标签的示例，我们可以使用`id`、`ls`、`ps`和`netstat`命令查询这些标签。在这些命令的输出中，我们看到每个此类对象的安全上下文标签都由三个值组成：用户（标记为`_u`）、角色（`_r`）和类型（`_t`）。类型字段被用作标准 SELinux 类型（称为目标型）中所有访问控制决策的主要机制，因此我们通常将整个 SELinux 访问控制过程称为**类型强制**（**TE**）。

对象标签中的其他值用户和角色对于非常高级的 SELinux 配置来说不是必要的，这里不讨论。为了显示我们系统上所有可用的上下文类型，使用命令行`seinfo -t`。这些 SELinux 类型是我们需要理解的一个非常重要的概念。对于文件和目录对象，它们用于*捆绑*相互关联的对象组，并且应该受到相同的保护或处理，以便我们可以对它们定义特定的策略规则。例如，我们可以将标准邮件假脱机目录`/var/spool/mail`中的每个文件分配为类型`mail_spool_t`，然后创建一个访问规则策略，在其中我们将使用此类型来允许特定的访问。在进程的上下文中，类型值称为域。在这里，类型用于隔离和*沙盒*进程：任何具有指定域名的进程只能与同一域中的其他进程通信和交互（有一些例外，如未讨论的转换）。通过域隔离进程大大降低了安全风险。当进程被攻陷时，它们只能损害自己，而不会影响其他任何东西。

### 注意

SELinux 有时被称为沙盒系统。从软件总是会有漏洞的假设出发，SELinux 提供了隔离软件组件的方法，使得一个组件的漏洞不会影响到另一个组件。

如果你输入`ps -auxZ`，你还会发现有一些进程在一个名为`unconfined_t`的域中运行。带有此标签的进程不受 SELinux 策略的保护，这意味着如果一个未受限的进程被攻陷，SELinux 不会阻止攻击者访问其他系统资源和数据。在这里，安全性退回到标准的 DAC 规则，这将成为你唯一的保护措施。

在我们讨论了如何显示安全上下文之后，接下来的章节中我们向您展示了如何设置和更改它们。在某些较旧的文档以及某些 SELinux 策略的`man`页中，您会遇到使用名为`chcon`的工具的示例，该工具用于修改对象的安全上下文。使用此工具已不再推荐，您应始终将此类命令行示例替换为较新的`semanage fcontext -a -t`命令行与`restorecon`程序的组合。对于`semanage`，您提供带有`-t`的标签类型名称，然后提供要为其设置标签的文件名。然后，使用`restorecon`，您提供要应用之前由`semanage`所做更改的文件名。这是因为安全上下文可以在两个级别上设置。它可以设置为策略并在文件系统级别上设置。`chcon`命令直接在文件系统上设置新上下文，而策略上下文未更改。这可能会导致问题，例如，如果您想稍后重置或更改文件系统的安全上下文（这称为重新标记）——这意味着所有安全上下文将从策略应用到文件系统，覆盖您使用`chcon`所做的所有更改。因此，最好使用`semanage`，它将写入策略，然后使用`restorecon`，它将使策略标签与文件系统同步，保持一切最新。如果您想为目录而不是单个文件设置标签，可以使用正则表达式；要查看一些示例和进一步的命令行选项，请键入`man semanage-fcontext`并浏览到`EXAMPLES`部分。

# 处理策略

在每个 SELinux 系统的核心是策略。这些是定义我们所有对象之间的访问权限和关系的精确规则。正如我们之前所学，我们系统的所有对象都有标签，其中一个标签是类型标识符，可用于执行策略中规定的规则。在每个启用 SELinux 的系统中，默认情况下，除非策略规则另有定义，否则对任何对象的所有访问都是禁止的。在本节中，我们将向您展示如何查询和自定义 SELinux 策略。您可能会注意到，本书中其他章节的一些命令已经应用于`httpd`或`ftpd`守护进程等。在这里，您将了解策略是如何工作的。

## 准备就绪

要完成此操作，您需要一个具有 root 权限的 CentOS 7 操作系统的正常安装。假设您是按照本章的食谱一个接一个地操作，那么到现在为止，您应该已经从之前的食谱中安装了 SELinux 工具，并为策略生成了所有 SELinux 手册页。对于我们这里的测试，我们将使用 Apache Web 服务器，因此请确保它已在您的系统上安装并运行（请参阅[第十二章](part0098_split_000.html#2TEN41-4cf34a6d07944734bb93fb0cd15cce8c "第十二章. 提供 Web 服务"），*提供 Web 服务*中的食谱*安装 Apache 并提供网页*）。

## 如何操作...

1.  首先，以 root 身份登录，并输入以下命令以显示所有 SELinux 布尔策略设置，仅过滤出`httpd`守护进程的设置：

    ```
    semanage boolean -l | grep httpd

    ```

1.  要获取有关特定策略及其包含的布尔值的更多信息，请阅读相应的手册页；例如，对于`httpd`，请输入以下内容：

    ```
    man httpd_selinux

    ```

1.  在这里，在`httpd`策略的手册页中，我们将找到有关每个可用的`httpd`策略布尔值的详细信息。例如，有一个关于`httpd_use_nfs`的部分。要切换单个策略功能，请使用`setsebool`命令以及策略布尔名称和`on`或`off`参数，如下所示：

    ```
    setsebool httpd_use_nfs on
    setsebool httpd_use_nfs off

    ```

## 它是如何工作的...

在本食谱中，我们向您展示了如何使用 SELinux 布尔值。请记住，SELinux 遵循最小权限模型，这意味着 SELinux 策略仅启用任何对象（如系统服务）执行其任务所需的最少功能，并且不会更多。这些策略功能可以通过相应的 SELinux 布尔值在运行时进行控制（激活或停用），而无需了解策略编写的内部工作原理。这是一个使策略可定制且极其灵活的概念。在本书的其他食谱中，我们已经通过启用 SELinux 布尔值来添加特殊策略功能，例如启用 Apache 或 FTP 主目录，这些功能默认情况下都是禁用的。

我们从这次经历中学到了什么？

SELinux Booleans 就像开关一样，用于启用或禁用 SELinux 策略中的某些功能。我们从这个菜谱开始使用 `semanage` 命令来显示系统上所有可用的 Booleans，并通过 `http` 过滤以获取仅与该服务相关的那些。如您所见，系统上有大量的 Booleans 可用，其中大多数是禁用或关闭的（最小权限模型）；要获取有关特定策略及其 Boolean 值的更多信息，请使用我们在之前的菜谱中安装的 SELinux 手册页。有时，找到感兴趣的特定手册页可能会很困难。使用以下命令搜索可用的手册页名称：`man -k _selinux | grep http`。在我们的示例中，`httpd_selinux` 是获取有关 `httpd` 策略详细信息的正确手册页。最后，如果我们决定切换特定的 SELinux Boolean 功能，我们将使用 `setsebool` 命令。您应该记住，以这种方式设置 Booleans 仅在重启之前有效。要使这些设置永久生效，请使用 `-p` 标志，例如，`setsebool -P httpd_use_nfs on`。

## 还有更多...

凭借我们从之前的菜谱中获得的所有知识，我们现在能够展示一个将所有内容结合起来的示例。在这里，我们将看到 `httpd` 服务的 SELinux 安全上下文和策略在行动。如果 Apache 网络服务器正在运行，我们可以使用以下行获取 `httpd` 进程的 SELinux 域名：

```
ps auxZ | grep httpd

```

这将向我们展示 `httpd` 域（类型）称为 `httpd_t`。要获取 Web 根目录的 SELinux 标签，请输入以下命令：

```
ls -alZ /var/www/html

```

这将告诉我们 Apache 网络服务器的 Web 根目录的安全上下文类型称为 `httpd_sys_content_t`。现在，有了这些信息，我们可以从我们的策略中获取 Apache 域的确切规则：

```
sesearch --allow | grep httpd_t

```

这将打印出每个 `httpd` 策略规则。如果我们过滤输出以获取 `httpd_sys_content_t` 上下文类型，以下行再次出现：

```
allow httpd_t httpd_sys_content_t : file { ioctl read getattr lock open } 

```

这向我们展示了哪些源目标上下文被允许访问，哪些目标目标上下文，以及使用哪些访问权限。在我们的 Apache Web 服务器示例中，这指定了运行在域`httpd_t`上的`httpd`进程可以访问、打开和修改文件系统上所有匹配`httpd_sys_content_t`上下文类型（所有位于`/var/www/html`目录中的文件都符合这一标准）的文件。现在，为了验证这条规则，创建一个临时文件并将其移动到 Apache Web 根目录：`echo "CentOS7 Cookbook" > /tmp/test.txt;mv /tmp/test.txt /var/www/html`。任何文件都会继承创建它的目录的安全上下文。如果我们直接在 Web 根目录中创建文件，或者复制文件（复制意味着创建一个副本），它将自动处于正确的`httpd_sys_content_t`上下文，并且完全可由 Apache 访问。但是，由于我们将文件从`/tmp`目录移动，它将保持在 Web 根目录中的`user_tmp_t`类型。如果你现在尝试获取 URL，例如，`curl http://localhost/test.txt`，你应该会收到 403 禁止消息。这是因为`user_tmp_t`类型不是`httpd_t`策略规则中文件对象的一部分，因为正如之前所说，默认情况下，未在策略规则中定义的一切都将被阻止。为了使文件可访问，我们现在将更改其安全上下文标签为正确的类型：

```
semanage fcontext -a -t httpd_sys_content_t /var/www/html/test.txt
restorecon -v /var/www/html/test.txt

```

现在再次获取`curl http://localhost/test.txt`，它应该是可访问的，并打印出正确的文本：CentOS7 cookbook。

请记住，如果你复制一个文件，安全上下文类型会从目标父目录继承。如果你想在复制时保留原始上下文，请使用`cp -preserve=context`命令。

# SELinux 故障排除

在本节中，你将学习如何排除 SELinux 策略故障，这通常在你被拒绝访问某些 SELinux 对象时需要，并且你需要找出原因。在本节中，我们将向你展示如何使用`sealert`工具，该工具将创建易于理解和处理的人类可读错误消息。

## 准备工作

为了完成本节，你需要一个具有 root 权限的 CentOS 7 操作系统的有效安装。假设你正在逐个阅读本章节，因此到现在为止，你应该已经安装了 SELinux 工具并应用了本章中的*Working with policies*节，因为我们将产生一些 SELinux 拒绝事件，以向你展示如何使用日志文件工具。

## 如何操作...

1.  开始之前，请以 root 身份登录并引发一个 SELinux 拒绝事件：

    ```
    touch /var/www/html/test2.html
    semanage fcontext -a -t user_tmp_t /var/www/html/test2.html
    restorecon -v /var/www/html/test2.html
    curl http://localhost/test2.html

    ```

1.  现在，让我们生成一个最新的人类可读日志文件：

    ```
    sealert -a /var/log/audit/audit.log

    ```

1.  在程序输出中，你将获得任何 SELinux 问题的详细描述，并且在每个所谓的警报末尾，你甚至会找到一个建议的解决方案来修复问题；在我们的示例中，感兴趣的警报应该读取（输出已截断），如下所示：

    ```
    SELinux is preventing /usr/sbin/httpd from open access on the file /var/www/html/test2.html.
    /var/www/html/test2.html default label should be httpd_sys_content_t

    ```

## 它是如何工作的...

在本食谱中，我们向您展示了如何轻松使用`sealert`程序解决 SELinux 问题。我们首先通过在 Web 根目录中创建一个新文件并为其分配错误的上下文类型值`user_tmp_t`来引发 SELinux 拒绝访问问题，该值在`httpd`策略中没有定义访问规则。然后，我们使用`curl`命令尝试获取网站，并在 SELinux 日志中实际产生**访问向量缓存**（**AVC**）拒绝消息。当 SELinux 拒绝访问时，会记录拒绝消息。所有 SELinux 日志信息的主要存储位置是审计日志文件，该文件位于`/var/log/audit/audit.log`，并且更容易阅读的拒绝消息也将写入`/var/log/messages`。在这里，我们不是手动搜索错误消息并合并两个日志文件，而是使用`sealert`工具，这是一个方便的程序，它将解析审计和消息日志文件，并以人类可读的格式呈现有价值的 AVC 内容。在每个警报消息的末尾，您还将找到一个针对问题的建议解决方案。请注意，这些是自动生成的消息，应在应用之前始终进行质疑。
