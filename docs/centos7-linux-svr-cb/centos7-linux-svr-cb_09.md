# 第九章：使用域

在本章中，我们将涵盖：

+   安装和配置仅缓存名称服务器

+   设置仅授权的名称服务器

+   创建集成名称服务器解决方案

+   填充域

+   构建一个辅助（从属）DNS 服务器

# 引言

本章是一系列尝试揭开网络世界中使一切正常工作的关键组件技术的神秘面纱的章节。从电子邮件到网页，从远程登录到在线聊天，本章提供了使用 CentOS 快速提供域名服务所需的详细信息，该服务将为您的办公环境提供动力。

# 安装和配置仅缓存名称服务器

计算机之间的每项网络通信只能通过使用唯一 IP 地址来识别通信的确切端点。对于人脑来说，数字总是比给*事物*命名更难记住和工作。因此，IT 先驱从 70 年代初开始发明将名称转换为物理网络地址的系统，使用文件和后来的简单数据库。在现代计算机网络和互联网上，计算机名称与 IP 地址之间的关系在**域名系统**（**DNS**）数据库中定义。它是一个全球分布式系统，提供域名到 IP 地址的解析，以及反向解析，即 IP 地址到域名的解析。DNS 是一个庞大的主题，本章的目的是通过向您展示如何安装和设置自己的仅缓存和转发名称服务器，为您提供完美的起点。我们将使用*Unbound*，这是一个高度安全且快速的递归和缓存 DNS 服务器解决方案，因此是我们的首选。但您需要记住，Unbound 不能用作完全授权的 DNS 服务器（这意味着它提供自己的域名解析记录），我们将在后面的章节中使用流行的 BIND 服务器。仅缓存 DNS 服务器将用于将所有名称解析查询转发到远程 DNS 服务器。这样的系统旨在通过缓存任何域名解析请求的结果来加快对互联网的总体访问。当缓存 DNS 服务器找到客户端查询的答案时，它将答案返回给客户端。但是，它还将答案存储在其缓存中一段时间。然后，缓存可以用作后续请求的来源，以加快总往返时间。

## 准备就绪

要完成此操作，您需要一个具有 root 权限、静态 IP 地址和您选择的基于控制台的文本编辑器的 CentOS 7 操作系统的工作安装。下载额外软件包时需要互联网连接。在本例中，我们的 DNS 服务器在具有网络地址`192.168.1.0/24`的私有网络中运行。

## 如何操作...

在本食谱中，我们将首先配置一个*仅缓存*的 DNS 服务器，然后是一个*仅转发*的 DNS 服务器。

### 配置仅缓存 Unbound DNS 服务器

在本节中，我们将考虑 Unbound 作为仅缓存名称服务器的角色，处理对其他远程 DNS 服务器的递归 DNS 请求，并在一定时间内缓存查询以提高响应时间，当服务器再次被请求相同名称解析时：

1.  首先，以 root 身份登录并键入以下内容安装所需软件包：

    ```
    yum install unbound bind-utils

    ```

1.  现在制作`unbound`配置文件的副本，以便我们以后可以恢复更改，然后使用您喜欢的文本编辑器打开它：

    ```
    cp /etc/unbound/unbound.conf /etc/unbound/unbound.conf.BAK
    vi /etc/unbound/unbound.conf

    ```

1.  向下滚动找到以下行：`# interface: 0.0.0.0`。删除`#`符号以取消注释它（激活它），使其读作如下：

    ```
    interface: 0.0.0.0
    ```

1.  接下来，向下滚动找到以下行：`# access-control: 127.0.0.0/8 allow`。取消注释该行以激活它，并根据需要更改网络地址：

    ```
    access-control: 192.168.1.0/24 allow
    ```

1.  保存并关闭文件，然后创建用于安全 DNSSEC 支持的 RSA 密钥对证书，之后再检查更改后的配置文件的正确性：

    ```
    unbound-control-setup && unbound-checkconf
    ```

1.  接下来，在服务器上的 firewalld 配置中打开 DNS 服务，因为我们希望能够在网络中的其他客户端上使用我们的新 DNS 服务进行查询：

    ```
    firewall-cmd --permanent --add-service dns &&  firewall-cmd --reload

    ```

1.  现在确保服务将在启动时可用，并在之后启动它：

    ```
    systemctl enable unbound && systemctl start unbound

    ```

1.  要测试我们是否可以到达我们的 Unbound DNS 服务器并进行查询，请从同一台服务器上执行以下命令，该服务器正在本地运行我们的 Unbound DNS 服务，这应该会返回[www.packtpub.com](http://www.packtpub.com)的 IP 地址：

    ```
    nslookup www.packtpub.com 127.0.0.1

    ```

1.  对于请求的更详细视图，您还可以在 DNS 服务器上本地运行：

    ```
    unbound-host -d www.packtpub.com

    ```

1.  从网络中的任何其他客户端（需要安装`bind-utils`），您也可以使用我们的新 DNS 服务器查询任何公共域名。例如，如果我们的 DNS 服务器的 IP 是`192.168.1.7`：

    ```
    nslookup www.packtpub.com 192.168.1.7

    ```

1.  最后，让我们在服务器本身上使用我们的新名称服务器。为此，在制作备份副本后，使用您喜欢的文本编辑器打开以下文件：

    ```
    cp /etc/resolv.conf /etc/resolv.conf.BAK; vi /etc/resolv.conf

    ```

1.  删除所有当前的名称服务器引用，并用以下内容替换它们：

    ```
    nameserver 127.0.0.1
    ```

    ### 注意

    如果您在网络脚本接口中设置了某些 DNS 服务器信息（例如，在配置静态 IP 地址时，请参阅第二章服务器的解析 IP 地址。在 DNS 服务器上，您还可以使用`unbound-host -d`命令来获得 Unbound 服务内部 DNS 查询的更技术性的视图。

在我们成功完成这些测试后，我们更新了 DNS 服务器上的当前名称服务器解析器信息，使用我们运行在本地主机上的新 DNS 服务。

## 还有更多...

现在我们想要看看 BIND 将如何执行缓存 DNS 信息。为此，在您的 DNS 服务器上，只需选择一个您之前未访问过的目标网站，并使用`dig`命令。例如：

```
dig www.wikipedia.org

```

运行此测试后，您可能会看到一个查询时间，结果如下：

```
;; Query time: 223 msec

```

现在重复这个练习，重新测试同一个 URL。根据您的网络环境，这可能会产生以下结果：

```
;; Query time: 0 msec

```

现在为另一个网站再次执行此操作。在每次重复前面的命令时，您不仅应该看到查询时间的减少，还应该体验到输出交付的更快响应时间。同样的结果将在浏览器刷新率中体现，因此我们可以这样说，这个简单的练习不仅向您介绍了 Unbound，而且最终将有助于提高您在浏览万维网时本地网络的速度。

# 设置一个仅授权的 DNS 服务器

在本节中，我们将学习如何创建一个*权威专用* DNS 服务器，它可以自己回答关于其控制下的域的查询，而不是将查询重定向到其他 DNS 服务器（例如我们之前的缓存专用 DNS 服务器）。我们将创建一个 DNS 服务器，以解析我们自己的私有本地网络中的所有我们自己的主机名和服务。

如前所述，虽然 Unbound 应该是您在需要缓存专用 DNS 服务器时的首选，因为它是目前最安全的 DNS 服务器解决方案，但它只有有限的权威功能，这通常对于专业 DNS 服务器使用来说是不够的。在这里，我们将使用流行的权威 BIND DNS 服务器包，而不是查询我们的本地服务器名称，并配置一个新的 DNS 区域以提供高度可定制的名称解析。从技术上讲，我们将为我们自己的域编写一个*正向*和*反向区域*文件。区域文件是包含实际域名到 IP 地址映射或相反的文本文件，即 IP 地址映射到域名映射。虽然对任何 DNS 服务器的大多数查询都是将名称翻译为 IP 地址，但反向部分也很重要，如果您需要为任何给定 IP 地址提供正确的域名，则需要设置。我们将配置 BIND 为权威专用，这意味着服务器只会回答它具有权威性的查询（在其区域中有匹配的记录），因此如果 DNS 服务器无法解析请求的域，它将停止请求，并且不会使用递归请求联系其他 DNS 服务器以获取并构建正确的答案。

## 准备工作

要完成此操作，您需要一个具有 root 权限的 CentOS 7 操作系统的工作安装，一个静态 IP 地址，以及您选择的基于控制台的文本编辑器。下载额外软件包时需要互联网连接。在本例中，我们的 DNS 服务器在私有网络中运行，网络地址为`192.168.1.0/24`。我们的 DNS 服务器应该管理我们决定作为`centos7.home`（形式为`domain.toplevel-domain`）的本地私有域。新 DNS 服务器的 IP 地址将是`192.168.1.7`，并且应该获得主机名`ns1`，从而得到完全限定域名（FQDN）`ns1.centos7.home`。（有关 FQDN 的更多信息，请参阅第二章             ; Minimum negative caching
    ```

1.  之后，添加文件的其余内容：

    ```
    ; add your name servers here for your domain
            IN      NS      ns1.centos7.home.
    ; add your mail server here for the domain  
            IN      MX      10   mailhost.centos7.home.
    ; now follows the actual domain name to IP 
    ; address mappings:

    ; first add all referenced hostnames from above
    ns1        IN      A       192.168.1.7
    mailhost   IN      A       192.168.1.8
    ; add all accessible domain to ip mappings here
    router     IN      A       192.168.1.0
    www        IN      A       192.168.1.9
    ftp        IN      A       192.168.1.10
    ; add all the private clients on the Lan here
    client1    IN      A       192.168.1.11
    client2    IN      A       192.168.1.12
    client3    IN      A       192.168.1.13
    ; finally we can define some aliases for 
    ; existing domain name mappings
    webserver  IN      CNAME   www
    johnny     IN      CNAME   client2
    ```

1.  当你完成操作后，请先保存并关闭文件，然后再为我们的私有子网络创建反向区域文件，该子网络用于我们的域名（`C-Class` 是指前三个数字（八位组），它们之间用点分隔：`XXX.XXX.XXX`。例如，对于 `192.168.1.0/24` 子网，`C-Class` 是 `192.168.1`：

    ```
    vi /var/named/db.<C-Class of our search IP in reverse order>

    ```

1.  在我们的示例中，一个解析我们 `centos7.home` 的 `192.168.1` C-Class 子网的反向区域文件将是：

    ```
    vi /var/named/db.1.168.192

    ```

1.  首先，像第 10 步一样输入完全相同的 SOA，然后将以下内容添加到文件的末尾：

    ```
    ;add your name servers for your domain
                 IN      NS      ns1.centos7.home.
    ; here add the actual IP octet to
    ; subdomain mappings:
    7      IN      PTR     ns1.centos7.home.
    8      IN      PTR     mailhost.centos7.home.
    9      IN      PTR     www.centos7.home.
    10     IN      PTR     ftp.centos7.home.
    11     IN      PTR     client1.centos7.home.
    12     IN      PTR     client2.centos7.home.
    13     IN      PTR     client3.centos7.home.
    ```

1.  保存并关闭文件，然后将我们的新区域对添加到命名配置中。为此，再次打开 `named.conf`：

    ```
    vi /etc/named.conf

    ```

1.  现在找到包含 `"/etc/named.rfc1912.zones"` 的行。紧接在这行之后，为你的工作留出空间，并添加适当的区域声明以启用你的*反向*区域，如下所示（将 `XXX.XXX.XXX` 替换为你的反向区域文件名的反向 C-Class，在我们的示例中是 `1.168.192`）：

    ```
    zone "XXX.XXX.XXX.in-addr.arpa." IN {
      type master;
      file "/var/named/db.XXX.XXX.XXX";
      update-policy local;
    };
    ```

1.  完成这一步后，你现在可以继续为你的正向区域添加一个区域声明，如下所示（将 `<domain>.<top-level domain>.db` 替换为你的正向区域文件名，在我们的示例中是 `centos7.home`）：

    ```
    zone "<domain>.<top-level domain>." IN {
      type master;
      file "/var/named/<domain>.<top-level domain>.db";
      update-policy local;
    };
    ```

1.  完成操作后，请保存并关闭文件，然后使用以下命令重启 `bind` 服务：

    ```
     named-checkconf && systemctl restart named
    ```

## 它是如何工作的...

所有 DNS 服务器都配置为执行缓存功能，但是缓存专用服务器仅限于从远程 DNS 服务器回答查询的能力，而权威名称服务器是维护特定记录的主区域的 DNS 服务器。

那么，我们从这次经历中学到了什么？

本教程的目的是设置一个仅权威的 BIND DNS 服务器，并为它提供一个新的区域。DNS 区域定义了单个域下的所有可用资源（主机名和服务）。任何 DNS 区域都应始终包含正向和反向区域文件。为了理解区域配置，我们首先需要讨论 DNS 层次结构。例如，取本教程中的一个 DNS 域名`client1.centos7.home`。我们私有网络中的每台计算机都有一个主机名（例如，`client1`或`www`），并且属于一个域。域由**二级域名**（**SLD**）（例如，`centos7`）和**顶级域名**（**TLD**）（例如，`home`、`org`、`com`等）组成。在 TLD 之上是根域（用`.`点表示），这在与其他程序或配置一起工作时经常被忽略。然而，在处理或定义 FQDN 的区域配置时，非常重要的一点是永远不要忘记在 TLD 后面添加这个点`.`。例如，我们`client1`计算机的 DNS 域名是`client1.centos7.home`，而`/etc/hosts`文件中的 FQDN 通常写成`client1.centos7.home`（从技术上讲这是不正确的，但大多数情况下是足够的）。根域非常重要，因为它包含了根 DNS 服务器，如果权威 DNS 服务器在其自己的记录（区域）或缓存中找不到请求域的现有条目，它将首先被查询。但是，我们在所有其他域层次结构中也有 DNS 服务器，这就是 DNS 服务器进行递归请求的方式。根 DNS 服务器，像任何其他 DNS 服务器一样，解析其区域文件中定义的所有子域，即 TLD。这些 TLD 本身可以解析所有 SLD（也在它们的区域文件中定义）。二级域解析其所有主机名（作为特殊子域，它们指的是网络上的单个计算机或服务）。因此，任何 DNS 请求都会通过不同的 DNS 服务器层次结构，从根 DNS 到 TLD DNS，再到 SLD DNS 服务器。根和 TLD DNS 服务器不能完全解析完整的域名 DNS 查询，如`www.centos7.home`，而是将解析下一个 DNS 层次结构的正确地址。这个系统确保根 DNS 总是能找到正确的 TLD DNS 服务器地址，TLD DNS 服务器总是将请求发送到正确的 SLD DNS，后者拥有正确的区域文件，并最终能够回答请求的 DNS 查询。

那么，我们从这次经历中学到了什么？

正如我们所学，区域文件是一个简单的文本文件，由指令和资源记录组成，由于包含大量两字母缩写，它可能看起来相当复杂。请记住，您需要在基础域级别（例如，`centos7.home`）为所有在该域下运行的主机名和服务（例如，`www`、`host1`、`api`等）设置一对区域文件（正向和反向）。安装`named` DNS 服务器（它是**伯克利互联网名称域**（**BIND**）软件包的一部分）后，我们复制了原始主配置文件，并将默认监听端口从 53 更改为 8053（因为 unbound 已经在端口 53 上监听），但仍仅监听 localhost，并禁用了 IPv6 以保持与其他主要 DNS 服务器的兼容性（因为 IPv6 支持在互联网上仍然有限）。此外，我们在这里禁用了递归，因为我们的 BIND DNS 服务器必须是权威的，这意味着当它无法从自己的区域记录中解析查询时，不允许将 DNS 请求转发到其他远程 DNS 服务器。

然后我们开始创建并自定义我们自己的正向 DNS 区域文件，文件名约定为`/var/named/<domain>.<top-level domain>.db`。该文件以`$TTL`控制语句打开，该语句代表**生存时间**，并向其他名称服务器提供一个时间值，该值决定了它们可以从该区域缓存记录的时间长度。与其他许多指令一样，此指令默认以秒为单位定义，但您也可以使用 BIND 特定的简写形式来表示分钟（`m`）、小时（`h`）、天（`d`）和周（`w`），正如我们在示例中所示（`3h`）。接下来，我们提供了一个**授权开始**（**SOA**）记录。该记录包含有关整个区域的具体信息。这从区域名称（`@`）开始，指定区域类（`IN`），该名称服务器的 FQDN 格式为`hostname.domain.TLD.`，以及区域管理员的电子邮件地址。后一个值通常采用`hostmaster.hostname.domain.TLD.`的形式，并通过将典型的`@`符号替换为点（`.`）来形成。完成此操作后，接下来就是打开括号以分配区域的序列号、刷新值、重试值、过期值和负缓存`生存时间`值。这些指令可以总结如下：

+   序列号（`serial-number`）值是一个数值，通常采用反向日期（`YYYYMMDD`）的形式，并附加一个值（`VV`），该值在每次修改或更新区域文件时递增，以指示该名称服务需要重新加载区域。值`VV`通常从`00`开始，下次修改此文件时，只需将其递增为`01`、`02`、`03`等。

+   `刷新时间`值决定了辅助或从属名称服务器将多频繁地询问主名称服务器区域是否发生了任何更改。

+   `重试时间`值决定了辅助或从属名称服务器在序列号失败后应多久检查一次主服务器。如果在`到期时间`值指定的时间范围内发生故障，辅助名称服务器将停止响应作为请求的权威。

+   `最小 TTL`值决定了其他名称服务器可以缓存否定响应的时间长度。

完成这一部分并关闭相应的括号后，我们接着添加了权威名称服务器信息（`NS`），使用`IN NS <名称服务器的 FQDN>`定义。通常情况下，您至少会有两个，如果不是三个名称服务器（将每个名称服务器的 FQDN 放在新的`IN NS`行中）。然而，如果您的服务器运行在办公室或家庭环境中，并且您希望享受本地名称解析的好处，例如`.home`、`.lan`或`.dev`，那么设置一个名称服务器就特别有用。接下来，我们需要为区域指定邮件服务器，因此需要包含**邮件交换器**（**MX**）记录的引用。格式为`IN MX <优先级> <您的邮件服务器的 FQDN>`。如果您定义了多个邮件服务器（每个在其单独的`IN MX`行中），优先级就变得重要了——数字越低，优先级越高。在这方面，辅助邮件服务器应该有一个更高的值。

### 注意

在`SOA`、`NS`和`MX`行中，我们已经引用了尚未定义为 IP 映射的主机名（`A`记录）。我们可以这样做，因为区域文件不是按顺序处理的。但不要忘记稍后为每个主机名创建相应的`A`行。

根据您的需求，您可能还想将您的名称服务器用作邮件服务器（那么您会写成`MX 10 ns1.centos7.home.`），尽管在示例中您可能有一个专门用于该角色的服务器。

接下来，需要创建适当的`A`记录（`A`代表地址）并将适当的 IP 地址分配给显示的值。这是任何域名解析请求到服务器的心脏。`A`记录用于将 FQDN 链接到 IP 地址，但大部分前面的设置将基于您的确切需求。在这里，您可以定义所有要在网络中映射的本地主机名。由于我们已经在区域文件中使用并引用了一些域名，例如名称服务器或邮件服务器，我们将从这些开始。之后，我们为所有公开可用和内部客户端定义了主机名到 IP 地址的映射。请记住，使用`A`记录时，您可以有多个相同的 IP 地址到不同主机名的映射。例如，如果您在网络中没有为每个服务配备专用服务器，而是有一台运行所有`DNS`、`邮件`、`Web`和`FTP`服务的服务器，您可以编写以下行：

```
ns1        IN A 192.168.1.7
mailhost   IN A 192.168.1.7
www        IN A 192.168.1.7
ftp        IN A 192.168.1.7
```

您还可以使用规范名称（`CNAME`）记录来完成此任务，它用于为现有的`A`记录分配别名。可以说，`CNAME`值通过指向`A`记录，使您的 DNS 数据更易于管理。因此，如果您考虑需要更改`A`记录的 IP 地址，所有指向该记录的`CNAME`记录都会自动更新。然而，正如本教程所尝试展示的，替代解决方案是拥有多个`A`记录，这意味着需要进行多次更新才能更改 IP 地址。

在本教程的这一阶段，我们将注意力转向了反向 DNS 区域。与正向区域文件一样，反向区域文件也有一个特殊的命名约定`/var/named/db.<C-Class of our search IP in reverse order>`。将反向区域文件命名为`db.1.168.192`可能一开始看起来很奇怪，但当你看到反向查找的工作原理时，它就有意义了。它从最高节点（在我们的例子中是`192`，对应于正向区域文件中的根域）开始，并从那里向下遍历。正如你所看到的，我们在这个文件中放置的内容在指令和在正向区域文件中使用的资源之间有一些相似之处。然而，重要的是要记住，反向 DNS 与正向 DNS 是完全独立和不同的。

反向 DNS 区域旨在帮助将 IP 地址转换为域名。这可以通过使用**指针资源记录**（**PTR**）来实现，该记录将唯一的 IP 地址分配给一个或多个主机名。因此，您必须确保每个`A`记录都有一个唯一的 PTR 记录。每个反向区域文件收集完整的 C 类地址范围（例如，前三个点分数字`192.168.1`）的 IP 到主机名转换。此类 IP 范围的最后一个八位字节是可以在该文件中定义的所有主机名。请记住，PTR 记录中第一列的 IP 地址值应该只显示这个最后一个八位字节。例如，在反向区域文件`db.1.168.192`中的行`9 IN PTR www.centos7.home.`将能够将任何反向 IP 地址请求`192.168.1.9`解析为域值`www.centos7.home`。

在本教程中，我们创建了正向和反向区域文件，然后通过将新区域添加到 BIND 服务器来完成 named 服务的配置，以便开始解析我们网络的本地域名。在这些新添加的正向和反向区域定义块中，我们定义了自己是主区域持有者，并指定了`update-policy local;`，因为如果我们想从本地主机使用`nsupdate`命令动态更新我们的区域，这是必需的（稍后会看到）。您可以添加无限数量的区域对，但请记住，每个正向或反向区域定义必须在大括号中给出单个区域条目。

总之，我们可以说正向和反向区域文件是基于单个基础域名定义的，一个基础域名对应一个正向区域文件。对于反向区域文件，情况略有不同，因为我们处理的是 IP 地址。我们根据域的网络地址的 C 类地址范围创建一个区域文件，这里的最后一个八位组称为主机名，我们在此特定文件中定义映射。

BIND 是一个庞大的主题，还有很多需要学习，本食谱仅作为介绍。在大多数情况下，你甚至可能会发现你的初始学习阶段将成为一个试错过程，但这将得到改善。记住，熟能生巧，如果你创建了额外的正向区域，请始终在反向区域文件中引用它们。

## 还有更多...

在为 BIND 服务器创建并添加了区域后，你现在可以测试配置了。为此，你可以使用`host`、`dig`或`nslookup`命令仅从 localhost 解析内部主机名。例如，为了测试正向 DNS 解析，我们可以使用`dig`命令，指定我们的 DNS 服务器在 localhost 上运行，端口为`8053`：`dig -p 8053 @127.0.0.1 client2.centos7.home`。这应该能成功完成 DNS 查找并返回以下行（输出已截断）：

```
;; ANSWER SECTION:
client2.centos7.home.  10800  IN  A  192.168.1.12

```

对于反向查找，你将使用 IP 地址（在本例中，使用的 IP 地址应对应于你已配置反向 DNS 的域）：`nslookup -port=8053 192.168.1.12 127.0.0.1`。由于我们已经将 BIND 配置为仅权威 DNS 服务器，因此任何超出我们区域本地记录的 DNS 请求都无法完全解析。为了测试这一点，使用`dig -p 8053 @127.0.0.1 www.google.com`，它应该返回状态`REFUSED`和`WARNING: recursion requested but not available`消息。

出于安全考虑，我们仅将 BIND 服务器限制为 localhost，不允许它连接到其他 DNS 服务器。因此，你不能将其作为私有网络的唯一 DNS 解决方案。相反，在下一个配方中，我们将学习如何结合 Unbound 和 BIND 来创建一个集成且非常安全的全能 DNS 服务器解决方案。但如果你不想这样做，并且想将 BIND 作为你的单一且完整的权威 DNS 服务器解决方案（这在 CentOS 7 上不再推荐），你可以通过禁用或卸载 Unbound，恢复原始的`named.conf.BAK`配置文件，并在 BIND 配置文件中启用以下指令来实现：`allow-query {localhost;192.168.1.0/24;}`;（允许整个`192.168.1.0/24`网络进行 DNS 请求），`listen-on port 53 {any;}`;（在任何网络上监听请求），`listen-on-v6 port 8053 { none; }`;（禁用 IPv6）。如果你想让 BIND 转发所有它不权威的内容，而不是使用递归来找出答案，也可以添加以下指令（在这个例子中，我们使用官方的 Google DNS 服务器进行任何转发请求，但你可以根据需要进行更改）：`forwarders { 8.8.8.8;};forward only;`。然后重启`bind`服务。

# 创建一个集成的名称服务器解决方案

到目前为止，在本章中，我们使用 Unbound 作为仅缓存的 DNS 服务器解决方案，因为它非常安全和快速，而使用 BIND 作为我们的仅权威 DNS 服务器，因为它的区域管理高度可配置和可定制。BIND 已经存在很长时间，是有史以来使用最广泛的 DNS 软件。然而，过去发现了一些严重的漏洞（幸运的是已经修复）。在本配方中，我们将结合 Unbound 和 BIND，以获得两全其美的效果：只有非常安全的 Unbound 服务将直接暴露给你的私有网络，并可以从你的客户端接收和提供 DNS 查询。BIND 服务仅绑定到 localhost，正如在前一个配方中配置的那样，只允许解析内部主机名，并且没有直接访问互联网或你的客户端的权限。如果客户端连接到你的 Unbound 服务并请求解析私有网络中的内部主机名，Unbound 将在本地查询 BIND 服务器以进行 DNS 解析并将响应缓存。另一方面，如果客户端请求解析外部域名，Unbound 本身将递归查询或转发其他远程 DNS 服务器并将响应缓存。这两种 DNS 服务器系统的集成使其成为完美的全能 DNS 服务器解决方案。

## 准备就绪

要完成这个配方，你需要一个正常运行的 CentOS 7 操作系统和一个你选择的基于控制台的文本编辑器。预计在本章中找到的配方指导下，一个仅缓存的 Unbound 服务器（端口 53）和一个仅权威的 BIND 服务器（端口 8053）已经安装并正在运行。

## 操作方法...

在本教程中，我们将向您展示如何配置 Unbound，以便当客户端请求内部主机名时，它能够查询我们本地运行的权威性仅限的 BIND 服务。对于其他任何请求，应将其作为递归 DNS 请求发送到远程根服务器以构建答案：

1.  以 root 用户身份登录运行 Unbound 和 BIND 服务的我们的服务器，并打开 Unbound 的主配置文件：

    ```
    vi /etc/unbound/unbound.conf

    ```

1.  首先在`server:`子句中的某个位置添加以下行：

    ```
    local-zone: "168.192.in-addr.arpa." nodefault

    ```

1.  接下来，我们需要允许 Unbound 连接到默认禁用的 localhost，查找读取以下内容的行：`# do-not-query-localhost: yes`，然后激活并将其设置为 no：

    ```
    do-not-query-localhost: no

    ```

1.  接下来，由于我们的 BIND 服务器未使用 DNSSEC 配置，因此我们需要告诉 Unbound 无论如何都要使用它（默认情况下，Unbound 拒绝连接到未使用 DNSSEC 的 DNS 服务器）。查找以`# domain-insecure: "example.com"`开头的行，然后激活它并将其更改为以下内容：

    ```
    domain-insecure: "centos7.home."
    domain-insecure: "168.192.in-addr.arpa."

    ```

1.  接下来，我们需要告诉 Unbound 将我们内部域`centos7.home.`的所有请求转发到本地运行的 BIND 服务器（端口`8053`）。在文件末尾添加以下内容：

    ```
    stub-zone:
     name: "centos7.home."
     stub-addr: 127.0.0.1@8053

    ```

1.  此外，我们还需要告诉 Unbound 对我们的内部域使用 BIND 进行任何反向查找时执行相同的操作：

    ```
    stub-zone:
     name: "1.168.192.in-addr.arpa."
     stub-addr: 127.0.0.1@8053

    ```

1.  保存并关闭文件，然后重新启动 Unbound 服务：

    ```
    unbound-checkconf && systemctl restart unbound

    ```

## 工作原理

恭喜！您现在拥有一个完整的权威且非常安全的 DNS 服务器解决方案，采用集成方法结合了 Unbound 和 BIND 的所有优点。在本教程中，我们向您展示了如何使用存根区域配置 Unbound 服务，以便连接到内部运行的 BIND 服务以处理正向和反向请求。`存根区域`是 Unbound 的一个特殊功能，用于配置无法通过公共互联网服务器访问的权威数据。其`名称`字段定义了 Unbound 将转发任何传入 DNS 请求的区域名称，而`存根地址`字段配置了访问 DNS 服务器的位置（IP 地址和端口）；在我们的示例中，这是本地运行的 BIND 服务器，端口为`8053`。为了让 Unbound 能够连接到 localhost，我们首先必须使用`do-not-query-localhost: no`指令允许这样做，必须将我们的正向和反向域标记为`不安全`，还必须定义一个新的`本地区域`，这是必要的，以便 Unbound 知道客户端可以向`存根区域`权威服务器发送查询。

## 还有更多...

为了测试我们的新 Unbound/BIND DNS 集群，请从同一网络中的另一台计算机向 Unbound 服务发出一个公共和一个内部主机名的 DNS 请求（您也可以在 DNS 服务器本身上运行类似的测试）。如果我们的 Unbound/BIND DNS 集群的 IP 为`192.168.1.7`，则应能够从网络中的任何其他计算机获得`dig @192.168.1.7 www.packtpub.com`和`dig @192.168.1.7 client1.centos7.home`的正确答案。

如果您需要解决服务问题或需要监控新安装的 Unbound/BIND DNS 服务器的 DNS 查询，您可以配置日志记录参数。对于 BIND，在主配置文件`named.conf`中，您可以设置日志输出的详细程度（或日志级别）。这个参数称为`severity`，可以在`logging`指令中找到。它已经设置为`dynamic`，这意味着可以输出尽可能多的日志消息。然后，您可以使用`tail -f /var/named/data/named.run`来读取当前日志。对于 Unbound，您可以在其主配置文件`unbound.conf`中使用`verbosity`指令设置详细程度级别，该级别默认为最低的`1`，但可以增加到`5`。要了解更多关于不同级别的信息，请使用`man unbound.conf`。使用`journald`读取 Unbound 日志信息，使用命令`journalctl -f -u unbound.service`（按下*Ctrl*+*c*键退出命令）。

我们不仅可以记录系统和服务的日志信息，还可以启用查询日志。对于 Unbound，只需使用`verbosity`为`3`或以上来记录查询信息。对于 BIND，为了激活查询日志（查询输出将发送到日志文件`named.run`），使用命令`rndc querylog on`（要关闭它，使用`rndc querylog off`）。请记住，在配置生产系统上的 DNS 服务器时，应关闭任何过多的日志信息，例如查询日志，因为它可能会降低您的服务性能。您还可以安装其他第三方工具，如`dnstop`（来自`EPEL`存储库）来监控您的 DNS 活动。

# 填充域

在本教程中，我们将向您展示如何快速向权威的 BIND 服务器添加新的本地域记录条目，这些条目目前对您的名称服务器来说是未知的。

## 准备工作

要完成本教程，您需要一个正常运行的 CentOS 7 操作系统和一个基于控制台的文本编辑器。预计 Unbound 和 BIND 都已经安装并正在运行，并且您已经阅读并应用了本章中的区域教程，并为您的私有网络的主机名解析准备了所需的正向和反向区域文件。

## 如何操作...

如果您想向 DNS 服务器添加新的域名到 IP 地址映射，例如为本地网络中的新主机或未知主机，您有两种选择。由于我们已经为本地网络创建了区域文件，因此我们可以简单地为每个新子域在我们的基本域名中添加新的`A`（和/或`CNAME`）以及相应的`PTR`条目到我们的正向和反向区域文件配置中，使用我们选择的文本编辑器。或者，我们可以使用`nsupdate`命令行工具以交互方式添加这些记录，而无需重新启动 DNS 服务器。在本节中，我们将向您展示如何准备和使用`nsupdate`工具。在我们的示例中，我们将为 IP 地址为`192.168.1.14`的计算机添加一个新的子域`client4.centos7.home`到我们的 DNS 服务器的区域：

1.  以 root 身份登录运行 BIND 服务的服务器。现在首先我们需要激活`named`，以便允许其通过 SELinux 写入区域文件：

    ```
    setsebool -P named_write_master_zones 1

    ```

1.  接下来，我们需要解决一些与命名配置目录的权限问题，否则`nsupdate`无法稍后更新我们的区域文件：

    ```
    chown :named /var/named -R; chmod 775 /var/named -R

    ```

1.  由于我们的 BIND 服务器运行在端口`8053`上，请键入以下命令以在本地启动交互式`nsupdate`会话：

    ```
    nsupdate -p 8053 -d -l

    ```

1.  在提示符(`>`)下，首先通过键入以下内容连接到本地 DNS 服务器（按*Return*键完成命令）：

    ```
     local 127.0.0.1

    ```

1.  要向 DNS 服务器添加新的正向域名到 IP 映射，请键入以下内容：

    ```
    update add client4.centos7.home. 115200 A 192.168.1.14
    send

    ```

1.  现在使用以下命令添加反向关系：

    ```
    update add 14.1.168.192.in-addr.arpa. 115200 PTR client4.centos7.home.
    send

    ```

    如果更新命令的输出包含消息`NOERROR`，请按*Ctrl*+*c*键退出交互式`nsupdate`会话。

1.  最后，检查新区域条目的域名和 IP 解析是否正常工作（这也应该通过 Unbound 服务器远程工作）：

    ```
    dig -p 8053 @127.0.0.1  client4.centos7.home.
    nslookup -port=8053 192.168.1.14 127.0.0.1

    ```

## 它是如何工作的…

在这个相当简单的教程中，我们向您展示了如何使用`nsupdate`工具在运行时动态添加新的域名解析记录，而无需重新启动您的 BIND DNS 服务器。

那么，我们从这次经历中学到了什么？

在本教程中，我们向您介绍了`nsupdate`命令行工具，该工具可以在不编辑区域文件或重新启动服务器的情况下对正在运行的 BIND DNS 数据库进行更改。如果您已经在 DNS 服务器上配置了区域文件，那么这是对 DNS 服务器进行更改的首选方式。它有几个选项，例如，您可以连接到远程 DNS 服务器，但由于简单性和安全原因，我们将仅使用和允许最简单的形式，并且仅将`nsupdate`连接到我们的本地 BIND 服务器（要使用`nsupdate`远程连接到 BIND 服务器，您需要进行更多配置，例如生成安全密钥对，打开防火墙等）。

在允许`named`写入其自己的区域文件（否则会被 SELinux 禁止）并修复默认 named 配置目录的一些权限问题后，我们使用`-l`（本地连接）和`-p 8053`（连接到 BIND DNS 服务器端口`8053`）启动了`nsupdate`程序。`-d`为我们提供了调试输出，这对于解决问题非常有用。然后，我们被一个交互式 shell 提示，在那里我们可以运行 BIND 特定的`update`命令。首先，我们设置`local` `127.0.0.1`，这连接到我们的本地服务器，然后我们使用`update add`命令向正在运行的 DNS 服务器添加一个新的正向`A`记录。语法类似于在区域文件中定义记录。在这里，我们使用以下行添加一个新的`A`记录，TTL 为三天（115200 秒），域名为`client4.centos7.home`，解析到 IP 地址`192.168.1.14`。下一行用于为我们的新域配置一些反向解析规则，并将域名作为`PTR`条目添加到我们的反向区域中。在这里，需要注意的是，您需要以下列方式定义反向`update add`规则的域部分：`<规则的主机名>.<反向 C 类>.in-addr.arpa`。为了最终执行我们的命令并将它们永久保存在 DNS 服务器的数据库中，而不需要重新启动服务器，我们使用`send`命令分别对反向和正向命令，因为它们针对不同的区域。最后，我们测试了新添加到 DNS 服务器的区域文件中的条目是否正常工作，通过查询 BIND 服务器。

# 构建辅助（从属）DNS 服务器

为了确保网络的高可用性，在您的环境中运行多个 DNS 服务器以应对任何服务器故障是有益的。如果您运行的是公共 DNS 服务器，这一点尤其重要，因为持续访问服务至关重要，而且同时拥有五个或更多 DNS 服务器并不罕见。由于配置和管理多个 DNS 服务器可能耗时，BIND DNS 服务器使用节点之间传输区域文件的功能，以便每个 DNS 服务器都具有相同的域解析和配置信息。为了实现这一点，我们需要定义一个主 DNS 服务器和一个或多个辅助或从属 DNS 服务器。然后，我们只需要在主服务器上调整一次区域文件，它就会将当前版本传输到我们所有的辅助服务器，保持一切一致和最新。对于客户端来说，连接到哪个 DNS 服务器将没有区别。

## 准备就绪

要完成此配方，您将至少需要两个在同一网络中可以相互看到和 ping 通的 CentOS 7 服务器。需要互联网连接以下载并在我们想要包含在我们的 DNS 服务器*农场*中的所有计算机上安装 BIND 服务器软件。在本示例中，我们有两个服务器，`192.168.1.7`，它已经安装并配置为 BIND 服务器，以及`192.168.1.15`，它将是子网`192.168.1.0/24`内的第二个 BIND 服务器。您还应该阅读并应用本章中的区域文件配方，并创建正向和反向区域文件，因为这是我们想要在 DNS 服务器之间传输的内容。

## 如何操作...

我们通过在想要包含在我们的 BIND DNS 服务器集群中的每个 CentOS 7 计算机上安装 BIND 来开始这个配方。为此，请遵循配方*设置权威 DNS 服务器*为所有剩余系统。在我们开始之前，我们需要定义哪个服务器将是我们的主 DNS 服务器。为了简化我们的示例，我们将选择 IP 地址为`192.168.1.7`的服务器。现在让我们让我们的 DNS 服务器节点了解它们的角色。

### 对主 DNS 服务器进行的更改

1.  让我们以 root 身份登录到主服务器并打开其主配置：

    ```
    vi /etc/named.conf

    ```

1.  现在我们定义哪些辅助 DNS 服务器将被允许接收区域文件，在新的一行中，在选项花括号之间写下以下命令（我们只有一个辅助 DNS 服务器，其 IP 地址为`192.168.1.15`，请根据需要更改）：

    ```
    allow-transfer { 192.168.1.15; };
    notify yes;
    ```

1.  此外，我们还必须允许其他名称服务器连接到我们的主名称服务器。为此，您需要将`listen-on`指令更改为包括 DNS 服务器的主网络接口（在我们的示例中为`192.168.1.7`，因此请相应更改）：

    ```
    listen-on port 8053 { 127.0.0.1;192.168.1.7; };

    ```

1.  保存并关闭文件。现在在您的服务器防火墙中打开新端口`8053`（或者为其创建一个 firewalld 服务，参见第六章，*提供安全性*）：

    ```
    firewall-cmd --permanent --zone=public --add-port=8053/tcp --add-port=8053/udp;firewall-cmd --reload

    ```

1.  保存并关闭文件。接下来，更新我们之前创建的区域文件，以包括系统中所有新名称服务器的 IP 地址。更改正向和反向区域文件，`/var/named/centos7.home.db`和`/var/named/db.1.168.192`，以包括我们的新辅助 DNS 服务器。在正向区域文件中，添加以下行（您也可以使用`nsupdate`程序来执行此操作）到适当的节中：

    ```
    NS  ns2.centos7.home.
    ns2  A   192.168.1.15

    ```

1.  在反向区域文件中，添加到适当的节中：

    ```
    NS  ns2.centos7.home.
    15 PTR ns2.centos7.home.

    ```

1.  最后，重启 BIND 并重新检查配置文件：

    ```
    named-checkconf && systemctl restart named

    ```

### 对辅助 DNS 服务器进行的更改

为了简化和演示，只需在您想要用作 BIND 从属服务器的任何服务器上安装`named`（我们只在这里展示重要的配置）：

1.  以 root 身份登录到新服务器，安装 BIND，并打开其主配置：

    ```
    yum install bind; vi /etc/named.conf

    ```

1.  现在找到行`include /etc/named.rfc1912.zones`。紧跟在这行之后，为你的工作创建空间，并添加以下区域（适当地替换区域和文件名）：

    ```
     zone "centos7.home" IN {
     type slave;
     masters port 8053 { 192.168.1.7; };
     file "/var/named/centos7.home.db";
    };
     zone "1.168.192.in-addr.arpa" IN {
     type slave;
     masters port 8053{ 192.168.1.7; };
     file "/var/named/db.1.168.192.db";
     };

    ```

1.  保存并关闭文件。然后修复一些不正确的 BIND 文件夹权限，并启用`named`写入其区域文件目录，然后重新启动 BIND：

    ```
    chown :named /var/named -R; chmod 775 /var/named -R
    setsebool -P named_write_master_zones 1
    named-checkconf && systemctl restart named

    ```

1.  现在使用以下命令启动新的区域传输：

    ```
    rndc refresh centos7.home.

    ```

1.  等待一段时间后，为了测试辅助 DNS 服务器是否按预期工作，检查主区域文件是否已被传输：

    ```
    ls /var/named/*.db

    ```

1.  最后，我们现在可以测试我们是否也可以在辅助 DNS 服务器上查询我们的本地域：

    ```
    dig @127.0.0.1 client2.centos7.home.

    ```

## 它是如何工作的...

在本配方中，我们向您展示了如何在您的网络中设置辅助 BIND 服务器，这有助于提高您的 DNS 服务器系统的稳定性和可用性。

那么我们从这次经历中学到了什么？

我们首先决定哪些服务器应作为主 DNS 服务器，哪些应作为从 DNS 服务器。然后在主服务器上打开 BIND 主配置文件，并引入两行代码，将我们的服务器配置为 DNS 集群的头部。`allow-transfer`指令定义了我们希望向哪些客户端传输更新的区域文件，而`notify yes`指令启用了当区域文件发生任何更改时的自动传输。如果你有多个辅助 BIND DNS 服务器，可以在`allow-transfer`指令中添加多个 IP 地址，用分号隔开。然后，我们打开在本章前一个配方中创建的区域文件，并引入新的一行`IN NS <IP 地址>`，这定义了我们需要的辅助 DNS 服务器的 IP 地址，以便在我们的系统中的每个 DNS 节点上都能意识到。如果我们有多个服务器，那么我们就引入多个`IN NS`行。最后，我们引入了一个小注释，以便在辅助服务器上轻松检查区域文件传输是否成功。

之后，我们配置了我们的从 DNS 服务器。在这里，我们引入了与主服务器上的 BIND 配置相同的区域文件定义，不同的是我们使用了类型`slave`而不是 master 来表示我们是辅助 DNS 服务器，并且将从主节点获取区域文件的副本，通过使用`masters`指令定义主 DNS 服务器的 IP 地址（请不要忘记，在我们的例子中，我们的主 BIND 监听在非默认端口`8053`上）。

由于我们没有在从 DNS 服务器上自己创建或复制区域文件，因此在重新启动 BIND 服务后，使用`ls`命令很容易检查区域文件传输是否成功。最后，我们通过运行测试查询使用`dig`或`nslookup`来验证传输的区域文件内容，看看我们是否可以在辅助 DNS 服务器上解析相同的本地主机名。记住，如果你后来对你的主区域文件进行了更改，你必须增加它们的`serial`号，以便这些更改被传输到你所有的从服务器。
